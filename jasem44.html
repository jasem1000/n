import tkinter as tk
from tkinter import ttk, messagebox, filedialog, simpledialog
import sqlite3
import datetime
import io
import os
import json
import time
# --- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„ØµÙˆØ± ---
from PIL import Image, ImageTk, ImageDraw, ImageFont, ImageWin
import win32print
import win32ui
import win32con
# --- Ù…ÙƒØªØ¨Ø§Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ---
try:
    import arabic_reshaper
    from bidi.algorithm import get_display
except ImportError:
    print("ÙŠØ±Ø¬Ù‰ ØªØ«Ø¨ÙŠØª Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©: pip install arabic-reshaper python-bidi")
    def get_display(text): return text
    class arabic_reshaper:
        @staticmethod
        def reshape(text): return text
# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„ØªØµÙ…ÙŠÙ… ---
BG_MAIN_COLOR = "#F4F7F6"
PANEL_COLOR = "#3F6287"
PRIMARY_COLOR = "#007AFF"
SECONDARY_COLOR = "#00AEFF"
ACCENT_COLOR = "#0DAAFF"
SUCCESS_COLOR = "#28a745"
DANGER_COLOR = "#dc3545"
TEXT_COLOR = "#0099FF"
TEXT_SECONDARY = "#6c757d"
CARD_COLORS = {
    "Ø£Ø¨ÙŠØ¶ (Ø§ÙØªØ±Ø§Ø¶ÙŠ)": "#FFFFFF",
    "Ø£Ø­Ù…Ø± ÙØ§ØªØ­": "#FFEBEE",
    "Ø£Ø®Ø¶Ø± ÙØ§ØªØ­": "#E8F5E9",
    "Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­": "#E3F2FD",
    "Ø£ØµÙØ± ÙØ§ØªØ­": "#FFFDE7",
    "Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ ÙØ§ØªØ­": "#FFF3E0",
    "Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­": "#F5F5F5"
}
FONT_MAIN = ("Segoe UI", 12)
FONT_BOLD = ("Segoe UI", 12, "bold")
FONT_HEADER = ("Segoe UI", 20, "bold")
FONT_TITLE = ("Segoe UI", 14, "bold")

class CustomInputDialog:
    """Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ù…Ø¹ Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­ (Ø¹Ø±Ø¨ÙŠØ© Ø£Ùˆ Ø±Ù‚Ù…ÙŠØ©)"""
    def __init__(self, parent, title, prompt, initial_value="", input_type="text"):
        self.result = None
        self.window = tk.Toplevel(parent)
        self.window.title(title)
        self.window.geometry("600x450")
        self.window.configure(bg="#FFFFFF")
        self.window.resizable(False, False)
        self.window.transient(parent)
        self.window.grab_set()
        
        x = parent.winfo_rootx() + (parent.winfo_width() // 2) - 300
        y = parent.winfo_rooty() + (parent.winfo_height() // 2) - 225
        self.window.geometry(f"+{x}+{y}")
        
        main_frame = tk.Frame(self.window, bg=PANEL_COLOR, padx=20, pady=20, relief='raised', bd=1)
        main_frame.pack(expand=True, fill='both', padx=10, pady=10)
        
        tk.Label(main_frame, text=prompt, font=FONT_BOLD, bg=PANEL_COLOR, fg="white").pack(pady=(0, 10))
        
        self.input_var = tk.StringVar(value=initial_value)
        self.entry = tk.Entry(main_frame, textvariable=self.input_var, font=("Segoe UI", 16), bg="#F9F9F9", justify='center')
        self.entry.pack(fill='x', pady=5, ipady=10)
        self.entry.focus_set()
        
        # Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        keypad_frame = tk.Frame(main_frame, bg=PANEL_COLOR)
        keypad_frame.pack(fill='both', expand=True, pady=10)

        if input_type == "arabic":
            self.build_arabic_keypad(keypad_frame)
        elif input_type == "numeric":
            self.build_numeric_keypad(keypad_frame)
        
        btn_frame = tk.Frame(main_frame, bg=PANEL_COLOR)
        btn_frame.pack(fill='x', pady=10)
        
        tk.Button(btn_frame, text="Ø¥Ù„ØºØ§Ø¡ âŒ", command=self.window.destroy, bg=DANGER_COLOR, fg="white", font=FONT_BOLD, relief='flat', width=10).pack(side='left', padx=5)
        tk.Button(btn_frame, text="ØªØ£ÙƒÙŠØ¯ âœ…", command=self.confirm, bg=SUCCESS_COLOR, fg="white", font=FONT_BOLD, relief='flat', width=15).pack(side='right', padx=5)
        
        self.window.wait_window()
        
    def build_arabic_keypad(self, parent):
        keys = [
            ('Ø¶', 'Øµ', 'Ø«', 'Ù‚', 'Ù', 'Øº', 'Ø¹', 'Ù‡', 'Ø®', 'Ø­', 'Ø¬', 'Ø¯'),
            ('Ø´', 'Ø³', 'ÙŠ', 'Ø¨', 'Ù„', 'Ø£', 'Øª', 'Ù†', 'Ù…', 'Ùƒ', 'Ø·'),
            ('Ø°', 'Ø¡', 'Ø¤', 'Ø±', 'Ù„Ø§', 'Ù‰', 'Ø©', 'Ùˆ', 'Ø²', 'Ø¸'),
            (' ', 'Back', 'Clear') # Ù…Ø³Ø§ÙØ© ÙˆØ­Ø°Ù ÙˆÙ…Ø³Ø­
        ]
        
        for r, row_keys in enumerate(keys):
            row_frame = tk.Frame(parent, bg=PANEL_COLOR)
            row_frame.pack(fill='x', expand=True)
            for key in row_keys:
                cmd = lambda k=key: self.key_press(k)
                btn_color = "#E3F2FD" if len(key) == 1 or key == 'Ù„Ø§' else PRIMARY_COLOR if key != 'Clear' else DANGER_COLOR
                fg_color = "#1565C0" if len(key) == 1 or key == 'Ù„Ø§' else "white"
                font = ("Segoe UI", 12) if len(key) == 1 or key == 'Ù„Ø§' else FONT_BOLD

                btn = tk.Button(row_frame, text=get_display(arabic_reshaper.reshape(key)), command=cmd,
                                font=font, bg=btn_color, fg=fg_color, relief='flat', padx=5, pady=5)
                btn.pack(side='right', padx=2, pady=2, fill='x', expand=True)
                
    def build_numeric_keypad(self, parent):
        keys = [
            ('1', '2', '3'),
            ('4', '5', '6'),
            ('7', '8', '9'),
            ('Clear', '0', 'Back')
        ]
        for r, row_keys in enumerate(keys):
            row_frame = tk.Frame(parent, bg=PANEL_COLOR)
            row_frame.pack(fill='x', expand=True)
            for key in row_keys:
                cmd = lambda k=key: self.key_press(k)
                btn_color = DANGER_COLOR if key == 'Clear' else PRIMARY_COLOR if key != 'Back' else "#E67E22"
                btn = tk.Button(row_frame, text=key, command=cmd,
                                font=("Segoe UI", 18, "bold"), bg=btn_color, fg="white", relief='flat', padx=5, pady=5)
                btn.pack(side='right', padx=2, pady=2, fill='x', expand=True)

    def key_press(self, key):
        current = self.input_var.get()
        if key == 'Clear':
            self.input_var.set("")
        elif key == 'Back':
            self.input_var.set(current[:-1])
        else:
            self.input_var.set(current + key)
        self.entry.icursor(tk.END)
        
    def confirm(self):
        self.result = self.input_var.get()
        self.window.destroy()

class NoteDialog:
    """Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø¹ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª (Ø¨Ø§Ù‚ÙŠ ÙƒÙ…Ø§ Ù‡ÙŠ)"""
    def __init__(self, parent, title, prompt, initial_value="", suggestions_str=""):
        self.result = None
        self.window = tk.Toplevel(parent)
        self.window.title(title)
        self.window.geometry("500x350")
        self.window.configure(bg="#FFFFFF")
        self.window.resizable(False, False)
        self.window.transient(parent)
        self.window.grab_set()
        
        x = parent.winfo_rootx() + (parent.winfo_width() // 2) - 250
        y = parent.winfo_rooty() + (parent.winfo_height() // 2) - 175
        self.window.geometry(f"+{x}+{y}")
        
        main_frame = tk.Frame(self.window, bg=PANEL_COLOR, padx=20, pady=20, relief='raised', bd=1)
        main_frame.pack(expand=True, fill='both', padx=10, pady=10)
        
        tk.Label(main_frame, text=prompt, font=FONT_BOLD, bg=PANEL_COLOR, fg="white").pack(pady=(0, 10))
        
        self.note_var = tk.StringVar(value=initial_value)
        self.entry = tk.Entry(main_frame, textvariable=self.note_var, font=("Segoe UI", 14), bg="#F9F9F9", justify='center')
        self.entry.pack(fill='x', pady=5, ipady=5)
        self.entry.focus_set()
        self.entry.bind('<Return>', lambda e: self.confirm())
        
        if suggestions_str:
            suggestions_frame = tk.LabelFrame(main_frame, text="Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø³Ø±ÙŠØ¹Ø©", bg=PANEL_COLOR, fg="white", font=("Segoe UI", 10))
            suggestions_frame.pack(fill='x', pady=10)
            
            sug_list = [s.strip() for s in suggestions_str.split(',') if s.strip()]
            
            grid_frame = tk.Frame(suggestions_frame, bg=PANEL_COLOR)
            grid_frame.pack(fill='both', padx=5, pady=5)
            
            r, c = 0, 0
            for sug in sug_list:
                btn = tk.Button(grid_frame, text=sug, font=("Segoe UI", 9),
                                bg="#E3F2FD", fg="#1565C0", relief='flat',
                                command=lambda s=sug: self.add_suggestion(s))
                btn.grid(row=r, column=c, padx=2, pady=2, sticky='ew')
                c += 1
                if c > 2:
                    c = 0
                    r += 1
            for i in range(3): grid_frame.columnconfigure(i, weight=1)
            
        btn_frame = tk.Frame(main_frame, bg=PANEL_COLOR)
        btn_frame.pack(fill='x', pady=20)
        
        tk.Button(btn_frame, text="Ø¥Ù„ØºØ§Ø¡ âŒ", command=self.window.destroy, bg=DANGER_COLOR, fg="white", font=FONT_BOLD, relief='flat', width=10).pack(side='left', padx=5)
        tk.Button(btn_frame, text="Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© âœ…", command=self.confirm, bg=SUCCESS_COLOR, fg="white", font=FONT_BOLD, relief='flat', width=15).pack(side='right', padx=5)
        
        self.window.wait_window()
        
    def add_suggestion(self, text):
        current = self.note_var.get()
        if current:
            self.note_var.set(current + "ØŒ " + text)
        else:
            self.note_var.set(text)
        self.entry.focus_set()
        self.entry.icursor(tk.END)
        
    def confirm(self):
        self.result = self.note_var.get()
        self.window.destroy()

class PhoneKeypad:
    """Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø¨Ø§Ù‚ÙŠ ÙƒÙ…Ø§ Ù‡ÙŠ)"""
    def __init__(self, parent, callback, initial_value=""):
        self.parent = parent
        self.callback = callback
        self.value = tk.StringVar(value=initial_value)
        self.setup_ui()
        
    def setup_ui(self):
        self.window = tk.Toplevel(self.parent)
        self.window.title("Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ")
        self.window.geometry("350x500")
        self.window.configure(bg="#2C3E50")
        self.window.transient(self.parent)
        self.window.grab_set()
        
        x = self.parent.winfo_rootx() + (self.parent.winfo_width() // 2) - 175
        y = self.parent.winfo_rooty() + (self.parent.winfo_height() // 2) - 250
        self.window.geometry(f"+{x}+{y}")
        
        main_frame = tk.Frame(self.window, bg="#2C3E50", padx=10, pady=10)
        main_frame.pack(fill='both', expand=True)
        
        display_frame = tk.Frame(main_frame, bg="#ECF0F1", pady=10, padx=10, relief='sunken', bd=2)
        display_frame.pack(fill='x', pady=(0, 15))
        
        self.display = tk.Label(display_frame, textvariable=self.value,
                               font=("Consolas", 28, "bold"), bg="#ECF0F1",
                               fg="#2C3E50", height=1, anchor='center')
        self.display.pack(fill='x')
        
        keypad_frame = tk.Frame(main_frame, bg="#2C3E50")
        keypad_frame.pack(fill='both', expand=True)
        
        buttons = [
            ('1', '2', '3'),
            ('4', '5', '6'),
            ('7', '8', '9'),
            ('C', '0', 'âŒ«')
        ]
        
        for r, row_vals in enumerate(buttons):
            for c, char in enumerate(row_vals):
                btn_color = "#34495E"
                fg_color = "white"
                
                cmd = lambda k=char: self.button_click(k)
                
                if char == 'C':
                    btn_color = "#E74C3C"
                elif char == 'âŒ«':
                    btn_color = "#E67E22"
                
                btn = tk.Button(keypad_frame, text=char, command=cmd,
                                font=("Segoe UI", 18, "bold"), bg=btn_color, fg=fg_color,
                                relief='flat', activebackground="#95A5A6")
                btn.grid(row=r, column=c, padx=3, pady=3, sticky="nsew")
        
        confirm_btn = tk.Button(main_frame, text="ØªØ£ÙƒÙŠÙ€Ù€Ø¯ âœ…", command=self.confirm,
                                bg="#27AE60", fg="white", font=("Segoe UI", 16, "bold"),
                                height=1, relief='flat', cursor="hand2")
        confirm_btn.pack(fill='x', pady=(10, 0))
        
        for i in range(3): keypad_frame.columnconfigure(i, weight=1)
        for i in range(4): keypad_frame.rowconfigure(i, weight=1)
    
    def button_click(self, key):
        current = self.value.get()
        if key == 'C':
            self.value.set("")
        elif key == 'âŒ«':
            self.value.set(current[:-1])
        else:
            if len(current) < 11:
                self.value.set(current + key)
    
    def confirm(self):
        self.callback(self.value.get())
        self.window.destroy()

class LoginWindow:
    """Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¹ Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­ Ø±Ù‚Ù…ÙŠØ© Ù„Ù„Ø±Ù…Ø²"""
    def __init__(self, root, callback):
        self.root = root
        self.callback = callback
        self.password_var = tk.StringVar()
        self.setup_ui()
        
    def setup_ui(self):
        self.root.title("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ù‚ØµØ§Ø¨Ø© ÙˆÙ…Ø´ÙˆÙŠØ§Øª Ø§Ù„Ø­Ø³Ù†")
        self.root.geometry("450x600") # ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        self.root.configure(bg=BG_MAIN_COLOR)
        self.root.resizable(False, False)
        
        screen_width = self.root.winfo_screenwidth()
        screen_height = self.root.winfo_screenheight()
        x = (screen_width/2) - (450/2)
        y = (screen_height/2) - (600/2)
        self.root.geometry('%dx%d+%d+%d' % (450, 600, x, y))
        
        main_frame = tk.Frame(self.root, bg=PANEL_COLOR, padx=30, pady=20, relief='raised', bd=1)
        main_frame.place(relx=0.5, rely=0.5, anchor='center')
        
        tk.Label(main_frame, text="ğŸ–", font=("Segoe UI", 40), bg=PANEL_COLOR).pack()
        tk.Label(main_frame, text="Ù‚ØµØ§Ø¨Ø© ÙˆÙ…Ø´ÙˆÙŠØ§Øª Ø§Ù„Ø­Ø³Ù†",
                 font=("Segoe UI", 18, "bold"), bg=PANEL_COLOR, fg="white").pack(pady=5)
        
        tk.Label(main_frame, text="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„:", font=("Segoe UI", 14), bg=PANEL_COLOR, fg="white").pack(pady=(10, 5))

        # Ø­Ù‚Ù„ Ø¹Ø±Ø¶ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        self.password_display = tk.Label(main_frame, textvariable=self.password_var,
                                         font=("Arial", 24), bg="#F2F2F7", fg=PANEL_COLOR,
                                         width=15, anchor='center', relief='flat', bd=5)
        self.password_display.pack(pady=5, ipady=5)
        
        # Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
        keypad_frame = tk.Frame(main_frame, bg=PANEL_COLOR)
        keypad_frame.pack(pady=15, padx=10)

        buttons = [
            ('1', '2', '3'),
            ('4', '5', '6'),
            ('7', '8', '9'),
            ('Ù…Ø³Ø­', '0', 'Ø­Ø°Ù')
        ]
        
        for r, row_vals in enumerate(buttons):
            row_frame = tk.Frame(keypad_frame, bg=PANEL_COLOR)
            row_frame.pack(fill='x')
            for c, char in enumerate(row_vals):
                cmd = lambda k=char: self.keypad_press(k)
                btn_color = PRIMARY_COLOR if char.isdigit() else DANGER_COLOR if char == 'Ù…Ø³Ø­' else "#E67E22"
                
                btn = tk.Button(row_frame, text=char, command=cmd,
                                font=("Segoe UI", 14, "bold"), bg=btn_color, fg="white",
                                relief='flat', width=6, height=1)
                btn.pack(side='right', padx=2, pady=2)

        login_btn = tk.Button(main_frame, text="Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù… ğŸ”“", command=self.check_password,
                              bg="#FFFFFF", fg=PANEL_COLOR, font=FONT_BOLD,
                              width=20, height=2, relief='flat', cursor="hand2")
        login_btn.pack(pady=20)

    def keypad_press(self, key):
        current = self.password_var.get()
        if key == 'Ù…Ø³Ø­':
            self.password_var.set("")
        elif key == 'Ø­Ø°Ù':
            self.password_var.set(current[:-1])
        elif key.isdigit() and len(current) < 10:
            self.password_var.set(current + key)

    def check_password(self):
        if self.password_var.get() == "1":
            self.root.destroy()
            self.callback()
        else:
            messagebox.showerror("Ø®Ø·Ø£", "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!")

class NumericKeypad:
    """Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ²Ù† (Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØ³ÙˆØ±)"""
    def __init__(self, parent, callback):
        self.parent = parent
        self.callback = callback
        self.value = tk.StringVar(value="0")
        self.setup_ui()
        
    def setup_ui(self):
        self.window = tk.Toplevel(self.parent)
        self.window.title("Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆØ²Ù† (ÙƒØºÙ…)")
        self.window.geometry("400x650") # ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨ ØµÙ Ø¥Ø¶Ø§ÙÙŠ
        self.window.configure(bg=BG_MAIN_COLOR)
        self.window.transient(self.parent)
        self.window.grab_set()
        
        x = self.parent.winfo_x() + (self.parent.winfo_width() // 2) - 200
        y = self.parent.winfo_y() + (self.parent.winfo_height() // 2) - 325
        self.window.geometry(f"+{x}+{y}")
        
        main_frame = tk.Frame(self.window, bg=BG_MAIN_COLOR, padx=15, pady=15)
        main_frame.pack(fill='both', expand=True)
        
        self.display = tk.Label(main_frame, textvariable=self.value,
                               font=("Consolas", 40, "bold"), bg="white",
                               fg=TEXT_COLOR, height=2, anchor='e', padx=10)
        self.display.pack(fill='x', pady=(0, 15))
        
        keypad_frame = tk.Frame(main_frame, bg=BG_MAIN_COLOR)
        keypad_frame.pack(fill='both', expand=True)
        
        # Ø£Ø²Ø±Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        buttons = [
            ('7', '8', '9'),
            ('4', '5', '6'),
            ('1', '2', '3'),
            ('0', '.', 'C')
        ]
        
        row, col = 0, 0
        for button in buttons:
            for b in button:
                cmd = lambda x=b: self.button_click(x)
                color = "#FFCDD2" if b == 'C' else PANEL_COLOR
                fg_col = DANGER_COLOR if b == 'C' else "white"
                btn = tk.Button(keypad_frame, text=b, command=cmd,
                                font=("Segoe UI", 22, "bold"), bg=color, fg=fg_col, relief='flat')
                btn.grid(row=row, column=col, padx=4, pady=4, sticky="nsew")
                col += 1
            col = 0
            row += 1

        # ØµÙ Ø§Ù„ÙƒØ³ÙˆØ±
        frac_frame = tk.Frame(keypad_frame, bg=BG_MAIN_COLOR)
        frac_frame.grid(row=row, column=0, columnspan=3, sticky='ew', pady=(5,0))
        
        fractions = [("1/4", 0.25), ("1/2", 0.5), ("3/4", 0.75)]
        for txt, val in fractions:
            cmd = lambda v=val: self.fraction_click(v)
            btn = tk.Button(frac_frame, text=txt, command=cmd,
                            font=("Segoe UI", 18, "bold"), bg=SECONDARY_COLOR, fg="white", relief='flat')
            btn.pack(side='right', fill='x', expand=True, padx=4, pady=4)

        row += 1
        
        confirm_btn = tk.Button(main_frame, text="ØªØ£ÙƒÙŠÙ€Ù€Ø¯ Ø§Ù„Ù€ÙˆØ²Ù† âœ…", command=self.confirm,
                                bg="#00C853", fg="white", font=("Segoe UI", 18, "bold"),
                                height=2, relief='raised', bd=3, cursor="hand2")
        confirm_btn.pack(fill='x', pady=(15, 5))
        
        for i in range(3): keypad_frame.columnconfigure(i, weight=1)
        for i in range(row): keypad_frame.rowconfigure(i, weight=1)
    
    def button_click(self, key):
        if key == 'C': self.value.set("0")
        else:
            current = self.value.get()
            if current == "0" and key != '.': self.value.set(key)
            else:
                if key == '.' and '.' in current: return
                self.value.set(current + key)

    def fraction_click(self, val):
        current = self.value.get()
        try:
            current_val = float(current)
            self.value.set(f"{current_val + val:.2f}")
        except ValueError:
            self.value.set(f"{val:.2f}")
    
    def confirm(self):
        try:
            weight = float(self.value.get())
            if weight > 0:
                self.callback(weight)
                self.window.destroy()
        except ValueError: pass

class DateTimePicker(simpledialog.Dialog):
    """Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨"""
    def __init__(self, parent, title, initial_time=None):
        self.initial_time = initial_time if initial_time else datetime.datetime.now().strftime("%I:%M %p")
        super().__init__(parent, title=title)

    def body(self, master):
        self.config(bg=PANEL_COLOR)
        tk.Label(master, text="Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª:", font=FONT_BOLD, bg=PANEL_COLOR, fg="white").pack(pady=10)
        
        time_frame = tk.Frame(master, bg="white", padx=10, pady=10)
        time_frame.pack()
        
        current_time = datetime.datetime.now()
        
        # Ø­Ù‚Ù„ Ø§Ù„Ø³Ø§Ø¹Ø©
        tk.Label(time_frame, text="Ø§Ù„Ø³Ø§Ø¹Ø©:", font=FONT_MAIN).pack(side='right', padx=5)
        self.hour_var = tk.StringVar(value=current_time.strftime("%I"))
        self.hour_spin = ttk.Spinbox(time_frame, from_=1, to=12, wrap=True, textvariable=self.hour_var, width=5, font=FONT_MAIN, justify='center')
        self.hour_spin.pack(side='right', padx=5)
        
        # Ø­Ù‚Ù„ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©
        tk.Label(time_frame, text="Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©:", font=FONT_MAIN).pack(side='right', padx=5)
        self.minute_var = tk.StringVar(value=current_time.strftime("%M"))
        self.minute_spin = ttk.Spinbox(time_frame, from_=0, to=59, wrap=True, textvariable=self.minute_var, width=5, font=FONT_MAIN, justify='center')
        self.minute_spin.pack(side='right', padx=5)
        
        # Ø­Ù‚Ù„ AM/PM
        tk.Label(time_frame, text="Øµ/Ù…:", font=FONT_MAIN).pack(side='right', padx=5)
        self.am_pm_var = tk.StringVar(value="AM" if current_time.hour < 12 else "PM")
        self.am_pm_spin = ttk.Spinbox(time_frame, values=("AM", "PM"), textvariable=self.am_pm_var, width=5, font=FONT_MAIN, justify='center')
        self.am_pm_spin.pack(side='right', padx=5)
        
        return self.hour_spin # Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø³Ø§Ø¹Ø©

    def apply(self):
        try:
            h = int(self.hour_var.get())
            m = int(self.minute_var.get())
            ap = self.am_pm_var.get()
            
            # Ø¨Ù†Ø§Ø¡ Ø³Ù„Ø³Ù„Ø© Ø§Ù„ÙˆÙ‚Øª
            time_str = f"{h:02}:{m:02} {ap}"
            self.result = time_str
        except ValueError:
            messagebox.showerror("Ø®Ø·Ø£", "ØªÙ†Ø³ÙŠÙ‚ ÙˆÙ‚Øª ØºÙŠØ± ØµØ­ÙŠØ­")

class RestaurantPOS:
    def __init__(self, root):
        self.root = root
        self.root.title("Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù‚ØµØ§Ø¨Ø© ÙˆÙ…Ø´ÙˆÙŠØ§Øª Ø§Ù„Ø­Ø³Ù†")
        self.root.state('zoomed')
        self.root.configure(bg=BG_MAIN_COLOR)
        
        self.setup_styles()
        self.cart = []
        self.db_name = "restaurant.db"
        self.settings_file = "settings.json"
        self.load_settings()
        self.init_db()
        
        self.order_type = tk.StringVar(value="takeaway")
        self.phone_var = tk.StringVar()
        self.customer_name_var = tk.StringVar()
        self.address_var = tk.StringVar()
        self.pickup_time_var = tk.StringVar()
        self.payment_status_var = tk.StringVar(value="paid")
        self.search_var = tk.StringVar()
        self.general_notes_var = tk.StringVar()
        
        self.phone_var.trace("w", self.on_phone_change)
        self.search_var.trace("w", self.on_search_change)
        self.order_type.trace("w", lambda *args: self.toggle_fields())
        
        self.setup_ui()

    def setup_styles(self):
        style = ttk.Style()
        style.theme_use('clam')
        style.configure("TNotebook", background=BG_MAIN_COLOR, borderwidth=0)
        style.configure("TNotebook.Tab", font=("Segoe UI", 12), padding=[15, 8])
        style.configure("Treeview", font=("Segoe UI", 11), rowheight=35)
        style.configure("Treeview.Heading", font=("Segoe UI", 11, "bold"), background=SECONDARY_COLOR, foreground="white")
    
    def load_settings(self):
        default_settings = {
            "printers": ["Default Printer"],
            "logo_path": "",
            "receipt_design": {"header_text": "Ù‚ØµØ§Ø¨Ø© ÙˆÙ…Ø´ÙˆÙŠØ§Øª Ø§Ù„Ø­Ø³Ù†", "show_logo": True, "footer_text": "Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙ…"}
        }
        try:
            with open(self.settings_file, 'r', encoding='utf-8') as f: self.settings = json.load(f)
        except:
            self.settings = default_settings
            
    def save_settings(self):
        with open(self.settings_file, 'w', encoding='utf-8') as f: json.dump(self.settings, f, ensure_ascii=False, indent=4)
        
    def init_db(self):
        conn = sqlite3.connect(self.db_name)
        c = conn.cursor()
        c.execute('''CREATE TABLE IF NOT EXISTS products (
            id INTEGER PRIMARY KEY,
            name TEXT,
            price REAL,
            image BLOB,
            category TEXT,
            weight_based INTEGER DEFAULT 0,
            card_color TEXT DEFAULT '#FFFFFF',
            suggestions TEXT DEFAULT ''
        )''')
        
        try:
            c.execute("ALTER TABLE products ADD COLUMN card_color TEXT DEFAULT '#FFFFFF'")
        except: pass
        try:
            c.execute("ALTER TABLE products ADD COLUMN suggestions TEXT DEFAULT ''")
        except: pass
        
        c.execute('''CREATE TABLE IF NOT EXISTS customers (phone TEXT PRIMARY KEY, name TEXT, address TEXT, last_order_date TEXT)''')
        c.execute('''CREATE TABLE IF NOT EXISTS orders (id INTEGER PRIMARY KEY, date TEXT, customer_name TEXT, phone TEXT, type TEXT, details TEXT, total REAL, notes TEXT, status TEXT, pickup_time TEXT, address TEXT, payment_status TEXT)''')
        c.execute('''CREATE TABLE IF NOT EXISTS sales (id INTEGER PRIMARY KEY, date TEXT, order_id INTEGER, amount REAL, type TEXT)''')
        
        c.execute('''CREATE TABLE IF NOT EXISTS order_items (
            id INTEGER PRIMARY KEY,
            order_id INTEGER,
            product_name TEXT,
            qty REAL,
            price REAL,
            total REAL,
            note TEXT DEFAULT '',
            FOREIGN KEY(order_id) REFERENCES orders(id)
        )''')
        try:
            c.execute("ALTER TABLE order_items ADD COLUMN note TEXT DEFAULT ''")
        except: pass

        conn.commit()
        conn.close()
        
    def setup_ui(self):
        self.notebook = ttk.Notebook(self.root)
        self.notebook.pack(fill='both', expand=True, padx=5, pady=5)
        
        self.pos_frame = ttk.Frame(self.notebook)
        self.notebook.add(self.pos_frame, text=" ğŸ›’ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ ")
        self.build_pos_tab()
        
        self.products_frame = ttk.Frame(self.notebook)
        self.notebook.add(self.products_frame, text=" ğŸ¥© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ¬Ø¨Ø§Øª ")
        self.build_products_tab()
        
        self.reports_frame = ttk.Frame(self.notebook)
        self.notebook.add(self.reports_frame, text=" ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ")
        self.build_reports_tab()
        
        self.settings_frame = ttk.Frame(self.notebook)
        self.notebook.add(self.settings_frame, text=" âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ")
        self.build_settings_tab()
        
    def build_pos_tab(self):
        top_control_frame = tk.Frame(self.pos_frame, bg=BG_MAIN_COLOR, pady=5)
        top_control_frame.pack(side='top', fill='x')
        style_toggle = {"font": ("Segoe UI", 12, "bold"), "indicatoron": 0, "width": 15, "relief": "flat", "bd": 0, "selectcolor": PRIMARY_COLOR, "fg": "#333"}
        
        center_toggle = tk.Frame(top_control_frame, bg=BG_MAIN_COLOR)
        center_toggle.pack(anchor='center')
        rb_takeaway = tk.Radiobutton(center_toggle, text="ğŸ›ï¸ Ø³ÙØ±ÙŠ (Ø§Ø³ØªÙ„Ø§Ù…)", variable=self.order_type, value="takeaway", **style_toggle)
        rb_takeaway.pack(side='left', padx=2)
        
        rb_delivery = tk.Radiobutton(center_toggle, text="ğŸ›µ ØªÙˆØµÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ", variable=self.order_type, value="delivery", **style_toggle)
        rb_delivery.pack(side='left', padx=2)
        # Ø´Ø±ÙŠØ· Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²Ø¨ÙˆÙ†
        customer_bar = tk.Frame(self.pos_frame, bg="white", padx=10, pady=8, relief='raised', bd=1)
        customer_bar.pack(side='top', fill='x', pady=(0, 5))
        
        right_frame = tk.Frame(customer_bar, bg="white")
        right_frame.pack(side='right')
        
        tk.Label(right_frame, text="ğŸ“±", font=("Segoe UI", 12), bg="white").pack(side='right', padx=(5,0))
        self.phone_entry = tk.Entry(right_frame, textvariable=self.phone_var, font=("Segoe UI", 11, "bold"), width=15, bg="#F9F9F9", justify='center')
        self.phone_entry.pack(side='right', padx=5)
        self.phone_entry.bind("<Button-1>", self.open_phone_keypad)
        
        tk.Label(right_frame, text="ğŸ‘¤", font=("Segoe UI", 12), bg="white").pack(side='right', padx=(5,0))
        self.cust_name_entry = tk.Entry(right_frame, textvariable=self.customer_name_var, font=("Segoe UI", 11), width=20, bg="#F9F9F9", justify='right')
        self.cust_name_entry.pack(side='right', padx=5)
        self.cust_name_entry.bind("<Button-1>", lambda e: self.open_text_keypad(self.customer_name_var, "Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†", "arabic"))
        
        self.dynamic_fields_frame = tk.Frame(customer_bar, bg="white")
        self.dynamic_fields_frame.pack(side='right', padx=20)
        
        self.addr_container = tk.Frame(self.dynamic_fields_frame, bg="white")
        tk.Label(self.addr_container, text="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:", bg="white", font=("Segoe UI", 10, "bold")).pack(side='right')
        self.addr_entry = tk.Entry(self.addr_container, textvariable=self.address_var, font=("Segoe UI", 10), width=25, bg="#F9F9F9")
        self.addr_entry.pack(side='right', padx=5)
        self.addr_entry.bind("<Button-1>", lambda e: self.open_text_keypad(self.address_var, "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†", "arabic"))

        
        self.time_container = tk.Frame(self.dynamic_fields_frame, bg="white")
        self.lbl_time = tk.Label(self.time_container, text="ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:", bg="white", font=("Segoe UI", 10, "bold"))
        self.lbl_time.pack(side='right')
        self.time_entry = tk.Entry(self.time_container, textvariable=self.pickup_time_var, font=("Segoe UI", 10), width=15, bg="#F9F9F9")
        self.time_entry.pack(side='right', padx=5)
        self.time_entry.bind("<Button-1>", self.open_time_picker)
        
        left_frame = tk.Frame(customer_bar, bg="white")
        left_frame.pack(side='left')
        
        # Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¨Ø¹Ø¯ ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        tk.Button(left_frame, text="Ø¥Ø±Ø¬Ø§Ø¹ ÙØ§ØªÙˆØ±Ø© â†©ï¸", command=lambda: self.retrieve_order_dialog(use_keypad=True),
                  bg="#607D8B", fg="white", font=("Segoe UI", 9, "bold"), relief='flat').pack(side='left', padx=5)
        
        tk.Button(left_frame, text="Ø¥Ø¹Ø§Ø¯Ø© Ø·Ø¨Ø§Ø¹Ø© ğŸ–¨ï¸", command=lambda: self.reprint_order_dialog(use_keypad=True),
                  bg="#795548", fg="white", font=("Segoe UI", 9, "bold"), relief='flat').pack(side='left', padx=5)
        # Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        paned = tk.PanedWindow(self.pos_frame, orient=tk.HORIZONTAL, bg=BG_MAIN_COLOR, sashwidth=6)
        paned.pack(fill='both', expand=True, pady=5)
        
        # === Ø§Ù„ÙŠØ³Ø§Ø±: Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ§Ù„Ø³Ù„Ø© ===
        left_cart_frame = tk.Frame(paned, bg=PANEL_COLOR, relief='sunken', bd=1)
        paned.add(left_cart_frame, minsize=420, stretch="always")
        
        footer_frame = tk.Frame(left_cart_frame, bg="#F8F9FA")
        footer_frame.pack(side='bottom', fill='x')
        
        action_btns = tk.Frame(footer_frame, bg="#F8F9FA", padx=2, pady=2)
        action_btns.pack(side='bottom', fill='x')
        
        sub_btns = tk.Frame(action_btns, bg="#F8F9FA")
        sub_btns.pack(fill='x', pady=(0, 2))
        
        tk.Button(sub_btns, text="ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø© â™»ï¸", command=self.clear_cart, bg=DANGER_COLOR, fg="white", font=("Segoe UI", 9), relief='flat', height=1).pack(side='left', fill='x', expand=True)
        tk.Button(action_btns, text="Ø·Ø¨Ø§Ø¹Ø© ÙˆØ¥Ù†Ù‡Ø§Ø¡ ğŸ–¨ï¸", command=self.checkout, bg=SUCCESS_COLOR, fg="white", font=("Segoe UI", 11, "bold"), height=1, relief='flat').pack(fill='x', pady=1)
        
        total_frame = tk.Frame(footer_frame, bg="#343A40", pady=2)
        total_frame.pack(side='bottom', fill='x')
        self.lbl_total = tk.Label(total_frame, text="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: 0 Ø¯.Ø¹", font=("Arial", 16, "bold"), bg="#343A40", fg=SUCCESS_COLOR)
        self.lbl_total.pack()
        
        pay_opts = tk.Frame(footer_frame, bg="#F8F9FA", pady=2)
        pay_opts.pack(side='bottom', fill='x')
        
        self.btn_paid = tk.Button(pay_opts, text="âœ… ÙˆØ§ØµÙ„", font=("Segoe UI", 10, "bold"),
                                  relief='raised', bd=1, width=12, cursor="hand2",
                                  command=lambda: self.set_payment_status("paid"))
        self.btn_paid.pack(side='right', padx=10, expand=True)
        
        self.btn_unpaid = tk.Button(pay_opts, text="â³ ØºÙŠØ± ÙˆØ§ØµÙ„", font=("Segoe UI", 10, "bold"),
                                    relief='raised', bd=1, width=12, cursor="hand2",
                                    command=lambda: self.set_payment_status("unpaid"))
        self.btn_unpaid.pack(side='left', padx=10, expand=True)
        
        self.set_payment_status("paid")
        
        general_note_frame = tk.Frame(footer_frame, bg="#F8F9FA", padx=5, pady=2)
        general_note_frame.pack(side='bottom', fill='x')
        self.general_note_entry = tk.Entry(general_note_frame, textvariable=self.general_notes_var, font=("Segoe UI", 10), bg="white", relief='solid', bd=1)
        self.general_note_entry.pack(fill='x', ipady=2)
        self.general_note_entry.bind("<Button-1>", lambda e: self.open_text_keypad(self.general_notes_var, "Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©", "arabic"))
        tk.Label(general_note_frame, text="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©:", bg="#F8F9FA", font=("Segoe UI", 9, "bold"), fg=TEXT_SECONDARY).pack(anchor='ne')
        
        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
        tk.Label(left_cart_frame, text="ğŸ§¾ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©", font=FONT_BOLD, bg=PANEL_COLOR, fg="white").pack(pady=(5,0))
        
        cols = ('item', 'qty', 'price', 'total', 'note', 'action')
        self.tree = ttk.Treeview(left_cart_frame, columns=cols, show='headings', selectmode='browse')
        self.tree.heading('item', text='Ø§Ù„ØµÙ†Ù')
        self.tree.heading('qty', text='Ø§Ù„ÙƒÙ…ÙŠØ©')
        self.tree.heading('price', text='Ø§Ù„Ø³Ø¹Ø±')
        self.tree.heading('total', text='Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ')
        self.tree.heading('note', text='Ù…Ù„Ø§Ø­Ø¸Ø§Øª')
        self.tree.heading('action', text='')
        
        self.tree.column('item', width=120, anchor='e')
        self.tree.column('qty', width=50, anchor='center')
        self.tree.column('price', width=70, anchor='center')
        self.tree.column('total', width=70, anchor='center')
        self.tree.column('note', width=90, anchor='e')
        self.tree.column('action', width=40, anchor='center')
        
        self.tree.pack(fill='both', expand=True, padx=5)
        self.tree.bind("<Button-1>", self.on_tree_click)
        self.tree.bind("<Double-1>", self.on_item_double_click)
        
        # === Ø§Ù„ÙŠÙ…ÙŠÙ†: Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø¨Ø­Ø« ===
        right_products_frame = tk.Frame(paned, bg=BG_MAIN_COLOR)
        paned.add(right_products_frame, minsize=550)
        
        search_frame = tk.Frame(right_products_frame, bg=PANEL_COLOR, padx=10, pady=10)
        search_frame.pack(fill='x', pady=(0, 5))
        tk.Label(search_frame, text="ğŸ” Ø¨Ø­Ø«:", bg=PANEL_COLOR, font=FONT_BOLD, fg="white").pack(side='right', padx=5)
        tk.Entry(search_frame, textvariable=self.search_var, font=FONT_MAIN, bg="#F2F2F7", relief='flat').pack(side='right', fill='x', expand=True, ipady=3)
        
        products_container = tk.Frame(right_products_frame, bg=BG_MAIN_COLOR)
        products_container.pack(fill='both', expand=True)
        
        self.canvas_products = tk.Canvas(products_container, bg=BG_MAIN_COLOR, highlightthickness=0)
        self.scroll_y = ttk.Scrollbar(products_container, orient="vertical", command=self.canvas_products.yview)
        
        self.scrollable_frame = tk.Frame(self.canvas_products, bg=BG_MAIN_COLOR)
        self.scrollable_frame.bind("<Configure>", lambda e: self.canvas_products.configure(scrollregion=self.canvas_products.bbox("all")))
        
        self.canvas_products.create_window((0, 0), window=self.scrollable_frame, anchor="ne")
        self.canvas_products.configure(yscrollcommand=self.scroll_y.set)
        
        self.scroll_y.pack(side="left", fill="y")
        self.canvas_products.pack(side="right", fill="both", expand=True)
        
        self.load_products_grid()
        self.toggle_fields()

    # --- Ø¯ÙˆØ§Ù„ Ù„ÙˆØ­Ø§Øª Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙˆØ§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© ---
    def open_phone_keypad(self, event):
        PhoneKeypad(self.root, self.update_phone_from_keypad, self.phone_var.get())
        return "break"
    
    def update_phone_from_keypad(self, val):
        self.phone_var.set(val)

    def open_text_keypad(self, var_obj, title, input_type):
        dlg = CustomInputDialog(self.root, title, title, var_obj.get(), input_type)
        if dlg.result is not None:
            var_obj.set(dlg.result)
        return "break"

    def open_time_picker(self, event):
        dlg = DateTimePicker(self.root, "ØªØ­Ø¯ÙŠØ¯ ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…/Ø§Ù„ØªÙˆØµÙŠÙ„")
        if dlg.result:
            self.pickup_time_var.set(dlg.result)
        return "break"

    def set_payment_status(self, status):
        self.payment_status_var.set(status)
        if status == "paid":
            self.btn_paid.config(bg=SUCCESS_COLOR, fg="white", state="normal", relief="sunken")
            self.btn_unpaid.config(bg="#E0E0E0", fg="#666", state="normal", relief="raised")
            self.lbl_total.config(fg=SUCCESS_COLOR)
        else:
            self.btn_paid.config(bg="#E0E0E0", fg="#666", state="normal", relief="raised")
            self.btn_unpaid.config(bg=DANGER_COLOR, fg="white", state="normal", relief="sunken")
            self.lbl_total.config(fg=DANGER_COLOR)
            
    def on_tree_click(self, event):
        region = self.tree.identify_region(event.x, event.y)
        if region == "cell":
            column = self.tree.identify_column(event.x)
            if column == '#6':
                item_id = self.tree.identify_row(event.y)
                if item_id:
                    index = self.tree.index(item_id)
                    if 0 <= index < len(self.cart):
                        self.cart.pop(index)
                        self.update_cart_view()
                        
    def on_item_double_click(self, event):
        column = self.tree.identify_column(event.x)
        if column == '#6': return
        item_id = self.tree.identify_row(event.y)
        if not item_id:
            return
        
        index = self.tree.index(item_id)
        if 0 <= index < len(self.cart):
            current_item = self.cart[index]
            current_note = current_item.get('note', '')
            sugs = current_item.get('suggestions', '')
            
            dlg = NoteDialog(self.root, "Ù…Ù„Ø§Ø­Ø¸Ø© ÙˆØ¬Ø¨Ø©", f"Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù€ ({current_item['name']}):", current_note, suggestions_str=sugs)
            
            if dlg.result is not None:
                self.cart[index]['note'] = dlg.result
                self.update_cart_view()

    def on_phone_change(self, *args):
        phone = self.phone_var.get()
        if not phone.isdigit() and phone != "":
            self.phone_var.set(''.join(filter(str.isdigit, phone)))
            return
        
        if len(phone) == 11:
            self.phone_entry.config(fg=SUCCESS_COLOR)
            self.fetch_customer_data(phone)
        else:
            self.phone_entry.config(fg="black")
        
        if len(phone) > 11:
            self.phone_var.set(phone[:11])
            self.phone_entry.config(fg=SUCCESS_COLOR)
            
    def on_search_change(self, *args):
        self.load_products_grid()
        
    def fetch_customer_data(self, phone):
        conn = sqlite3.connect(self.db_name)
        c = conn.cursor()
        c.execute("SELECT name, address FROM customers WHERE phone=?", (phone,))
        res = c.fetchone()
        conn.close()
        if res:
            self.customer_name_var.set(res[0])
            self.address_var.set(res[1] if res[1] else "")
        else:
            self.customer_name_var.set("")
            self.address_var.set("")
            
    def toggle_fields(self):
        val = self.order_type.get()
        self.addr_container.pack_forget()
        self.time_container.pack_forget()
        
        self.time_container.pack(side='right', padx=5)
        
        if val == "takeaway":
            self.lbl_time.config(text="ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:")
        else:
            self.lbl_time.config(text="ÙˆÙ‚Øª Ø§Ù„ØªÙˆØµÙŠÙ„:")
            self.addr_container.pack(side='right', padx=5)
            if len(self.phone_var.get()) == 11:
                self.fetch_customer_data(self.phone_var.get())
                
    def load_products_grid(self):
        for widget in self.scrollable_frame.winfo_children(): widget.destroy()
        conn = sqlite3.connect(self.db_name)
        c = conn.cursor()
        search_term = self.search_var.get()
        
        query = "SELECT id, name, price, image, weight_based, card_color, suggestions FROM products"
        params = []
        if search_term:
            query += " WHERE name LIKE ?"
            params = [f'%{search_term}%']
            
        c.execute(query, params)
        products = c.fetchall()
        conn.close()
        
        MAX_COLS = 5
        row = 0
        col = 0
        
        for pid, name, price, img_blob, weight_based, card_color, suggestions in products:
            bg_color = card_color if card_color else "#FFFFFF"
            
            card = tk.Frame(self.scrollable_frame, bg=bg_color, bd=0, relief="flat", highlightbackground="#E0E0E0", highlightthickness=1)
            card.grid(row=row, column=MAX_COLS - 1 - col, padx=4, pady=4, sticky="nsew")
            
            click_cmd = lambda e, p=pid, n=name, pr=price, w=weight_based, s=suggestions, c=bg_color: self.add_product_to_cart(p, n, pr, w, s, c)
            card.bind("<Button-1>", click_cmd)
            
            img_frame = tk.Frame(card, bg=bg_color, height=80, width=120)
            img_frame.pack_propagate(False)
            img_frame.pack()
            img_frame.bind("<Button-1>", click_cmd)
            
            if img_blob:
                try:
                    image = Image.open(io.BytesIO(img_blob))
                    image = image.resize((120, 80), Image.Resampling.LANCZOS)
                    photo = ImageTk.PhotoImage(image)
                    lbl = tk.Label(img_frame, image=photo, bg=bg_color)
                    lbl.image = photo
                    lbl.pack()
                    lbl.bind("<Button-1>", click_cmd)
                except:
                    lbl_icon = tk.Label(img_frame, text="ğŸ–", font=("Segoe UI", 24), bg=bg_color, fg="#CCC")
                    lbl_icon.pack(expand=True, fill='both')
                    lbl_icon.bind("<Button-1>", click_cmd)
            else:
                lbl_icon = tk.Label(img_frame, text="ğŸ–", font=("Segoe UI", 24), bg=bg_color, fg="#CCC")
                lbl_icon.pack(expand=True, fill='both')
                lbl_icon.bind("<Button-1>", click_cmd)
            
            info_frame = tk.Frame(card, bg=bg_color, pady=2)
            info_frame.pack(fill='x')
            info_frame.bind("<Button-1>", click_cmd)
            
            name_lbl = tk.Label(info_frame, text=name, font=("Segoe UI", 10, "bold"), bg=bg_color, fg=TEXT_COLOR, wraplength=110)
            name_lbl.pack()
            name_lbl.bind("<Button-1>", click_cmd)
            
            unit = "ÙƒØºÙ…" if weight_based else "Ù‚Ø·Ø¹Ø©"
            price_color = ACCENT_COLOR if weight_based else SUCCESS_COLOR
            price_lbl = tk.Label(info_frame, text=f"{price:,.0f} Ø¯.Ø¹", font=("Segoe UI", 9), bg=bg_color, fg=price_color)
            price_lbl.pack()
            price_lbl.bind("<Button-1>", click_cmd)
            
            bar = tk.Frame(card, bg=price_color, height=3)
            bar.pack(fill='x', side='bottom')
            bar.bind("<Button-1>", click_cmd)
            
            col += 1
            if col >= MAX_COLS:
                col = 0
                row += 1
        self.scrollable_frame.update_idletasks()
        self.canvas_products.configure(scrollregion=self.canvas_products.bbox("all"))
        
    def add_product_to_cart(self, pid, name, price, weight_based, suggestions, color):
        if weight_based:
            NumericKeypad(self.root, lambda weight: self.add_weight_item(pid, name, price, weight, suggestions, color))
        else:
            self.add_regular_item(pid, name, price, suggestions, color)
            
    def add_regular_item(self, pid, name, price, suggestions, color):
        for item in self.cart:
            if item['id'] == pid and not item['weight_based']:
                item['qty'] += 1
                item['total'] = item['qty'] * price
                self.update_cart_view()
                return
        self.cart.append({"id": pid, "name": name, "qty": 1, "price": price, "total": price, "weight_based": False, "note": "", "suggestions": suggestions, "color": color})
        self.update_cart_view()
        
    def add_weight_item(self, pid, name, price, weight, suggestions, color):
        self.cart.append({"id": pid, "name": name, "qty": weight, "price": price, "total": weight * price, "weight_based": True, "note": "", "suggestions": suggestions, "color": color})
        self.update_cart_view()
        
    def update_cart_view(self):
        for item in self.tree.get_children():
            self.tree.delete(item)
        grand_total = 0
        for item in self.cart:
            qty_val = item['qty']
            qty_fmt = str(int(qty_val)) if qty_val == int(qty_val) else f"{qty_val:.3f}"
            if item['weight_based']:
                # Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø¹Ù„Ù‰ Ø´ÙƒÙ„ ÙƒØ³ÙˆØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚ÙŠÙ… 0.25, 0.5, 0.75
                if abs(qty_val - 0.25) < 0.01:
                    qty_fmt = "1/4"
                elif abs(qty_val - 0.5) < 0.01:
                    qty_fmt = "1/2"
                elif abs(qty_val - 0.75) < 0.01:
                    qty_fmt = "3/4"
                elif qty_val > 1 and qty_val < 2:
                    # Ù„Ù„ÙƒÙ…ÙŠØ§Øª Ù…Ø«Ù„ 1.5, 1.25, 1.75
                    int_part = int(qty_val)
                    frac_part = qty_val - int_part
                    if abs(frac_part - 0.25) < 0.01:
                        qty_fmt = f"{int_part} Ùˆ 1/4"
                    elif abs(frac_part - 0.5) < 0.01:
                        qty_fmt = f"{int_part} Ùˆ 1/2"
                    elif abs(frac_part - 0.75) < 0.01:
                        qty_fmt = f"{int_part} Ùˆ 3/4"
                    else:
                         qty_fmt = f"{qty_val:.3f}"
                else:
                    qty_fmt = f"{qty_val:.3f}"

            note_display = f"ğŸ“ {item['note']}" if item['note'] else ""
            
            row_color = item.get('color', '#FFFFFF')
            
            self.tree.insert('', 'end', values=(item['name'], qty_fmt, f"{item['price']:,.0f}", f"{item['total']:,.0f}", note_display, "âŒ"), tags=(row_color,))
            self.tree.tag_configure(row_color, background=row_color)
            grand_total += item['total']
        self.lbl_total.config(text=f"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: {grand_total:,.0f} Ø¯.Ø¹")
        
    def clear_cart(self):
        self.cart = []
        self.general_notes_var.set("")
        self.update_cart_view()
        
    def retrieve_order_dialog(self, use_keypad=False):
        if use_keypad:
            dlg = CustomInputDialog(self.root, "Ø¥Ø±Ø¬Ø§Ø¹ ÙØ§ØªÙˆØ±Ø©", "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:", input_type="numeric")
            oid = dlg.result
            if oid:
                try:
                    oid = int(oid)
                except ValueError:
                    messagebox.showerror("Ø®Ø·Ø£", "Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± ØµØ§Ù„Ø­")
                    return
        else:
            oid = simpledialog.askinteger("Ø¥Ø±Ø¬Ø§Ø¹ ÙØ§ØªÙˆØ±Ø©", "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:")

        if not oid: return
        
        conn = sqlite3.connect(self.db_name)
        c = conn.cursor()
        c.execute("SELECT * FROM orders WHERE id=?", (oid,))
        order = c.fetchone()
        conn.close()
        
        if not order:
            messagebox.showerror("Ø®Ø·Ø£", "Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©")
            return
            
        msg = f"Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: {order[0]}\nØ§Ù„ØªØ§Ø±ÙŠØ®: {order[1]}\nØ§Ù„Ø²Ø¨ÙˆÙ†: {order[2]}\nØ§Ù„Ù‡Ø§ØªÙ: {order[3]}\n"
        msg += f"Ø§Ù„ØªÙØ§ØµÙŠÙ„: {order[5]}\nØ§Ù„Ù…Ø¨Ù„Øº: {order[6]:,.0f} Ø¯.Ø¹\nØ§Ù„Ø­Ø§Ù„Ø©: {order[8]}\n"
        
        if order[8] == "Ù…Ø±ØªØ¬Ø¹":
             messagebox.showinfo("Ù…Ø¹Ù„ÙˆÙ…Ø§Øª", msg + "\n\nâš ï¸ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹Ù‡Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹.")
             return
        if messagebox.askyesno("ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©", msg + "\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ (Ø¥Ù„ØºØ§Ø¡) Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ"):
            self.process_return(oid, order[6])
            
    def reprint_order_dialog(self, use_keypad=False):
        if use_keypad:
            dlg = CustomInputDialog(self.root, "Ø¥Ø¹Ø§Ø¯Ø© Ø·Ø¨Ø§Ø¹Ø©", "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:", input_type="numeric")
            oid = dlg.result
            if oid:
                try:
                    oid = int(oid)
                except ValueError:
                    messagebox.showerror("Ø®Ø·Ø£", "Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± ØµØ§Ù„Ø­")
                    return
        else:
            oid = simpledialog.askinteger("Ø¥Ø¹Ø§Ø¯Ø© Ø·Ø¨Ø§Ø¹Ø©", "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø·Ø¨Ø§Ø¹ØªÙ‡Ø§:")

        if not oid: return
        
        conn = sqlite3.connect(self.db_name)
        c = conn.cursor()
        c.execute("SELECT * FROM orders WHERE id=?", (oid,))
        order = c.fetchone()
        c.execute("SELECT product_name, qty, price, total, note FROM order_items WHERE order_id=?", (oid,))
        items = c.fetchall()
        conn.close()
        
        if not order:
            messagebox.showerror("Ø®Ø·Ø£", "Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©")
            return
        
        # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø³Ù„Ø© (Cart format)
        cart_items_for_print = []
        for name, qty, price, total, note in items:
             cart_items_for_print.append({"name": name, "qty": qty, "price": price, "total": total, "weight_based": False, "note": note}) # Ù„Ø§ Ù†Ø­ØªØ§Ø¬ ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙˆØ²Ù†ÙŠØ© Ù‡Ù†Ø§
        
        order_type_val = order[4]
        time_val = order[9]
        addr_val = order[10]
        self.print_receipt(
            oid=order[0],
            name=order[2],
            phone=order[3],
            order_type=order_type_val,
            time_str=time_val,
            address_str=addr_val,
            cart_items=cart_items_for_print,
            total=order[6],
            status=order[8],
            g_note=order[7],
            is_reprint=True
        )

    def process_return(self, oid, amount):
        conn = sqlite3.connect(self.db_name)
        c = conn.cursor()
        c.execute("UPDATE orders SET status='Ù…Ø±ØªØ¬Ø¹' WHERE id=?", (oid,))
        now = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        c.execute("INSERT INTO sales (date, order_id, amount, type) VALUES (?, ?, ?, ?)",
                  (now, oid, -amount, "return"))
        conn.commit()
        conn.close()
        messagebox.showinfo("Ù†Ø¬Ø§Ø­", f"ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… {oid} Ø¨Ù†Ø¬Ø§Ø­.")
        self.load_reports()
        
    def checkout(self):
        if not self.cart:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©")
            return
        phone = self.phone_var.get()
        name = self.customer_name_var.get()
        
        if len(phone) != 11 and phone != "":
              if not messagebox.askyesno("ØªÙ†Ø¨ÙŠÙ‡", "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù…). Ù…ØªØ§Ø¨Ø¹Ø©ØŸ"): return
        if not name.strip(): name = "Ø²Ø¨ÙˆÙ† Ø¹Ø§Ù…"
        
        current_order_type = self.order_type.get()
        address = self.address_var.get() if current_order_type == 'delivery' else ""
        pickup_time = self.pickup_time_var.get()
        
        conn = sqlite3.connect(self.db_name)
        c = conn.cursor()
        now = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        if phone:
            c.execute("INSERT OR REPLACE INTO customers (phone, name, address, last_order_date) VALUES (?, ?, ?, ?)", (phone, name, address, now))
        
        total_val = sum(x['total'] for x in self.cart)
        
        details_list = []
        for x in self.cart:
            item_str = f"{x['name']} ({x['qty']}{' ÙƒØºÙ…' if x['weight_based'] else ''})"
            if x['note']:
                item_str += f" [Ù…Ù„Ø§Ø­Ø¸Ø©: {x['note']}]"
            details_list.append(item_str)
        details = ", ".join(details_list)
        
        is_paid_status = self.payment_status_var.get()
        status_text = "ÙˆØ§ØµÙ„" if is_paid_status == "paid" else "ØºÙŠØ± ÙˆØ§ØµÙ„"
        general_note = self.general_notes_var.get()
        
        c.execute('''INSERT INTO orders (date, customer_name, phone, type, details, total, notes, status, pickup_time, address, payment_status)
                  VALUES (?,?,?,?,?,?,?,?,?,?,?)''',
                  (now, name, phone, current_order_type, details, total_val, general_note, status_text, pickup_time, address, is_paid_status))
        
        order_id = c.lastrowid
        
        for x in self.cart:
            c.execute("INSERT INTO order_items (order_id, product_name, qty, price, total, note) VALUES (?, ?, ?, ?, ?, ?)",
                      (order_id, x['name'], x['qty'], x['price'], x['total'], x['note']))
        
        c.execute("INSERT INTO sales (date, order_id, amount, type) VALUES (?, ?, ?, ?)", (now, order_id, total_val, "order"))
        conn.commit()
        conn.close()
        
        self.print_receipt(order_id, name, phone, current_order_type, pickup_time, address, self.cart, total_val, status_text, general_note)
        self.clear_cart()
        self.pickup_time_var.set("")
        self.customer_name_var.set("")
        self.phone_var.set("")
        
    # --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆØ²Ù†) ---
    def print_receipt(self, oid, name, phone, order_type, time_str, address_str, cart_items, total, status, g_note, is_reprint=False):
        try:
            # 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙˆØ±Ø© (Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ 80Ù…Ù… Ù‡Ùˆ Ø­ÙˆØ§Ù„ÙŠ 570 Ø¨ÙƒØ³Ù„)
            PAPER_WIDTH = 570
            
            # Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·ÙˆÙ„ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ Ù„Ù„ÙØ§ØªÙˆØ±Ø©
            items_count = len(cart_items)
            estimated_height = 400 + (items_count * 50) + 400 # Ø±Ø£Ø³ + Ø¹Ù†Ø§ØµØ± + ØªØ°ÙŠÙŠÙ„
            
            # Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ø¨ÙŠØ¶Ø§Ø¡ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
            img = Image.new('RGB', (PAPER_WIDTH, estimated_height), color='white')
            draw = ImageDraw.Draw(img)
            
            # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·ÙˆØ·
            try:
                font_path = "C:\\Windows\\Fonts\\arial.ttf"
                font_header = ImageFont.truetype(font_path, 30)
                font_bold = ImageFont.truetype(font_path, 22)
                font_reg = ImageFont.truetype(font_path, 20)
                font_small = ImageFont.truetype(font_path, 18)
            except:
                font_header = ImageFont.load_default()
                font_bold = ImageFont.load_default()
                font_reg = ImageFont.load_default()
                font_small = ImageFont.load_default()
                
            # Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø±Ø³Ù… Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ
            def draw_text_centered(text, y, font, color='black'):
                reshaped_text = arabic_reshaper.reshape(str(text))
                bidi_text = get_display(reshaped_text)
                bbox = draw.textbbox((0, 0), bidi_text, font=font)
                text_width = bbox[2] - bbox[0]
                x = (PAPER_WIDTH - text_width) / 2
                draw.text((x, y), bidi_text, font=font, fill=color)
                return y + font.size + 10
            
            def draw_text_right(text, y, font, margin=20, color='black'):
                reshaped_text = arabic_reshaper.reshape(str(text))
                bidi_text = get_display(reshaped_text)
                bbox = draw.textbbox((0, 0), bidi_text, font=font)
                text_width = bbox[2] - bbox[0]
                x = PAPER_WIDTH - margin - text_width
                draw.text((x, y), bidi_text, font=font, fill=color)
                
            def draw_text_left(text, y, font, margin=20, color='black'):
                draw.text((margin, y), str(text), font=font, fill=color)
                
            # --- Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ø±Ø³Ù… ---
            y = 20
            
            # 1. Ø§Ù„Ù„ÙˆÙƒÙˆ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            logo_path = self.settings.get('logo_path', '')
            if self.settings['receipt_design']['show_logo'] and logo_path and os.path.exists(logo_path):
                try:
                    logo = Image.open(logo_path)
                    basewidth = 200
                    wpercent = (basewidth / float(logo.size[0]))
                    hsize = int((float(logo.size[1]) * float(wpercent)))
                    logo = logo.resize((basewidth, hsize), Image.Resampling.LANCZOS)
                    img.paste(logo, (int((PAPER_WIDTH - basewidth)/2), y))
                    y += hsize + 20
                except: pass
                
            # 2. Ø±Ø£Ø³ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
            header_text = self.settings['receipt_design']['header_text']
            y = draw_text_centered(header_text, y, font_header)
            y = draw_text_centered("07736161216", y, font_bold)
            
            draw.line((20, y, PAPER_WIDTH-20, y), fill="black", width=2)
            y += 15
            
            order_type_txt = "Ø³ÙØ±ÙŠ (Ø§Ø³ØªÙ„Ø§Ù…)" if order_type == "takeaway" else "ØªÙˆØµÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ"
            draw_text_right(f"Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: {oid}", y, font_bold)
            draw_text_left(datetime.datetime.now().strftime("%I:%M %p"), y, font_small)
            y += 35
            y = draw_text_centered(f"-- {order_type_txt} --", y, font_bold)
            y += 10
            
            # 3. Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯
            draw.rectangle((10, y, PAPER_WIDTH-10, y+35), fill="#EEE")
            draw_text_right("Ø§Ù„Ù…Ø§Ø¯Ø©", y+5, font_bold, margin=30)
            draw_text_centered("Ø§Ù„ÙƒÙ…ÙŠØ©", y+5, font_bold)
            draw_text_left("Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", y+5, font_bold, margin=30)
            y += 45
            
            def draw_row(name, qty, price, total_item, note="", weight_based=False):
                nonlocal y
                
                qty_val = qty
                qty_txt = str(int(qty_val)) if qty_val == int(qty_val) else f"{qty_val:.3f}"
                
                # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒØ³ÙˆØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
                if weight_based:
                    if abs(qty_val - 0.25) < 0.01:
                        qty_txt = "1/4"
                    elif abs(qty_val - 0.5) < 0.01:
                        qty_txt = "1/2"
                    elif abs(qty_val - 0.75) < 0.01:
                        qty_txt = "3/4"
                    elif qty_val > 1:
                        int_part = int(qty_val)
                        frac_part = qty_val - int_part
                        if abs(frac_part - 0.25) < 0.01:
                            qty_txt = f"{int_part} Ùˆ 1/4"
                        elif abs(frac_part - 0.5) < 0.01:
                            qty_txt = f"{int_part} Ùˆ 1/2"
                        elif abs(frac_part - 0.75) < 0.01:
                            qty_txt = f"{int_part} Ùˆ 3/4"
                        else:
                            qty_txt = f"{qty_val:.3f}"
                
                # Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                draw_text_left(f"{total_item:,.0f}", y, font_reg, margin=30)
                
                bbox = draw.textbbox((0, 0), qty_txt, font=font_reg)
                q_w = bbox[2] - bbox[0]
                draw.text(((PAPER_WIDTH/2) - (q_w/2), y), qty_txt, font=font_reg, fill="black")
                
                # Ø§Ù„Ø§Ø³Ù…
                max_name_width = 250
                name_disp = name
                if draw.textlength(get_display(arabic_reshaper.reshape(name)), font_reg) > max_name_width:
                     name_disp = name[:25] + "..."
                draw_text_right(name_disp, y, font_reg, margin=30)
                
                y += 30
                if note:
                    draw_text_right(f"({note})", y, font_small, margin=30, color="#555")
                    y += 25
                
                draw.line((30, y, PAPER_WIDTH-30, y), fill="#DDD", width=1)
                y += 10
                
            grand_total = 0
            if isinstance(cart_items, list):
                for item in cart_items:
                    draw_row(item['name'], item['qty'], item['price'], item['total'], item.get('note', ''), item.get('weight_based', False))
                    grand_total += item['total']
            else: # ÙÙŠ Ø­Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø­ÙŠØ« Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‚Ø¯ ØªÙƒÙˆÙ† Ø³Ù„Ø³Ù„Ø© Ù†ØµÙŠØ©
                 # ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙƒØ³Ù„Ø³Ù„Ø©ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ weight_basedØŒ ÙˆÙ„ÙƒÙ† ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¹Ø±Ø¶Ù‡Ø§
                items_str = str(cart_items).split(',')
                for item_str in items_str:
                     name_part = item_str.split('(')[0].strip()
                     draw_row(name_part, "-", 0, 0, item_str) # ÙˆØ¶Ø¹ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙƒÙ†Øµ Ù…Ù„Ø§Ø­Ø¸Ø©

            # 4. Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
            y += 10
            draw.rectangle((10, y, PAPER_WIDTH-10, y+50), outline="black", width=2)
            draw_text_right("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:", y+10, font_header, margin=40)
            draw_text_left(f"{total:,.0f}", y+10, font_header, margin=40)
            y += 70
            
            draw_text_right(f"Ø§Ù„Ø²Ø¨ÙˆÙ†: {name}", y, font_bold)
            y += 30
            if phone:
                draw_text_right(f"Ù‡Ø§ØªÙ: {phone}", y, font_bold)
                y += 30
            if address_str:
                addr_reshaped = get_display(arabic_reshaper.reshape(f"Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: {address_str}"))
                draw.text((PAPER_WIDTH - 20 - draw.textlength(addr_reshaped, font_reg), y), addr_reshaped, font=font_reg, fill="black")
                y += 30
            
            if time_str:
                y += 10
                draw.rectangle((50, y, PAPER_WIDTH-50, y+40), fill="black")
                reshaped_time = get_display(arabic_reshaper.reshape(f"Ø§Ù„ÙˆÙ‚Øª: {time_str}"))
                w_time = draw.textlength(reshaped_time, font_bold)
                draw.text(((PAPER_WIDTH-w_time)/2, y+5), reshaped_time, font=font_bold, fill="white")
                y += 50
                
            if g_note:
                draw_text_centered(f"Ù…Ù„Ø§Ø­Ø¸Ø§Øª: {g_note}", y, font_small)
                y += 25
                
            # 5. Ø§Ù„ØªØ°ÙŠÙŠÙ„
            y += 20
            footer_text = self.settings['receipt_design']['footer_text']
            draw_text_centered(footer_text, y, font_reg)
            y += 40
            
            # Ù‚Øµ Ø§Ù„ØµÙˆØ±Ø©
            final_img = img.crop((0, 0, PAPER_WIDTH, y))
            self.send_image_to_printer(final_img)
            
        except Exception as e:
            messagebox.showerror("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©", str(e))
            print(e)

    # ... (Ø¨Ù‚ÙŠØ© Ø¯ÙˆØ§Ù„ RestaurantPOS)
    def generate_daily_report(self):
        try:
            conn = sqlite3.connect(self.db_name)
            c = conn.cursor()
            
            c.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='order_items'")
            if not c.fetchone():
                messagebox.showerror("ØªÙ†Ø¨ÙŠÙ‡", "Ø¬Ø¯ÙˆÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.\nÙŠØ¬Ø¨ Ø¹Ù…Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.")
                conn.close()
                return
            now_date = datetime.datetime.now().strftime("%Y-%m-%d")
            
            c.execute("SELECT COUNT(*), SUM(total) FROM orders WHERE date LIKE ? AND status != 'Ù…Ø±ØªØ¬Ø¹'", (f"{now_date}%",))
            summary = c.fetchone()
            total_orders = summary[0] if summary[0] else 0
            total_sales = summary[1] if summary[1] else 0
            
            c.execute('''
                SELECT product_name, SUM(qty), SUM(order_items.total)
                FROM order_items
                JOIN orders ON order_items.order_id = orders.id
                WHERE orders.date LIKE ? AND orders.status != 'Ù…Ø±ØªØ¬Ø¹'
                GROUP BY product_name
            ''', (f"{now_date}%",))
            
            items_summary = c.fetchall()
            conn.close()
            
            if total_orders == 0:
                messagebox.showinfo("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.")
                return
            msg = f"ØªÙ‚Ø±ÙŠØ± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙŠÙˆÙ… ({now_date})\n--------------------------------\n"
            msg += f"Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±: {total_orders}\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: {total_sales:,.0f} Ø¯.Ø¹\n--------------------------------\n"
            msg += "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠØŸ"
            
            if messagebox.askyesno("Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…", msg):
                self.print_daily_report_image(now_date, total_orders, total_sales, items_summary)
                
        except Exception as e:
            messagebox.showerror("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {str(e)}")
            
    # --- Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ ÙƒØµÙˆØ±Ø© (Ø¨Ø¯ÙˆÙ† PDF) ---
    def print_daily_report_image(self, date_str, total_orders, total_sales, items_summary):
        try:
            PAPER_WIDTH = 570
            estimated_height = 400 + (len(items_summary) * 40) + 200
            
            img = Image.new('RGB', (PAPER_WIDTH, estimated_height), color='white')
            draw = ImageDraw.Draw(img)
            
            try:
                font_path = "C:\\Windows\\Fonts\\arial.ttf"
                font_header = ImageFont.truetype(font_path, 30)
                font_bold = ImageFont.truetype(font_path, 22)
                font_reg = ImageFont.truetype(font_path, 20)
            except:
                font_header = ImageFont.load_default()
                font_bold = ImageFont.load_default()
                font_reg = ImageFont.load_default()
                
            def draw_text_centered(text, y, font, color='black'):
                reshaped_text = arabic_reshaper.reshape(str(text))
                bidi_text = get_display(reshaped_text)
                bbox = draw.textbbox((0, 0), bidi_text, font=font)
                text_width = bbox[2] - bbox[0]
                x = (PAPER_WIDTH - text_width) / 2
                draw.text((x, y), bidi_text, font=font, fill=color)
                return y + font.size + 10
            
            y = 20
            y = draw_text_centered("ØªÙ‚Ø±ÙŠØ± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙŠÙˆÙ…", y, font_header)
            y = draw_text_centered(date_str, y, font_reg)
            
            draw.line((20, y, PAPER_WIDTH-20, y), fill="black", width=2)
            y += 20
            
            reshaped_summary = get_display(arabic_reshaper.reshape(f"Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±: {total_orders}"))
            draw.text((PAPER_WIDTH - 20 - draw.textlength(reshaped_summary, font_bold), y), reshaped_summary, font=font_bold, fill="black")
            y += 30
            
            reshaped_sales = get_display(arabic_reshaper.reshape(f"Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: {total_sales:,.0f}"))
            draw.text((PAPER_WIDTH - 20 - draw.textlength(reshaped_sales, font_bold), y), reshaped_sales, font=font_bold, fill="black")
            y += 30
            
            draw.rectangle((10, y, PAPER_WIDTH-10, y+30), fill="#EEE")
            reshaped_h1 = get_display(arabic_reshaper.reshape("Ø§Ù„Ù…Ø§Ø¯Ø©"))
            draw.text((PAPER_WIDTH - 30 - draw.textlength(reshaped_h1, font_bold), y+5), reshaped_h1, font=font_bold, fill="black")
            draw.text((20, y+5), get_display(arabic_reshaper.reshape("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹")), font=font_bold, fill="black")
            y += 40
            
            for name, qty, total in items_summary:
                name_fixed = get_display(arabic_reshaper.reshape(name))
                draw.text((PAPER_WIDTH - 30 - draw.textlength(name_fixed, font_reg), y), name_fixed, font=font_reg, fill="black")
                draw.text((20, y), f"{total:,.0f}", font=font_reg, fill="black")
                draw.text(((PAPER_WIDTH/2), y), str(qty), font=font_reg, fill="gray")
                y += 30
                draw.line((20, y, PAPER_WIDTH-20, y), fill="#EEE")
                y += 5
                
            y += 20
            final_img = img.crop((0, 0, PAPER_WIDTH, y))
            self.send_image_to_printer(final_img)
            
        except Exception as e:
            messagebox.showerror("Ø®Ø·Ø£", str(e))
            
    def send_image_to_printer(self, image):
        """Ø¥Ø±Ø³Ø§Ù„ ÙƒØ§Ø¦Ù† ØµÙˆØ±Ø© PIL Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø·Ø§Ø¨Ø¹Ø© ÙˆÙŠÙ†Ø¯ÙˆØ²"""
        try:
            selected_printers = self.settings.get('printers', ["Default"])
            printer_name = selected_printers[0]
            if printer_name == "Default" or printer_name == "Default Printer":
                printer_name = win32print.GetDefaultPrinter()
            hDC = win32ui.CreateDC()
            hDC.CreatePrinterDC(printer_name)
            
            hDC.StartDoc("Receipt")
            hDC.StartPage()
            dib = ImageWin.Dib(image)
            dib.draw(hDC.GetHandleOutput(), (0, 0, image.size[0], image.size[1]))
            hDC.EndPage()
            hDC.EndDoc()
            hDC.DeleteDC()
        except Exception as e:
            messagebox.showerror("Ø®Ø·Ø£ Ø·Ø§Ø¨Ø¹Ø©", f"Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø·Ø§Ø¨Ø¹Ø©.\n{str(e)}")
            
    def build_products_tab(self):
        main_frame = tk.Frame(self.products_frame, bg=BG_MAIN_COLOR, padx=20, pady=20)
        main_frame.pack(fill='both', expand=True)
        
        side_panel = tk.Frame(main_frame, bg=PANEL_COLOR, width=350, relief='raised', bd=1, padx=15, pady=15)
        side_panel.pack(side='right', fill='y', padx=(10, 0))
        side_panel.pack_propagate(False)
        
        tk.Label(side_panel, text="â• Ø¥Ø¶Ø§ÙØ© ÙˆØ¬Ø¨Ø©", font=FONT_TITLE, bg=PANEL_COLOR, fg="white").pack(pady=(0, 20))
        
        self.p_name = tk.StringVar()
        self.p_price = tk.DoubleVar()
        self.p_weight_based = tk.BooleanVar()
        self.p_card_color = tk.StringVar(value="Ø£Ø¨ÙŠØ¶ (Ø§ÙØªØ±Ø§Ø¶ÙŠ)")
        self.p_suggestions = tk.StringVar()
        self.p_image_path = None
        
        tk.Label(side_panel, text="Ø§Ø³Ù… Ø§Ù„ÙˆØ¬Ø¨Ø©", bg=PANEL_COLOR, font=FONT_BOLD, fg="white").pack(anchor='e')
        p_name_entry = tk.Entry(side_panel, textvariable=self.p_name, font=FONT_MAIN, bg="#F9F9F9")
        p_name_entry.pack(fill='x', pady=(5, 10), ipady=5)
        p_name_entry.bind("<Button-1>", lambda e: self.open_text_keypad(self.p_name, "Ø§Ø³Ù… Ø§Ù„ÙˆØ¬Ø¨Ø©", "arabic"))
        
        tk.Label(side_panel, text="Ø§Ù„Ø³Ø¹Ø±", bg=PANEL_COLOR, font=FONT_BOLD, fg="white").pack(anchor='e')
        tk.Entry(side_panel, textvariable=self.p_price, font=FONT_MAIN, bg="#F9F9F9").pack(fill='x', pady=(5, 10), ipady=5)
        
        tk.Label(side_panel, text="Ù„ÙˆÙ† Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆØ¬Ø¨Ø© ğŸ¨", bg=PANEL_COLOR, font=FONT_BOLD, fg="white").pack(anchor='e')
        cb_colors = ttk.Combobox(side_panel, textvariable=self.p_card_color, values=list(CARD_COLORS.keys()), state="readonly", font=FONT_MAIN)
        cb_colors.pack(fill='x', pady=(5, 10))
        cb_colors.current(0)
        
        tk.Label(side_panel, text="Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§ÙØµÙ„ Ø¨ÙØ§ØµÙ„Ø©)", bg=PANEL_COLOR, font=FONT_BOLD, fg="white").pack(anchor='e')
        p_sug_entry = tk.Entry(side_panel, textvariable=self.p_suggestions, font=("Segoe UI", 10), bg="#F9F9F9")
        p_sug_entry.pack(fill='x', pady=(5, 10), ipady=5)
        p_sug_entry.bind("<Button-1>", lambda e: self.open_text_keypad(self.p_suggestions, "Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª", "arabic"))

        
        tk.Checkbutton(side_panel, text="Ø¨ÙŠØ¹ Ø¨Ø§Ù„ÙˆØ²Ù† (ÙƒØºÙ…) âš–ï¸", variable=self.p_weight_based, bg=PANEL_COLOR, font=FONT_MAIN, fg="white", selectcolor=PANEL_COLOR).pack(anchor='e', pady=10)
        
        tk.Button(side_panel, text="ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© ğŸ–¼ï¸", command=self.upload_image, bg=SECONDARY_COLOR, fg="white", font=FONT_MAIN, relief='flat').pack(fill='x', pady=5)
        self.lbl_img_path = tk.Label(side_panel, text="Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©", bg=PANEL_COLOR, fg="#DDD")
        self.lbl_img_path.pack()
        
        save_btn = tk.Button(side_panel, text="ğŸ’¾ Ø­Ù€ÙÙ€Ø¸ Ø§Ù„Ù€ÙˆØ¬Ù€Ø¨Ù€Ø©", command=self.save_product,
                             bg=SUCCESS_COLOR, fg="white", font=("Segoe UI", 20, "bold"),
                             height=1, relief='raised', bd=2, cursor="hand2")
        save_btn.pack(fill='x', pady=0)
        
        list_frame = tk.Frame(main_frame, bg=BG_MAIN_COLOR)
        list_frame.pack(side='left', fill='both', expand=True)
        
        tk.Label(list_frame, text="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©", font=FONT_TITLE, bg=BG_MAIN_COLOR, fg=TEXT_COLOR).pack(anchor='e', pady=10)
        
        cols = ('id', 'name', 'price', 'type')
        self.products_tree = ttk.Treeview(list_frame, columns=cols, show='headings')
        self.products_tree.heading('id', text='#')
        self.products_tree.heading('name', text='Ø§Ø³Ù… Ø§Ù„ÙˆØ¬Ø¨Ø©')
        self.products_tree.heading('price', text='Ø§Ù„Ø³Ø¹Ø±')
        self.products_tree.heading('type', text='Ø§Ù„Ù†ÙˆØ¹')
        
        self.products_tree.column('id', width=50, anchor='center')
        self.products_tree.pack(fill='both', expand=True)
        
        btn_frame = tk.Frame(list_frame, bg=BG_MAIN_COLOR, pady=10)
        btn_frame.pack(fill='x')
        tk.Button(btn_frame, text="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ğŸ”„", command=self.load_products_list, font=FONT_MAIN, bg="white").pack(side='right', padx=5)
        tk.Button(btn_frame, text="Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ âŒ", command=self.delete_product, font=FONT_MAIN, bg=DANGER_COLOR, fg="white").pack(side='right', padx=5)
        
        self.load_products_list()
        
    def upload_image(self):
        path = filedialog.askopenfilename(filetypes=[("Images", "*.jpg *.png *.jpeg")])
        if path:
            self.p_image_path = path
            self.lbl_img_path.config(text=os.path.basename(path))
            
    def save_product(self):
        if not self.p_name.get() or self.p_price.get() <= 0:
            messagebox.showerror("Ø®Ø·Ø£", "ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
            return
        img = None
        try:
            if self.p_image_path:
                with open(self.p_image_path, 'rb') as f: img = f.read()
        except: img = None
        
        color_hex = CARD_COLORS.get(self.p_card_color.get(), "#FFFFFF")
        suggestions_txt = self.p_suggestions.get()
        
        conn = sqlite3.connect(self.db_name)
        c = conn.cursor()
        c.execute("INSERT INTO products (name, price, image, category, weight_based, card_color, suggestions) VALUES (?,?,?,?,?,?,?)",
                  (self.p_name.get(), self.p_price.get(), img, "Ø¹Ø§Ù…", 1 if self.p_weight_based.get() else 0, color_hex, suggestions_txt))
        conn.commit()
        conn.close()
        
        self.search_var.set("")
        self.load_products_list()
        self.load_products_grid()
        
        self.p_name.set("")
        self.p_price.set(0)
        self.p_weight_based.set(False)
        self.p_suggestions.set("")
        self.p_card_color.set("Ø£Ø¨ÙŠØ¶ (Ø§ÙØªØ±Ø§Ø¶ÙŠ)")
        self.lbl_img_path.config(text="Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©")
        self.p_image_path = None
        messagebox.showinfo("ØªÙ…", "ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")
        
    def load_products_list(self):
        for i in self.products_tree.get_children(): self.products_tree.delete(i)
        conn = sqlite3.connect(self.db_name)
        c = conn.cursor()
        c.execute("SELECT id, name, price, weight_based FROM products")
        for r in c.fetchall():
            t = "ÙˆØ²Ù†" if r[3] else "Ù‚Ø·Ø¹Ø©"
            self.products_tree.insert('', 'end', values=(r[0], r[1], r[2], t))
        conn.close()
        
    def delete_product(self):
        sel = self.products_tree.selection()
        if not sel: return
        pid = self.products_tree.item(sel[0])['values'][0]
        if messagebox.askyesno("ØªØ£ÙƒÙŠØ¯", "Ø­Ø°Ù Ø§Ù„ÙˆØ¬Ø¨Ø©ØŸ"):
            conn = sqlite3.connect(self.db_name)
            conn.cursor().execute("DELETE FROM products WHERE id=?", (pid,))
            conn.commit()
            conn.close()
            self.load_products_list()
            self.load_products_grid()
            
    def build_reports_tab(self):
        main_frame = tk.Frame(self.reports_frame, bg="#E6EBEF")
        main_frame.pack(fill='both', expand=True, padx=0, pady=0)
        
        header_frame = tk.Frame(main_frame, bg="#CAD6DC", pady=10, padx=20, relief='raised', bd=1)
        header_frame.pack(fill='x')
        tk.Label(header_frame, text="ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙˆØ§ØªÙŠØ±", font=("Segoe UI", 16, "bold", "underline"), bg="#CAD6DC", fg="#333").pack(side='top', pady=(0,5))
        
        filter_frame = tk.Frame(header_frame, bg="#CAD6DC")
        filter_frame.pack(side='top', fill='x')
        
        self.report_period = tk.StringVar(value="today")
        modes = [("Ø§Ù„ÙŠÙˆÙ…", "today"), ("Ø£Ø³Ø¨ÙˆØ¹", "week"), ("Ø´Ù‡Ø±", "month"), ("Ø³Ù†Ø©", "year"), ("Ø§Ù„ÙƒÙ„", "all")]
        
        tk.Label(filter_frame, text="Ø¹Ø±Ø¶ Ø­Ø³Ø¨:", bg="#CAD6DC", font=FONT_BOLD).pack(side='right', padx=10)
        
        for txt, val in modes:
            rb = tk.Radiobutton(filter_frame, text=txt, variable=self.report_period, value=val,
                                 command=self.load_reports, bg="#CAD6DC", font=FONT_MAIN,
                                 selectcolor="white", indicatoron=0, width=8, relief='groove')
            rb.pack(side='right', padx=2)
            
        tk.Button(filter_frame, text="ØªØµØ¯ÙŠØ± ğŸ“„", command=self.export_report, bg=SUCCESS_COLOR, fg="white", font=FONT_BOLD).pack(side='left', padx=10)
        tk.Button(filter_frame, text="ØªØ­Ø¯ÙŠØ« ğŸ”„", command=self.load_reports, bg=PRIMARY_COLOR, fg="white", font=FONT_BOLD).pack(side='left', padx=10)
        
        tk.Button(filter_frame, text="Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ… (ØªÙ‚Ø±ÙŠØ± Ø¬Ø±Ø¯) ğŸ", command=self.generate_daily_report,
                  bg="#FF9800", fg="white", font=FONT_BOLD, relief='raised', bd=2).pack(side='left', padx=20)
        
        tree_frame = tk.Frame(main_frame, bg="white", padx=10, pady=10)
        tree_frame.pack(fill='both', expand=True)
        
        cols = ('seq', 'date', 'type', 'cust', 'total')
        self.report_tree = ttk.Treeview(tree_frame, columns=cols, show='headings')
        
        self.report_tree.heading('seq', text='Øª')
        self.report_tree.heading('date', text='Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª')
        self.report_tree.heading('type', text='Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨')
        self.report_tree.heading('cust', text='Ø§Ù„Ø²Ø¨ÙˆÙ†')
        self.report_tree.heading('total', text='Ø§Ù„Ù…Ø¨Ù„Øº')
        
        self.report_tree.column('seq', width=50, anchor='center')
        self.report_tree.column('date', width=150, anchor='center')
        self.report_tree.column('type', width=100, anchor='center')
        self.report_tree.column('cust', width=150, anchor='center')
        self.report_tree.column('total', width=100, anchor='center')
        
        scrollbar = ttk.Scrollbar(tree_frame, orient="vertical", command=self.report_tree.yview)
        self.report_tree.configure(yscrollcommand=scrollbar.set)
        scrollbar.pack(side='right', fill='y')
        self.report_tree.pack(fill='both', expand=True)
        
        summary_container = tk.Frame(main_frame, bg="#D5DBDB", pady=10, padx=20, relief='raised', bd=2)
        summary_container.pack(fill='x', side='bottom')
        
        net_frame = tk.Frame(summary_container, bg="#D5DBDB", borderwidth=1, relief="solid")
        net_frame.pack(side='left', padx=10, fill='y')
        tk.Label(net_frame, text="Ø§Ù„ØµØ§ÙÙŠ", bg="#95A5A6", fg="white", font=("Segoe UI", 12, "bold"), width=15).pack(fill='x')
        self.lbl_net_profit = tk.Label(net_frame, text="0", bg="white", font=("Segoe UI", 14, "bold"), fg="#2C3E50", height=2)
        self.lbl_net_profit.pack(fill='x')
        
        exp_frame = tk.Frame(summary_container, bg="#D5DBDB", borderwidth=1, relief="solid")
        exp_frame.pack(side='left', padx=10, fill='y')
        tk.Label(exp_frame, text="Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ", bg="#95A5A6", fg="white", font=("Segoe UI", 12, "bold"), width=15).pack(fill='x')
        self.lbl_expenses = tk.Label(exp_frame, text="0", bg="white", font=("Segoe UI", 14, "bold"), fg=DANGER_COLOR, height=2)
        self.lbl_expenses.pack(fill='x')
        
        disc_frame = tk.Frame(summary_container, bg="#D5DBDB", borderwidth=1, relief="solid")
        disc_frame.pack(side='left', padx=10, fill='y')
        tk.Label(disc_frame, text="Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±", bg="#95A5A6", fg="white", font=("Segoe UI", 12, "bold"), width=15).pack(fill='x')
        self.lbl_count = tk.Label(disc_frame, text="0", bg="white", font=("Segoe UI", 14, "bold"), fg="#2C3E50", height=2)
        self.lbl_count.pack(fill='x')
        
        total_frame = tk.Frame(summary_container, bg="#D5DBDB", borderwidth=1, relief="solid")
        total_frame.pack(side='left', padx=10, fill='y')
        tk.Label(total_frame, text="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº", bg="#95A5A6", fg="white", font=("Segoe UI", 12, "bold"), width=15).pack(fill='x')
        self.lbl_total_sales = tk.Label(total_frame, text="0", bg="white", font=("Segoe UI", 14, "bold"), fg=SUCCESS_COLOR, height=2)
        self.lbl_total_sales.pack(fill='x')
        
        self.load_reports()
        
    def load_reports(self):
        for i in self.report_tree.get_children(): self.report_tree.delete(i)
        conn = sqlite3.connect(self.db_name)
        c = conn.cursor()
        
        period = self.report_period.get()
        now = datetime.datetime.now()
        
        query = "SELECT id, date, type, customer_name, total, status FROM orders WHERE 1=1"
        params = []
        
        if period == "today":
            date_filter = now.strftime("%Y-%m-%d")
            query += " AND date LIKE ?"
            params.append(f"{date_filter}%")
        elif period == "week":
            d = (now - datetime.timedelta(days=7)).strftime("%Y-%m-%d")
            query += " AND date >= ?"
            params.append(d)
        elif period == "month":
            d = (now - datetime.timedelta(days=30)).strftime("%Y-%m-%d")
            query += " AND date >= ?"
            params.append(d)
        elif period == "year":
            d = (now - datetime.timedelta(days=365)).strftime("%Y-%m-%d")
            query += " AND date >= ?"
            params.append(d)
        
        query += " ORDER BY id DESC"
        
        c.execute(query, params)
        rows = c.fetchall()
        
        total_sum = 0
        count = 0
        
        for idx, r in enumerate(rows):
            t_type = "Ø³ÙØ±ÙŠ" if r[2] == "takeaway" else "ØªÙˆØµÙŠÙ„"
            if r[5] == "Ù…Ø±ØªØ¬Ø¹": t_type += " (Ù…Ø±ØªØ¬Ø¹)"
            
            self.report_tree.insert('', 'end', values=(r[0], r[1][:16], t_type, r[3], f"{r[4]:,.0f}"))
            
            if r[5] != "Ù…Ø±ØªØ¬Ø¹":
                total_sum += r[4]
            count += 1
            
        conn.close()
        
        self.lbl_total_sales.config(text=f"{total_sum:,.0f}")
        self.lbl_count.config(text=str(count))
        self.lbl_net_profit.config(text=f"{total_sum:,.0f}")
        self.lbl_expenses.config(text="0")
        
    def export_report(self):
        path = filedialog.asksaveasfilename(defaultextension=".txt")
        if path:
            with open(path, 'w', encoding='utf-8') as f:
                f.write("ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª\n")
                f.write(f"Ø§Ù„ÙØªØ±Ø©: {self.report_period.get()}\n")
                f.write("-" * 50 + "\n")
                for item in self.report_tree.get_children():
                    vals = self.report_tree.item(item)['values']
                    f.write(f"{vals}\n")
                f.write("-" * 50 + "\n")
                f.write(f"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: {self.lbl_total_sales.cget('text')}\n")
            messagebox.showinfo("ØªÙ…", "ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±")
            
    def build_settings_tab(self):
        frame = tk.Frame(self.settings_frame, bg=BG_MAIN_COLOR, padx=30, pady=30)
        frame.pack(fill='both', expand=True)
        
        p_frame = tk.LabelFrame(frame, text=" Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø§Ø¨Ø¹Ø§Øª ", font=FONT_BOLD, bg=BG_MAIN_COLOR, padx=20, pady=20)
        p_frame.pack(fill='x', pady=10)
        
        try:
            printers = [p[2] for p in win32print.EnumPrinters(win32print.PRINTER_ENUM_LOCAL)]
        except: printers = ["Default"]
        
        self.printer_list = tk.Listbox(p_frame, selectmode='single', height=6, font=FONT_MAIN)
        self.printer_list.pack(fill='x', pady=5)
        for p in printers: self.printer_list.insert('end', p)
        
        tk.Button(p_frame, text="Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙƒØ·Ø§Ø¨Ø¹Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± ğŸ’¾", command=self.save_printers, bg=PRIMARY_COLOR, fg="white", font=FONT_MAIN).pack(pady=5)
        
        r_frame = tk.LabelFrame(frame, text=" ØªØµÙ…ÙŠÙ… Ø§Ù„ÙØ§ØªÙˆØ±Ø© ", font=FONT_BOLD, bg=BG_MAIN_COLOR, padx=20, pady=20)
        r_frame.pack(fill='x', pady=10)
        
        tk.Label(r_frame, text="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø©", bg=BG_MAIN_COLOR).pack(anchor='e')
        self.h_text = tk.Entry(r_frame, font=FONT_MAIN)
        self.h_text.insert(0, self.settings['receipt_design']['header_text'])
        self.h_text.pack(fill='x')
        
        tk.Label(r_frame, text="ØªØ°ÙŠÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©", bg=BG_MAIN_COLOR).pack(anchor='e')
        self.f_text = tk.Entry(r_frame, font=FONT_MAIN)
        self.f_text.insert(0, self.settings['receipt_design']['footer_text'])
        self.f_text.pack(fill='x')
        
        tk.Button(r_frame, text="Ø§Ø®ØªÙŠØ§Ø± Ø´Ø¹Ø§Ø±", command=self.choose_logo, bg=SECONDARY_COLOR, fg="white").pack(pady=5)
        self.s_logo_lbl = tk.Label(r_frame, text=self.settings['logo_path'], bg=BG_MAIN_COLOR)
        self.s_logo_lbl.pack()
        
        tk.Button(r_frame, text="Ø­ÙØ¸ Ø§Ù„ØªØµÙ…ÙŠÙ… ğŸ’¾", command=self.save_design, bg=SUCCESS_COLOR, fg="white", font=FONT_BOLD).pack(pady=10)
        
    def save_printers(self):
        idxs = self.printer_list.curselection()
        if not idxs:
             messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ø¨Ø¹Ø© Ø£ÙˆÙ„Ø§Ù‹")
             return
        
        selected_printer = self.printer_list.get(idxs[0])
        self.settings['printers'] = [selected_printer]
        self.save_settings()
        messagebox.showinfo("ØªÙ…", f"ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ø§Ø¨Ø¹Ø©: {selected_printer}")
        
    def choose_logo(self):
        p = filedialog.askopenfilename()
        if p:
            self.settings['logo_path'] = p
            self.s_logo_lbl.config(text=p)
            
    def save_design(self):
        self.settings['receipt_design']['header_text'] = self.h_text.get()
        self.settings['receipt_design']['footer_text'] = self.f_text.get()
        self.save_settings()
        messagebox.showinfo("ØªÙ…", "Ø­ÙØ¸ Ø§Ù„ØªØµÙ…ÙŠÙ…")

def start_app():
    root = tk.Tk()
    app = RestaurantPOS(root)
    root.mainloop()
    
if __name__ == "__main__":
    l_root = tk.Tk()
    LoginWindow(l_root, start_app)
    l_root.mainloop()
