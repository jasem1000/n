<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام أوسكار لإدارة الصيدليات - نسخة متكاملة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --header-color: #007bff;
            --background-color: #f4f6f9;
            --button-color: #28a745;
            --accent-color: #17a2b8;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --main-font: 'Cairo', sans-serif;
            --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.07);
            --shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.1);
            --border-radius-medium: 12px;
            --transition-fast: 0.2s ease;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--main-font);
            background-color: var(--background-color);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius-medium);
            box-shadow: var(--shadow-medium);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--button-color);
        }
        .header h1 { color: var(--header-color); font-size: 28px; font-weight: 700; }

        .action-buttons { display: flex; justify-content: center; gap: 15px; margin: 25px 0; flex-wrap: wrap; }

        .btn {
            padding: 12px 24px; border: none; border-radius: 30px; font-size: 15px; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all var(--transition-fast);
            box-shadow: var(--shadow-light);
        }
        .btn:hover { transform: translateY(-3px); box-shadow: var(--shadow-medium); }
        .btn-success { background: linear-gradient(135deg, var(--button-color) 0%, #2E7D32 100%); color: white; }
        .btn-info { background: linear-gradient(135deg, var(--accent-color) 0%, #117a8b 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger-color) 0%, #b71c1c 100%); color: white; }
        .btn-primary { background: linear-gradient(135deg, var(--header-color) 0%, #0056b3 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--warning-color) 0%, #ff8f00 100%); color: #212529;}

        .pos-interface { display: grid; grid-template-columns: 1fr; gap: 30px; }
        .invoice-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; background-color: #f8f9fa; border-radius: var(--border-radius-medium); border: 1px solid #dee2e6; }
        .info-item { display: flex; flex-direction: column; }
        .info-item label { font-weight: 600; color: #555; margin-bottom: 5px; }
        .info-item input { padding: 8px 12px; border: 1px solid #ccc; border-radius: 8px; font-family: var(--main-font); }

        .scanner-area { margin: 20px 0; }
        .scanner-area label { font-size: 18px; font-weight: 600; margin-bottom: 10px; display: block; text-align: center; }
        #barcode-input { width: 100%; padding: 15px 20px; font-size: 20px; text-align: center; border: 2px dashed var(--button-color); border-radius: var(--border-radius-medium); transition: all var(--transition-fast); }
        #barcode-input:focus { outline: none; border-style: solid; box-shadow: 0 0 10px rgba(40, 167, 69, 0.3); }

        .sales-cart table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .sales-cart th, .sales-cart td { padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; }
        .sales-cart th { background-color: #e9ecef; font-weight: 700; }
        .sales-cart .quantity-input { width: 70px; text-align: center; padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
        .sales-cart .delete-item-btn { color: var(--danger-color); cursor: pointer; background: none; border: none; font-size: 18px; }

        .total-section { margin-top: 20px; padding-top: 20px; border-top: 2px solid #333; text-align: left; font-size: 22px; font-weight: 700; }
        #total-amount { color: var(--button-color); }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); padding-top: 60px; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 900px; border-radius: var(--border-radius-medium); }
        .close { color: #aaa; float: left; font-size: 30px; font-weight: bold; cursor: pointer; }
        
        .modal-tabs { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 20px; }
        .modal-tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        .modal-tab.active { border-bottom-color: var(--header-color); font-weight: 700; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select { padding: 10px; border: 1px solid #ccc; border-radius: 8px; }

        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { padding: 10px; text-align: center; border: 1px solid #dee2e6; }
        .data-table th { background-color: #e9ecef; }
        .data-table .actions-cell .btn { padding: 5px 10px; font-size: 14px; border-radius: 8px; }

        .report-section { margin-bottom: 30px; }
        .report-section h3 { border-bottom: 2px solid var(--accent-color); padding-bottom: 10px; margin-bottom: 15px; }
        .report-section .print-btn { margin-top: 10px; display: block; width: fit-content; margin-right: auto; margin-left: auto; }

        .sales-stats { text-align: center; font-size: 18px; }
        .sales-stats p { margin: 10px 0; font-weight: bold; }

        /* تحسينات للطباعة */
        @media print {
            .no-print { display: none !important; }
            body, .container { padding: 0; margin: 0; box-shadow: none; background: white; }
            .header { border-bottom: none; margin-bottom: 10px; }
            .header h1 { font-size: 24px; }
            .invoice-details { grid-template-columns: repeat(3, 1fr); padding: 10px; border: none; background: none; }
            .info-item input { border: none; background: none; padding: 0; font-weight: bold; }
            .scanner-area { display: none; }
            .sales-cart table { border: 1px solid #000; }
            .sales-cart th, .sales-cart td { border: 1px solid #000; padding: 8px; }
            .sales-cart th { background: #f0f0f0; }
            .total-section { border-top: 1px solid #000; padding-top: 10px; font-size: 18px; text-align: center; }
            .footer-print { display: block; text-align: center; margin-top: 20px; font-size: 12px; color: #555; }
            .container { max-width: 100%; border: 1px solid #000; padding: 20px; }
            .modal { display: none; } /* إخفاء النوافذ أثناء الطباعة العامة */
            .print-content { display: block !important; background: white; padding: 20px; border: 1px solid #000; }
            .print-content h3 { text-align: center; font-size: 20px; margin-bottom: 15px; }
            .print-content .report-date { text-align: center; font-size: 14px; margin-bottom: 20px; color: #555; }
            .print-content table { border-collapse: collapse; width: 100%; margin: 0 auto; }
            .print-content th, .print-content td { border: 1px solid #000; padding: 10px; text-align: center; }
            .print-content th { background-color: #e9ecef; }
            .print-content .sales-stats p { text-align: center; font-size: 16px; margin: 10px 0; }
            
            /* تحسينات طباعة التقارير */
            .print-report { display: block !important; }
            .print-report-header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #333; }
            .print-report-header h2 { font-size: 22px; margin-bottom: 5px; }
            .print-report-header .report-info { display: flex; justify-content: space-between; margin-top: 10px; }
            .print-report-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
            .print-report-table th { background-color: #f0f0f0; font-weight: bold; padding: 10px; border: 1px solid #000; }
            .print-report-table td { padding: 8px; border: 1px solid #000; }
            .print-report-summary { margin-top: 20px; padding-top: 15px; border-top: 1px solid #333; }
            .print-report-footer { text-align: center; margin-top: 30px; font-size: 12px; color: #555; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-pills"></i> نظام أوسكار لإدارة الصيدليات</h1>
        </div>
        
        <div class="action-buttons no-print">
            <button class="btn btn-success" onclick="completeSale()"><i class="fas fa-check-circle"></i> إتمام البيع</button>
            <button class="btn btn-primary" onclick="printReceipt()"><i class="fas fa-print"></i> طباعة الفاتورة</button>
            <button class="btn btn-info" onclick="openInventoryManager()"><i class="fas fa-boxes"></i> إدارة المخزون</button>
            <button class="btn btn-warning" onclick="openReportsModal()"><i class="fas fa-chart-line"></i> تقارير المنتجات</button>
            <button class="btn btn-primary" onclick="openSalesStatsModal()"><i class="fas fa-chart-bar"></i> إحصائيات البيع</button>
            <button class="btn btn-danger" onclick="clearCart()"><i class="fas fa-trash"></i> فاتورة جديدة</button>
        </div>

        <div class="pos-interface">
            <div class="invoice-details">
                <div class="info-item"><label for="invoice-number">رقم الفاتورة</label><input type="text" id="invoice-number" readonly></div>
                <div class="info-item"><label for="invoice-date">التاريخ</label><input type="text" id="invoice-date" readonly></div>
                <div class="info-item"><label for="customer-name">اسم العميل</label><input type="text" id="customer-name" placeholder="عميل نقدي"></div>
            </div>
            <div class="scanner-area no-print">
                <label for="barcode-input"><i class="fas fa-barcode"></i> امسح الباركود أو ابحث بالاسم...</label>
                <input type="text" id="barcode-input" autocomplete="off">
            </div>
            <div class="sales-cart">
                <table>
                    <thead><tr><th>م.</th><th>اسم المنتج</th><th>الكمية</th><th>سعر الوحدة</th><th>الإجمالي</th><th class="no-print">حذف</th></tr></thead>
                    <tbody id="cart-items"></tbody>
                </table>
            </div>
            <div class="total-section"><span>المبلغ الإجمالي: </span><span id="total-amount">0.00 IQD</span></div>
        </div>
        <div class="footer-print no-print" style="display: none;">شكراً لزيارتكم - نظام أوسكار</div>
    </div>

    <!-- نافذة إدارة المخزون -->
    <div id="inventoryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('inventoryModal')">&times;</span>
            <h2><i class="fas fa-boxes"></i> إدارة المنتجات والمخزون</h2>
            <div class="modal-tabs">
                <div class="modal-tab active" onclick="switchTab(event, 'productListTab')">قائمة المنتجات</div>
                <div class="modal-tab" onclick="switchTab(event, 'addProductTab')">إضافة منتج جديد</div>
                <div class="modal-tab" onclick="switchTab(event, 'addStockTab')">إضافة مخزون</div>
            </div>
            
            <div id="productListTab" class="tab-content active">
                <h3>قائمة جميع المنتجات</h3>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="data-table">
                        <thead><tr><th>الباركود</th><th>الاسم</th><th>سعر البيع</th><th>الكمية الإجمالية</th><th class="no-print">إجراءات</th></tr></thead>
                        <tbody id="product-list-body"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="addProductTab" class="tab-content">
                <h3>إضافة منتج جديد</h3>
                <form id="add-product-form" class="form-grid">
                    <div class="form-group"><label>اسم المنتج</label><input type="text" id="product-name" required></div>
                    <div class="form-group"><label>الباركود</label><input type="text" id="product-barcode" required></div>
                    <div class="form-group"><label>سعر البيع (دينار)</label><input type="number" id="product-selling-price" required></div>
                    <div class="form-group"><label>سعر الشراء (دينار)</label><input type="number" id="product-cost-price"></div>
                    <div class="form-group"><label>حد التنبيه للمخزون المنخفض</label><input type="number" id="product-low-stock" value="10"></div>
                </form>
                <br>
                <button class="btn btn-success" onclick="saveNewProduct()">حفظ المنتج</button>
            </div>
            
            <div id="addStockTab" class="tab-content">
                <h3>إضافة مخزون لمنتج موجود</h3>
                <form id="add-stock-form" class="form-grid">
                    <div class="form-group"><label>اختر المنتج</label><select id="stock-product-select" required></select></div>
                    <div class="form-group"><label>الكمية المضافة</label><input type="number" id="stock-quantity" required></div>
                    <div class="form-group"><label>تاريخ انتهاء الصلاحية</label><input type="date" id="stock-expiry" required></div>
                </form>
                <br>
                <button class="btn btn-success" onclick="saveStock()">إضافة للمخزون</button>
            </div>
        </div>
    </div>
    
    <!-- نافذة تقارير المنتجات -->
    <div id="reportsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('reportsModal')">&times;</span>
            <h2><i class="fas fa-chart-line"></i> تقارير المنتجات والتنبيهات</h2>
            <div class="modal-tabs">
                <div class="modal-tab active" onclick="switchTab(event, 'expiringTab')">منتجات قاربت على الانتهاء</div>
                <div class="modal-tab" onclick="switchTab(event, 'lowStockTab')">منتجات قاربت على النفاذ</div>
            </div>

            <div id="expiringTab" class="tab-content active">
                <div class="report-section">
                    <h3><i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i> منتجات قاربت صلاحيتها على الانتهاء (90 يومًا)</h3>
                    <div style="max-height: 200px; overflow-y: auto;">
                        <table class="data-table">
                            <thead><tr><th>المنتج</th><th>الباركود</th><th>الكمية</th><th>تاريخ الانتهاء</th><th>الأيام المتبقية</th></tr></thead>
                            <tbody id="expiring-products-body"></tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary print-btn no-print" onclick="printExpiringReport()"><i class="fas fa-print"></i> طباعة التقرير</button>
                </div>
            </div>

            <div id="lowStockTab" class="tab-content">
                <div class="report-section">
                    <h3><i class="fas fa-battery-empty" style="color: var(--warning-color);"></i> منتجات وصلت لحد المخزون المنخفض</h3>
                    <div style="max-height: 200px; overflow-y: auto;">
                        <table class="data-table">
                            <thead><tr><th>المنتج</th><th>الباركود</th><th>الكمية المتبقية</th><th>الحد الأدنى</th><th>الحالة</th></tr></thead>
                            <tbody id="low-stock-products-body"></tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary print-btn no-print" onclick="printLowStockReport()"><i class="fas fa-print"></i> طباعة التقرير</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- نافذة إحصائيات البيع -->
    <div id="salesStatsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('salesStatsModal')">&times;</span>
            <h2><i class="fas fa-chart-bar"></i> إحصائيات المبيعات</h2>
            
            <div class="report-section">
                <h3><i class="fas fa-chart-bar" style="color: var(--accent-color);"></i> إحصائيات المبيعات</h3>
                <div class="sales-stats">
                    <p id="daily-sales-text"></p>
                    <p id="monthly-sales-text"></p>
                    <p id="yearly-sales-text"></p>
                    <p id="total-sales-text"></p>
                </div>
                <button class="btn btn-primary print-btn no-print" onclick="printSalesStats()"><i class="fas fa-print"></i> طباعة الإحصائيات</button>
                <button class="btn btn-danger no-print" onclick="deleteSalesStats()"><i class="fas fa-trash"></i> حذف جميع الإحصائيات</button>
            </div>
        </div>
    </div>

    <!-- محتوى طباعة مخفي -->
    <div id="print-content" class="print-content" style="display: none;">
        <div class="header">
            <h1><i class="fas fa-pills"></i> نظام أوسكار لإدارة الصيدليات</h1>
        </div>
        <div id="print-body"></div>
        <div class="footer-print">شكراً لزيارتكم - نظام أوسكار</div>
    </div>
    
    <!-- محتوى طباعة التقارير -->
    <div id="print-report" class="print-report" style="display: none;">
        <div id="print-report-body"></div>
    </div>
    
    <script>
    const DB_NAME = 'PharmacyDB_Full';
    const DB_VERSION = 1;
    let db;

    // تهيئة قاعدة البيانات والتطبيق
    async function initDb() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = e => reject("Database error: " + e.target.errorCode);
            request.onupgradeneeded = e => {
                db = e.target.result;
                const productsStore = db.createObjectStore('products', { keyPath: 'id', autoIncrement: true });
                productsStore.createIndex('barcode', 'barcode', { unique: true });
                productsStore.createIndex('name_lower', 'name_lower', { unique: false });
                
                const inventoryStore = db.createObjectStore('inventory', { keyPath: 'id', autoIncrement: true });
                inventoryStore.createIndex('productId', 'productId', { unique: false });
                inventoryStore.createIndex('expiryDate', 'expiryDate', { unique: false });
                
                const salesStore = db.createObjectStore('sales', { keyPath: 'id', autoIncrement: true });
                salesStore.createIndex('date', 'date', { unique: false });
            };
            request.onsuccess = e => { db = e.target.result; resolve(db); };
        });
    }

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            await initDb();
            setInvoiceInfo();
            document.getElementById('barcode-input').focus();
            setupKeyboardShortcuts();
        } catch (error) {
            console.error("Failed to initialize:", error);
            alert("فشل تشغيل قاعدة البيانات.");
        }
    });

    function setupKeyboardShortcuts() {
        document.addEventListener('keydown', (event) => {
            if (event.key === '1' && event.target.tagName.toLowerCase() !== 'input' && event.target.tagName.toLowerCase() !== 'textarea') {
                openSalesStatsModal();
            }
        });
    }

    // إدارة نوافذ Modal وال Tabs
    function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
    function switchTab(event, tabName) {
        const parent = event.target.closest('.modal-content');
        parent.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        parent.querySelectorAll('.modal-tab').forEach(mt => mt.classList.remove('active'));
        parent.querySelector('#' + tabName).classList.add('active');
        event.target.classList.add('active');
    }

    // واجهة نقطة البيع (POS)
    const barcodeInput = document.getElementById('barcode-input');
    const cartItemsContainer = document.getElementById('cart-items');

    barcodeInput.addEventListener('change', async function(event) {
        const query = this.value.trim();
        if (query) {
            const transaction = db.transaction('products', 'readonly');
            let request = transaction.objectStore('products').index('barcode').get(query);
            request.onsuccess = e => {
                if (e.target.result) {
                    addProductToCart(e.target.result);
                } else {
                    let nameRequest = transaction.objectStore('products').index('name_lower').get(query.toLowerCase());
                    nameRequest.onsuccess = ne => {
                        if (ne.target.result) {
                            addProductToCart(ne.target.result);
                        } else {
                            alert(`المنتج غير موجود!`);
                        }
                    };
                }
            };
            this.value = ''; 
            this.focus();
        }
    });

    async function addProductToCart(product) {
        const existingRow = cartItemsContainer.querySelector(`tr[data-product-id='${product.id}']`);
        if (existingRow) {
            const quantityInput = existingRow.querySelector('.quantity-input');
            quantityInput.value = parseInt(quantityInput.value) + 1;
        } else {
            const totalStock = await getTotalStock(product.id);
            if (totalStock <= 0) {
                alert(`المنتج ${product.name} غير متوفر في المخزون!`);
                return;
            }
            const row = cartItemsContainer.insertRow();
            row.dataset.productId = product.id;
            row.innerHTML = `<td>${cartItemsContainer.rows.length}</td><td>${product.name}</td><td><input type="number" class="quantity-input" value="1" min="1" max="${totalStock}"></td><td class="unit-price">${product.sellingPrice.toFixed(2)}</td><td class="total-price">${product.sellingPrice.toFixed(2)}</td><td class="no-print"><button class="delete-item-btn" onclick="deleteCartItem(this)"><i class="fas fa-times-circle"></i></button></td>`;
        }
        updateTotals();
    }
    
    function updateTotals() {
        let total = 0;
        cartItemsContainer.querySelectorAll('tr').forEach(row => {
            const quantity = parseInt(row.querySelector('.quantity-input').value) || 0;
            const unitPrice = parseFloat(row.querySelector('.unit-price').textContent) || 0;
            const rowTotal = quantity * unitPrice;
            row.querySelector('.total-price').textContent = rowTotal.toFixed(2);
            total += rowTotal;
        });
        document.getElementById('total-amount').textContent = `${total.toFixed(2)} IQD`;
    }

    cartItemsContainer.addEventListener('input', e => { if (e.target.classList.contains('quantity-input')) updateTotals(); });
    function deleteCartItem(button) { button.closest('tr').remove(); updateTotals(); }
    function clearCart() { cartItemsContainer.innerHTML = ''; document.getElementById('customer-name').value = ''; updateTotals(); setInvoiceInfo(); barcodeInput.focus(); }
    function printReceipt() { 
        document.querySelector('.footer-print').style.display = 'block';
        window.print(); 
        document.querySelector('.footer-print').style.display = 'none';
    }
    function setInvoiceInfo(){ document.getElementById('invoice-date').value = new Date().toLocaleDateString('ar-IQ'); document.getElementById('invoice-number').value = `INV-${Date.now()}`; }

    // وظيفة إتمام البيع (المنطق الكامل)
    async function completeSale() {
        const cartRows = cartItemsContainer.querySelectorAll('tr');
        if (cartRows.length === 0) return alert('سلة المبيعات فارغة!');

        const transaction = db.transaction(['inventory', 'sales'], 'readwrite');
        const inventoryStore = transaction.objectStore('inventory');
        const salesStore = transaction.objectStore('sales');
        const itemsToProcess = Array.from(cartRows).map(row => ({
            productId: parseInt(row.dataset.productId),
            quantity: parseInt(row.querySelector('.quantity-input').value),
            name: row.cells[1].textContent,
            priceAtSale: parseFloat(row.querySelector('.unit-price').textContent)
        }));

        try {
            for (const item of itemsToProcess) {
                const stockEntries = await getProductStock(inventoryStore, item.productId);
                let totalStock = stockEntries.reduce((sum, entry) => sum + entry.quantity, 0);
                if (totalStock < item.quantity) throw new Error(`كمية غير كافية للمنتج: ${item.name}. المتوفر: ${totalStock}`);

                let remainingQtyToDeduct = item.quantity;
                for (const entry of stockEntries) {
                    if (remainingQtyToDeduct <= 0) break;
                    const deductAmount = Math.min(remainingQtyToDeduct, entry.quantity);
                    entry.quantity -= deductAmount;
                    remainingQtyToDeduct -= deductAmount;
                    if (entry.quantity > 0) {
                        inventoryStore.put(entry);
                    } else {
                        inventoryStore.delete(entry.id);
                    }
                }
            }
            // All stock checks passed and updated, now save the sale
            const saleRecord = {
                date: new Date(),
                invoiceNumber: document.getElementById('invoice-number').value,
                customerName: document.getElementById('customer-name').value || 'عميل نقدي',
                totalAmount: parseFloat(document.getElementById('total-amount').textContent),
                itemsSold: itemsToProcess
            };
            salesStore.add(saleRecord);

            transaction.oncomplete = () => { alert('تمت عملية البيع بنجاح!'); clearCart(); };
            transaction.onerror = (e) => { alert('فشل حفظ الفاتورة! ' + e.target.error); };

        } catch (error) {
            alert('خطأ في إتمام البيع: ' + error.message);
            transaction.abort();
        }
    }

    function getProductStock(store, productId) {
        return new Promise((resolve, reject) => {
            const request = store.index('productId').getAll(productId);
            request.onsuccess = e => resolve(e.target.result.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate))); // FEFO
            request.onerror = e => reject(e.target.error);
        });
    }

    async function getTotalStock(productId) {
        const tx = db.transaction('inventory', 'readonly');
        const inventory = await new Promise(res => tx.objectStore('inventory').index('productId').getAll(productId).onsuccess = e => res(e.target.result));
        return inventory.reduce((sum, i) => sum + i.quantity, 0);
    }

    // إدارة المخزون
    async function openInventoryManager() {
        document.getElementById('inventoryModal').style.display = 'block';
        await renderProductList();
        await populateProductSelect();
    }

    async function renderProductList() {
        const tx = db.transaction(['products', 'inventory'], 'readonly');
        const products = await new Promise((res) => tx.objectStore('products').getAll().onsuccess = e => res(e.target.result));
        const inventory = await new Promise((res) => tx.objectStore('inventory').getAll().onsuccess = e => res(e.target.result));
        const productListBody = document.getElementById('product-list-body');
        productListBody.innerHTML = '';
        
        products.forEach(p => {
            const totalStock = inventory.filter(i => i.productId === p.id).reduce((sum, i) => sum + i.quantity, 0);
            const row = productListBody.insertRow();
            row.innerHTML = `<td>${p.barcode}</td><td>${p.name}</td><td>${p.sellingPrice}</td><td>${totalStock}</td><td class="no-print actions-cell"><button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">حذف</button></td>`;
        });
    }

    async function deleteProduct(productId) {
        if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) return;
        const tx = db.transaction(['products', 'inventory'], 'readwrite');
        await tx.objectStore('products').delete(productId);
        const inventoryCursor = tx.objectStore('inventory').index('productId').openCursor(productId);
        inventoryCursor.onsuccess = e => {
            const cursor = e.target.result;
            if (cursor) { cursor.delete(); cursor.continue(); }
        };
        tx.oncomplete = () => renderProductList();
    }

    async function populateProductSelect() {
        const products = await new Promise((res) => db.transaction('products', 'readonly').objectStore('products').getAll().onsuccess = e => res(e.target.result));
        const select = document.getElementById('stock-product-select');
        select.innerHTML = '<option value="">اختر منتج...</option>';
        products.forEach(p => select.innerHTML += `<option value="${p.id}">${p.name}</option>`);
    }

    async function saveNewProduct() {
        const name = document.getElementById('product-name').value.trim();
        const barcode = document.getElementById('product-barcode').value.trim();
        if (!name || !barcode) return alert('الاسم والباركود حقول إلزامية!');

        const newProduct = {
            name: name,
            name_lower: name.toLowerCase(),
            barcode: barcode,
            sellingPrice: parseFloat(document.getElementById('product-selling-price').value) || 0,
            costPrice: parseFloat(document.getElementById('product-cost-price').value) || 0,
            lowStockThreshold: parseInt(document.getElementById('product-low-stock').value) || 10
        };

        const tx = db.transaction('products', 'readwrite');
        tx.objectStore('products').add(newProduct);
        tx.oncomplete = () => { alert('تم حفظ المنتج بنجاح'); document.getElementById('add-product-form').reset(); openInventoryManager(); };
        tx.onerror = (e) => alert('فشل حفظ المنتج! قد يكون الباركود مكرر. ' + e.target.error);
    }

    async function saveStock() {
        const newStock = {
            productId: parseInt(document.getElementById('stock-product-select').value),
            quantity: parseInt(document.getElementById('stock-quantity').value),
            expiryDate: document.getElementById('stock-expiry').value
        };
        if (!newStock.productId || !newStock.quantity || !newStock.expiryDate) return alert('جميع الحقول مطلوبة!');

        const tx = db.transaction('inventory', 'readwrite');
        tx.objectStore('inventory').add(newStock);
        tx.oncomplete = () => { alert('تمت إضافة المخزون بنجاح'); document.getElementById('add-stock-form').reset(); openInventoryManager(); };
        tx.onerror = (e) => alert('فشل إضافة المخزون. ' + e.target.error);
    }

    // تقارير المنتجات
    async function openReportsModal() {
        document.getElementById('reportsModal').style.display = 'block';
        await generateExpiringSoonReport();
        await generateLowStockReport();
    }

    async function generateExpiringSoonReport() {
        const tx = db.transaction(['inventory', 'products'], 'readonly');
        const inventoryStore = tx.objectStore('inventory');
        const productsStore = tx.objectStore('products');
        const expiringBody = document.getElementById('expiring-products-body');
        expiringBody.innerHTML = '';

        const thresholdDate = new Date();
        thresholdDate.setDate(thresholdDate.getDate() + 90);
        
        const entries = await new Promise((res) => {
            let results = [];
            inventoryStore.openCursor().onsuccess = e => {
                const cursor = e.target.result;
                if (cursor) {
                    if (new Date(cursor.value.expiryDate) <= thresholdDate) results.push(cursor.value);
                    cursor.continue();
                } else {
                    res(results);
                }
            };
        });

        for (const entry of entries) {
            const product = await new Promise((res) => productsStore.get(entry.productId).onsuccess = e => res(e.target.result));
            if (product) {
                const daysRemaining = Math.ceil((new Date(entry.expiryDate) - new Date()) / (1000 * 60 * 60 * 24));
                const row = expiringBody.insertRow();
                row.innerHTML = `<td>${product.name}</td><td>${product.barcode}</td><td>${entry.quantity}</td><td>${entry.expiryDate}</td><td>${daysRemaining} يوم</td>`;
            }
        }
    }

    async function generateLowStockReport() {
        const tx = db.transaction(['products', 'inventory'], 'readonly');
        const products = await new Promise((res) => tx.objectStore('products').getAll().onsuccess = e => res(e.target.result));
        const inventory = await new Promise((res) => tx.objectStore('inventory').getAll().onsuccess = e => res(e.target.result));
        const lowStockBody = document.getElementById('low-stock-products-body');
        lowStockBody.innerHTML = '';
        
        products.forEach(p => {
            const totalStock = inventory.filter(i => i.productId === p.id).reduce((sum, i) => sum + i.quantity, 0);
            if (totalStock <= p.lowStockThreshold) {
                const status = totalStock === 0 ? '<span style="color: red;">منتهي</span>' : 
                              totalStock <= Math.floor(p.lowStockThreshold / 2) ? '<span style="color: orange;">منخفض جداً</span>' : 
                              '<span style="color: var(--warning-color);">منخفض</span>';
                const row = lowStockBody.insertRow();
                row.innerHTML = `<td>${p.name}</td><td>${p.barcode}</td><td>${totalStock}</td><td>${p.lowStockThreshold}</td><td>${status}</td>`;
            }
        });
    }

    // إحصائيات البيع
    async function openSalesStatsModal() {
        document.getElementById('salesStatsModal').style.display = 'block';
        await generateSalesStats();
    }

    async function generateSalesStats() {
        const sales = await new Promise((res) => db.transaction('sales', 'readonly').objectStore('sales').getAll().onsuccess = e => res(e.target.result));
        
        const now = new Date();
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const yearStart = new Date(now.getFullYear(), 0, 1);

        const dailySales = sales.filter(s => new Date(s.date) >= todayStart).reduce((sum, s) => sum + s.totalAmount, 0);
        const monthlySales = sales.filter(s => new Date(s.date) >= monthStart).reduce((sum, s) => sum + s.totalAmount, 0);
        const yearlySales = sales.filter(s => new Date(s.date) >= yearStart).reduce((sum, s) => sum + s.totalAmount, 0);
        const totalSales = sales.reduce((sum, s) => sum + s.totalAmount, 0);

        document.getElementById('daily-sales-text').innerHTML = `إجمالي المبيعات اليوم (${now.toLocaleDateString('ar-IQ')}): <span style="color: var(--button-color);">${dailySales.toFixed(2)} IQD</span>`;
        document.getElementById('monthly-sales-text').innerHTML = `إجمالي المبيعات الشهري (${now.toLocaleDateString('ar-IQ', { month: 'long', year: 'numeric' })}): <span style="color: var(--accent-color);">${monthlySales.toFixed(2)} IQD</span>`;
        document.getElementById('yearly-sales-text').innerHTML = `إجمالي المبيعات السنوي (${now.getFullYear()}): <span style="color: var(--header-color);">${yearlySales.toFixed(2)} IQD</span>`;
        document.getElementById('total-sales-text').innerHTML = `إجمالي المبيعات الكلي: <span style="color: var(--danger-color); font-size: 20px;">${totalSales.toFixed(2)} IQD</span>`;
    }

    async function deleteSalesStats() {
        if (!confirm('هل أنت متأكد من حذف جميع إحصائيات المبيعات؟ هذا الإجراء لا يمكن التراجع عنه.')) return;
        const tx = db.transaction('sales', 'readwrite');
        tx.objectStore('sales').clear();
        tx.oncomplete = () => {
            alert('تم حذف جميع الإحصائيات بنجاح.');
            generateSalesStats();
        };
        tx.onerror = (e) => alert('فشل حذف الإحصائيات: ' + e.target.error);
    }

    // وظائف الطباعة للتقارير
    function printExpiringReport() {
        const now = new Date();
        const printBody = document.getElementById('print-report-body');
        printBody.innerHTML = `
            <div class="print-report-header">
                <h2>تقرير المنتجات المقاربة على الانتهاء</h2>
                <p>نظام أوسكار لإدارة الصيدليات</p>
                <div class="report-info">
                    <span>تاريخ التقرير: ${now.toLocaleDateString('ar-IQ')}</span>
                    <span>الوقت: ${now.toLocaleTimeString('ar-IQ')}</span>
                </div>
            </div>
            <table class="print-report-table">
                <thead><tr><th>المنتج</th><th>الباركود</th><th>الكمية</th><th>تاريخ الانتهاء</th><th>الأيام المتبقية</th></tr></thead>
                ${document.getElementById('expiring-products-body').innerHTML}
            </table>
            <div class="print-report-summary">
                <p>إجمالي عدد المنتجات المقاربة على الانتهاء: <strong>${document.getElementById('expiring-products-body').rows.length}</strong></p>
            </div>
            <div class="print-report-footer">
                <p>شكراً لاستخدامكم نظام أوسكار لإدارة الصيدليات</p>
            </div>
        `;
        document.getElementById('print-report').style.display = 'block';
        window.print();
        document.getElementById('print-report').style.display = 'none';
    }

    function printLowStockReport() {
        const now = new Date();
        const printBody = document.getElementById('print-report-body');
        printBody.innerHTML = `
            <div class="print-report-header">
                <h2>تقرير المنتجات منخفضة المخزون</h2>
                <p>نظام أوسكار لإدارة الصيدليات</p>
                <div class="report-info">
                    <span>تاريخ التقرير: ${now.toLocaleDateString('ar-IQ')}</span>
                    <span>الوقت: ${now.toLocaleTimeString('ar-IQ')}</span>
                </div>
            </div>
            <table class="print-report-table">
                <thead><tr><th>المنتج</th><th>الباركود</th><th>الكمية المتبقية</th><th>الحد الأدنى</th><th>الحالة</th></tr></thead>
                ${document.getElementById('low-stock-products-body').innerHTML}
            </table>
            <div class="print-report-summary">
                <p>إجمالي عدد المنتجات منخفضة المخزون: <strong>${document.getElementById('low-stock-products-body').rows.length}</strong></p>
            </div>
            <div class="print-report-footer">
                <p>شكراً لاستخدامكم نظام أوسكار لإدارة الصيدليات</p>
            </div>
        `;
        document.getElementById('print-report').style.display = 'block';
        window.print();
        document.getElementById('print-report').style.display = 'none';
    }

    function printSalesStats() {
        const now = new Date();
        const printBody = document.getElementById('print-report-body');
        printBody.innerHTML = `
            <div class="print-report-header">
                <h2>تقرير إحصائيات المبيعات</h2>
                <p>نظام أوسكار لإدارة الصيدليات</p>
                <div class="report-info">
                    <span>تاريخ التقرير: ${now.toLocaleDateString('ar-IQ')}</span>
                    <span>الوقت: ${now.toLocaleTimeString('ar-IQ')}</span>
                </div>
            </div>
            <div class="sales-stats">
                ${document.getElementById('daily-sales-text').innerHTML}
                ${document.getElementById('monthly-sales-text').innerHTML}
                ${document.getElementById('yearly-sales-text').innerHTML}
                ${document.getElementById('total-sales-text').innerHTML}
            </div>
            <div class="print-report-footer">
                <p>شكراً لاستخدامكم نظام أوسكار لإدارة الصيدليات</p>
            </div>
        `;
        document.getElementById('print-report').style.display = 'block';
        window.print();
        document.getElementById('print-report').style.display = 'none';
    }

    </script>
</body>
</html>
