import sqlite3
import tkinter as tk
from tkinter import messagebox, ttk, filedialog
from datetime import datetime
import hashlib
from reportlab.lib.pagesizes import letter, A4
from reportlab.lib import colors
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle
from reportlab.lib.enums import TA_RIGHT, TA_CENTER, TA_LEFT
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.pdfgen import canvas
from reportlab.lib.utils import simpleSplit
import csv
import shutil
import os
import logging
import arabic_reshaper
from bidi.algorithm import get_display

# إعداد التسجيل
logging.basicConfig(filename='workshop.log', level=logging.INFO, 
                    format='%(asctime)s - %(levelname)s - %(message)s')

# إنشاء قاعدة البيانات
def create_database():
    with sqlite3.connect('workshop.db') as conn:
        c = conn.cursor()
        c.execute('''CREATE TABLE IF NOT EXISTS repairs
                     (id INTEGER PRIMARY KEY, device_name TEXT NOT NULL, owner_name TEXT NOT NULL, 
                     owner_phone TEXT, status TEXT DEFAULT 'قيد الإصلاح', entry_date DATE, 
                     exit_date DATE, description TEXT, estimated_cost REAL DEFAULT 0, 
                     final_cost REAL DEFAULT 0)''')
        c.execute('''CREATE TABLE IF NOT EXISTS sales
                     (id INTEGER PRIMARY KEY, product_id INTEGER, device_name TEXT NOT NULL, 
                     customer_name TEXT NOT NULL, customer_phone TEXT, sale_type TEXT DEFAULT 'نقدي', 
                     installments_remaining INTEGER DEFAULT 0, sale_date DATE, 
                     amount REAL NOT NULL, paid_amount REAL DEFAULT 0, notes TEXT)''')
        c.execute('''CREATE TABLE IF NOT EXISTS products
                     (id INTEGER PRIMARY KEY, product_name TEXT NOT NULL UNIQUE, category TEXT, 
                     price REAL DEFAULT 0, quantity INTEGER DEFAULT 0, description TEXT, 
                     created_date DATE, last_updated DATE)''')
        conn.commit()

create_database()

# دالة لتحويل النص العربي للعرض الصحيح
def arabic_text(text):
    """تحويل النص العربي للعرض الصحيح في PDF"""
    try:
        if isinstance(text, str) and any('\u0600' <= char <= '\u06FF' for char in text):
            reshaped_text = arabic_reshaper.reshape(text)
            return get_display(reshaped_text)
        return str(text)
    except:
        return str(text)

# دالة لتحويل العملة من الدولار إلى الدينار العراقي
def usd_to_iqd(usd_amount):
    """تحويل من الدولار إلى الدينار العراقي (سعر الصرف التقريبي 1$ = 1450 دينار)"""
    exchange_rate = 1450
    return usd_amount * exchange_rate

def format_currency(amount, currency_type="دينار"):
    """تنسيق المبالغ المالية"""
    if currency_type == "دينار":
        iqd_amount = usd_to_iqd(amount)
        return f"{iqd_amount:,.0f} د.ع"
    else:
        return f"${amount:.2f}"

def print_pdf(title, details, filename=None):
    if not filename:
        filename = f"{title.lower().replace(' ', '_')}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.pdf"
    
    try:
        doc = SimpleDocTemplate(filename, pagesize=A4, rightMargin=40, leftMargin=40, 
                                topMargin=40, bottomMargin=40)
        
        # تسجيل خط عربي (يجب توفير ملف الخط)
        try:
            # حاول استخدام خط عربي إذا كان متوفراً
            # يمكنك تحميل خط مثل "arial.ttf" أو "trado.ttf"
            pdfmetrics.registerFont(TTFont('Arial', 'arial.ttf'))
            arabic_font = 'Arial'
        except:
            try:
                # محاولة استخدام خط افتراضي يدعم العربية
                pdfmetrics.registerFont(TTFont('DejaVu', 'DejaVuSans.ttf'))
                arabic_font = 'DejaVu'
            except:
                arabic_font = 'Helvetica'
        
        styles = getSampleStyleSheet()
        
        # نمط العنوان
        title_style = ParagraphStyle(
            'ArabicTitle',
            parent=styles['Heading1'],
            fontName=arabic_font,
            fontSize=16,
            textColor=colors.HexColor('#2c3e50'),
            alignment=TA_CENTER,
            spaceAfter=20,
            leading=24
        )
        
        # نمط النص العادي
        normal_style = ParagraphStyle(
            'ArabicNormal',
            parent=styles['Normal'],
            fontName=arabic_font,
            fontSize=10,
            textColor=colors.black,
            alignment=TA_RIGHT,
            spaceAfter=8,
            leading=14,
            rightIndent=10
        )
        
        # نمط للقيم (محاذاة لليسار)
        value_style = ParagraphStyle(
            'ValueStyle',
            parent=styles['Normal'],
            fontName=arabic_font,
            fontSize=10,
            textColor=colors.black,
            alignment=TA_LEFT,
            spaceAfter=8,
            leading=14,
            leftIndent=10
        )
        
        content = []
        
        # إضافة العنوان
        header = Paragraph(arabic_text(f"<b>{title}</b>"), title_style)
        content.append(header)
        content.append(Spacer(1, 15))
        
        # خط فاصل
        separator_line = Table([['']], colWidths=[500])
        separator_line.setStyle(TableStyle([
            ('LINEBELOW', (0, 0), (-1, 0), 1, colors.HexColor('#3498db')),
        ]))
        content.append(separator_line)
        content.append(Spacer(1, 20))
        
        # تحضير البيانات للجدول
        data = []
        
        # رأس الجدول
        data.append([
            Paragraph(arabic_text("القيمة"), value_style),
            Paragraph(arabic_text("البيان"), normal_style)
        ])
        
        # بيانات الجدول
        for key, value in details.items():
            # معالجة النص العربي وتحويل العملة إذا كان المبلغ مالياً
            display_value = str(value)
            if any(currency in str(value) for currency in ['$', 'دينار', 'د.ع']):
                # إذا كان المبلغ يحتوي على رمز عملة، اتركه كما هو
                pass
            elif key in ['سعر الوحدة', 'المبلغ الإجمالي', 'التكلفة المتوقعة', 
                        'التكلفة النهائية', 'المبلغ الكلي', 'المبلغ المدفوع', 
                        'المبلغ المتبقي', 'المبلغ المراد دفعه', 'المبلغ المتبقي']:
                # تحويل المبالغ المالية إلى دينار عراقي
                try:
                    if '$' in str(value):
                        num_value = float(str(value).replace('$', '').strip())
                        display_value = format_currency(num_value, "دينار")
                    else:
                        num_value = float(value)
                        display_value = format_currency(num_value, "دينار")
                except:
                    pass
            
            data.append([
                Paragraph(arabic_text(display_value), value_style),
                Paragraph(arabic_text(key), normal_style)
            ])
        
        # إنشاء الجدول
        table = Table(data, colWidths=[250, 250])
        table.setStyle(TableStyle([
            # تنسيق الرأس
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#2c3e50')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (-1, 0), 'CENTER'),
            ('FONTNAME', (0, 0), (-1, 0), arabic_font),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            
            # تنسيق البيانات
            ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
            ('FONTNAME', (0, 1), (-1, -1), arabic_font),
            ('FONTSIZE', (0, 1), (-1, -1), 10),
            ('GRID', (0, 0), (-1, -1), 1, colors.grey),
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('TOPPADDING', (0, 1), (-1, -1), 6),
            ('BOTTOMPADDING', (0, 1), (-1, -1), 6),
        ]))
        
        content.append(table)
        content.append(Spacer(1, 25))
        
        # إضافة التاريخ والوقت
        date_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        footer_text = arabic_text(f"تاريخ الطباعة: {date_time}")
        footer = Paragraph(footer_text, normal_style)
        content.append(footer)
        
        # بناء المستند
        doc.build(content)
        messagebox.showinfo("نجاح", f"تم إنشاء الملف بنجاح:\n{filename}")
        logging.info(f"تم إنشاء PDF: {filename}")
        
        # فتح الملف تلقائياً
        try:
            os.startfile(filename)
        except:
            pass
            
    except Exception as e:
        messagebox.showerror("خطأ", f"خطأ في الطباعة: {str(e)}")
        logging.error(f"خطأ في الطباعة: {str(e)}")

# تشفير كلمة المرور
def hash_password(password):
    return hashlib.sha256(password.encode()).hexdigest()

class ModernWorkshopApp:
    def __init__(self, root):
        self.root = root
        self.root.title("نظام إدارة الورشة الاحترافي")
        self.root.geometry("1200x800")
        self.root.configure(bg='#2c3e50')
        
        self.center_window(self.root)
        
        self.colors = {
            'primary': '#3498db',
            'secondary': '#2ecc71',
            'danger': '#e74c3c',
            'warning': '#f39c12',
            'dark': '#2c3e50',
            'light': '#ecf0f1',
            'success': '#27ae60',
            'info': '#17a2b8',
            'purple': '#6f42c1'
        }
        
        self.setup_styles()
        self.password_hash = hash_password("workshop123")
        
        self.create_login_window()

    def center_window(self, window):
        window.update_idletasks()
        width = window.winfo_width()
        height = window.winfo_height()
        x = (window.winfo_screenwidth() // 2) - (width // 2)
        y = (window.winfo_screenheight() // 2) - (height // 2)
        window.geometry('{}x{}+{}+{}'.format(width, height, x, y))

    def setup_styles(self):
        style = ttk.Style()
        style.theme_use('clam')
        
        style.configure('Primary.TButton', 
                        background=self.colors['primary'],
                        foreground='white',
                        font=('Arial', 10, 'bold'),
                        padding=10)
        
        style.configure('Success.TButton',
                        background=self.colors['success'],
                        foreground='white',
                        font=('Arial', 10, 'bold'),
                        padding=10)
        
        style.configure('Danger.TButton',
                        background=self.colors['danger'],
                        foreground='white',
                        font=('Arial', 10, 'bold'),
                        padding=10)

    def create_login_window(self):
        self.login_window = tk.Toplevel(self.root)
        self.login_window.title("تسجيل الدخول - النظام الاحترافي")
        self.login_window.geometry("400x300")
        self.login_window.configure(bg=self.colors['dark'])
        self.login_window.resizable(False, False)
        self.center_window(self.login_window)
        
        self.login_window.transient(self.root)
        self.login_window.grab_set()
        
        title_frame = tk.Frame(self.login_window, bg=self.colors['dark'])
        title_frame.pack(pady=30)
        
        tk.Label(title_frame, text="نظام إدارة الورشة", 
                 font=('Arial', 18, 'bold'), 
                 bg=self.colors['dark'], 
                 fg='white').pack()
        
        tk.Label(title_frame, text="الإصدار الاحترافي v2.0", 
                 font=('Arial', 12), 
                 bg=self.colors['dark'], 
                 fg=self.colors['primary']).pack()
        
        input_frame = tk.Frame(self.login_window, bg=self.colors['dark'])
        input_frame.pack(pady=40)
        
        tk.Label(input_frame, text="كلمة المرور:", 
                 font=('Arial', 12, 'bold'), 
                 bg=self.colors['dark'], 
                 fg='white').grid(row=0, column=0, padx=10, pady=10, sticky='e')
        
        self.password_entry = tk.Entry(input_frame, show="*", 
                                       font=('Arial', 12), 
                                       width=20,
                                       bg=self.colors['light'])
        self.password_entry.grid(row=0, column=1, padx=10, pady=10)
        self.password_entry.bind('<Return>', lambda e: self.check_password())
        self.password_entry.focus()
        
        btn_frame = tk.Frame(self.login_window, bg=self.colors['dark'])
        btn_frame.pack(pady=20)
        
        ttk.Button(btn_frame, text="دخول", 
                   style='Primary.TButton',
                   command=self.check_password).pack(side=tk.LEFT, padx=10)
        
        ttk.Button(btn_frame, text="خروج", 
                   style='Danger.TButton',
                   command=self.root.quit).pack(side=tk.LEFT, padx=10)
        
        self.root.withdraw()

    def check_password(self):
        if hash_password(self.password_entry.get()) == self.password_hash:
            logging.info("تسجيل دخول ناجح")
            self.login_window.destroy()
            self.root.deiconify()
            self.build_main_window()
        else:
            messagebox.showerror("خطأ", "كلمة مرور خاطئة!")
            self.password_entry.delete(0, tk.END)
            logging.warning("محاولة تسجيل دخول فاشلة")

    def build_main_window(self):
        self.create_menubar()
        
        title_frame = tk.Frame(self.root, bg=self.colors['dark'], height=100)
        title_frame.pack(fill=tk.X, padx=10, pady=10)
        title_frame.pack_propagate(False)
        
        tk.Label(title_frame, text="نظام إدارة الورشة الاحترافي", 
                 font=('Arial', 20, 'bold'), 
                 bg=self.colors['dark'], 
                 fg='white').pack(expand=True)
        
        tk.Label(title_frame, text=f"مرحباً بك - {datetime.now().strftime('%Y-%m-%d %H:%M')}", 
                 font=('Arial', 12), 
                 bg=self.colors['dark'], 
                 fg=self.colors['primary']).pack()
        
        self.create_dashboard()
        self.create_quick_actions()

    def create_menubar(self):
        menubar = tk.Menu(self.root, bg=self.colors['light'], fg=self.colors['dark'])
        
        file_menu = tk.Menu(menubar, tearoff=0, bg='white', fg='black')
        file_menu.add_command(label="تصدير البيانات", command=self.export_data)
        file_menu.add_command(label="استيراد البيانات", command=self.import_data)
        file_menu.add_separator()
        file_menu.add_command(label="خروج", command=self.root.quit)
        menubar.add_cascade(label="ملف", menu=file_menu)
        
        view_menu = tk.Menu(menubar, tearoff=0, bg='white', fg='black')
        view_menu.add_command(label="لوحة التحكم", command=self.show_dashboard)
        view_menu.add_command(label="عرض الصيانات", command=self.show_repairs)
        view_menu.add_command(label="عرض المبيعات", command=self.show_sales)
        view_menu.add_command(label="عرض المنتجات", command=self.show_products)
        view_menu.add_command(label="التقارير", command=self.show_reports)
        menubar.add_cascade(label="عرض", menu=view_menu)
        
        add_menu = tk.Menu(menubar, tearoff=0, bg='white', fg='black')
        add_menu.add_command(label="إضافة صيانة", command=self.add_repair)
        add_menu.add_command(label="إضافة بيع", command=self.add_sale)
        add_menu.add_command(label="إضافة منتج", command=self.add_product)
        add_menu.add_command(label="دفع قسط", command=self.pay_installment)
        menubar.add_cascade(label="إضافة", menu=add_menu)
        
        settings_menu = tk.Menu(menubar, tearoff=0, bg='white', fg='black')
        settings_menu.add_command(label="تغيير كلمة المرور", command=self.change_password)
        settings_menu.add_command(label="نسخ احتياطي", command=self.backup_data)
        menubar.add_cascade(label="الإعدادات", menu=settings_menu)
        
        self.root.config(menu=menubar)

    def create_dashboard(self):
        dashboard_frame = tk.Frame(self.root, bg='white', relief='raised', bd=2)
        dashboard_frame.pack(fill=tk.X, padx=20, pady=10)
        
        tk.Label(dashboard_frame, text="الإحصائيات السريعة", 
                 font=('Arial', 14, 'bold'), 
                 bg='white').pack(pady=10)
        
        stats_frame = tk.Frame(dashboard_frame, bg='white')
        stats_frame.pack(fill=tk.X, padx=20, pady=10)
        
        with sqlite3.connect('workshop.db') as conn:
            c = conn.cursor()
            
            c.execute("SELECT COUNT(*) FROM repairs WHERE status='قيد الإصلاح'")
            pending_repairs = c.fetchone()[0]
            
            c.execute("SELECT COUNT(*) FROM sales WHERE sale_type='أقساط' AND installments_remaining > 0")
            pending_installments = c.fetchone()[0]
            
            c.execute("SELECT SUM(amount) FROM sales WHERE strftime('%Y-%m', sale_date)=strftime('%Y-%m', 'now')")
            monthly_sales = c.fetchone()[0] or 0
            
            c.execute("SELECT COUNT(*) FROM products WHERE quantity > 0")
            available_products = c.fetchone()[0]
            
            c.execute("SELECT SUM(final_cost) FROM repairs WHERE exit_date IS NOT NULL AND strftime('%Y-%m', exit_date)=strftime('%Y-%m', 'now')")
            monthly_repairs_revenue = c.fetchone()[0] or 0
        
        # تحويل المبالغ إلى دينار عراقي
        monthly_sales_iqd = format_currency(monthly_sales, "دينار")
        monthly_repairs_revenue_iqd = format_currency(monthly_repairs_revenue, "دينار")
        
        stats_data = [
            ("الصيانات المعلقة", pending_repairs, self.colors['warning']),
            ("الأقساط المستحقة", pending_installments, self.colors['danger']),
            ("المبيعات الشهرية", monthly_sales_iqd, self.colors['success']),
            ("إيرادات الصيانات", monthly_repairs_revenue_iqd, self.colors['info']),
            ("المنتجات المتاحة", available_products, self.colors['primary'])
        ]
        
        for i, (title, value, color) in enumerate(stats_data):
            stat_card = tk.Frame(stats_frame, bg=color, relief='raised', bd=2)
            stat_card.grid(row=0, column=i, padx=10, pady=5, sticky='ew')
            
            tk.Label(stat_card, text=title, font=('Arial', 10, 'bold'), 
                     bg=color, fg='white').pack(pady=(10, 0))
            tk.Label(stat_card, text=str(value), font=('Arial', 12, 'bold'), 
                     bg=color, fg='white').pack(pady=(0, 10))
            
            stats_frame.columnconfigure(i, weight=1)

    def create_quick_actions(self):
        actions_frame = tk.Frame(self.root, bg='white', relief='raised', bd=2)
        actions_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=10)
        
        tk.Label(actions_frame, text="الإجراءات السريعة", 
                 font=('Arial', 14, 'bold'), 
                 bg='white').pack(pady=10)
        
        buttons = [
            ("إضافة صيانة", self.colors['primary'], self.add_repair),
            ("إضافة بيع", self.colors['success'], self.add_sale),
            ("إضافة منتج", self.colors['secondary'], self.add_product),
            ("عرض الصيانات", self.colors['warning'], self.show_repairs),
            ("عرض المبيعات", self.colors['info'], self.show_sales),
            ("عرض المنتجات", self.colors['dark'], self.show_products),
            ("التقارير", self.colors['purple'], self.show_reports),
            ("دفع أقساط", self.colors['danger'], self.pay_installment)
        ]
        
        btn_frame = tk.Frame(actions_frame, bg='white')
        btn_frame.pack(expand=True)
        
        for i, (text, color, command) in enumerate(buttons):
            btn = tk.Button(btn_frame, text=text, font=('Arial', 11, 'bold'),
                            bg=color, fg='white', relief='raised', bd=2,
                            command=command, width=15, height=2)
            btn.grid(row=i//4, column=i%4, padx=8, pady=8, sticky='nsew')
            btn_frame.columnconfigure(i%4, weight=1)
            btn_frame.rowconfigure(i//4, weight=1)

    def add_product(self):
        window = tk.Toplevel(self.root)
        window.title("إضافة منتج جديد")
        window.geometry("500x500")
        window.configure(bg='white')
        self.center_window(window)
        
        title_label = tk.Label(window, text="إضافة منتج جديد", 
                               font=('Arial', 16, 'bold'), bg='white')
        title_label.pack(pady=20)
        
        form_frame = tk.Frame(window, bg='white')
        form_frame.pack(fill=tk.BOTH, expand=True, padx=30)
        
        fields = [
            ("اسم المنتج:", "entry"),
            ("الفئة:", "entry"),
            ("السعر ($):", "entry"),
            ("الكمية:", "entry"),
            ("الوصف:", "text")
        ]
        
        entries = {}
        for i, (label, field_type) in enumerate(fields):
            tk.Label(form_frame, text=label, font=('Arial', 11), 
                     bg='white').grid(row=i, column=0, sticky='e', pady=8, padx=10)
            
            if field_type == "entry":
                entry = tk.Entry(form_frame, font=('Arial', 11), bg='#f8f9fa')
                entry.grid(row=i, column=1, sticky='ew', pady=8, padx=10)
            else:
                entry = tk.Text(form_frame, height=3, width=30, font=('Arial', 11), bg='#f8f9fa')
                entry.grid(row=i, column=1, sticky='ew', pady=8, padx=10)
            
            entries[label] = entry
        
        form_frame.columnconfigure(1, weight=1)
        
        def save():
            try:
                product_name = entries["اسم المنتج:"].get().strip()
                if not product_name:
                    raise ValueError("يرجى إدخال اسم المنتج")
                
                price = float(entries["السعر ($):"].get() or 0)
                quantity = int(entries["الكمية:"].get() or 0)
                
                with sqlite3.connect('workshop.db') as conn:
                    c = conn.cursor()
                    c.execute('''INSERT INTO products 
                              (product_name, category, price, quantity, description, created_date, last_updated) 
                              VALUES (?, ?, ?, ?, ?, ?, ?)''',
                             (product_name,
                              entries["الفئة:"].get().strip(),
                              price,
                              quantity,
                              entries["الوصف:"].get("1.0", tk.END).strip(),
                              datetime.now().date(),
                              datetime.now().date()))
                    conn.commit()
                
                messagebox.showinfo("نجاح", "تم إضافة المنتج بنجاح!")
                logging.info(f"تم إضافة منتج: {product_name}")
                window.destroy()
                self.show_dashboard()
            except sqlite3.IntegrityError:
                messagebox.showerror("خطأ", "اسم المنتج موجود مسبقاً!")
            except ValueError as ve:
                messagebox.showerror("خطأ", str(ve))
            except Exception as e:
                messagebox.showerror("خطأ", f"حدث خطأ أثناء الحفظ: {str(e)}")
                logging.error(f"خطأ في إضافة المنتج: {str(e)}")
        
        btn_frame = tk.Frame(window, bg='white')
        btn_frame.pack(pady=20)
        
        tk.Button(btn_frame, text="حفظ", bg=self.colors['success'], fg='white',
                  font=('Arial', 11, 'bold'), command=save, width=10).pack(side=tk.LEFT, padx=10)
        
        tk.Button(btn_frame, text="إلغاء", bg=self.colors['danger'], fg='white',
                  font=('Arial', 11, 'bold'), command=window.destroy, width=10).pack(side=tk.LEFT, padx=10)

    # باقي الدوال (show_products, add_sale, add_repair, show_repairs, show_sales, pay_installment, show_reports)
    # ستبقى كما هي مع تعديلات بسيطة في عرض الأسعار
    
    def add_sale(self):
        window = tk.Toplevel(self.root)
        window.title("إضافة بيع جديد")
        window.geometry("600x500")
        window.configure(bg='white')
        self.center_window(window)
        
        title_label = tk.Label(window, text="إضافة بيع جديد", 
                               font=('Arial', 16, 'bold'), bg='white')
        title_label.pack(pady=20)
        
        form_frame = tk.Frame(window, bg='white')
        form_frame.pack(fill=tk.BOTH, expand=True, padx=30)
        
        tk.Label(form_frame, text="اختر المنتج:", font=('Arial', 11), bg='white').grid(row=0, column=0, sticky='e', pady=8)
        
        with sqlite3.connect('workshop.db') as conn:
            c = conn.cursor()
            c.execute("SELECT id, product_name, price, quantity FROM products WHERE quantity > 0")
            products = c.fetchall()
        
        product_var = tk.StringVar()
        product_combo = ttk.Combobox(form_frame, textvariable=product_var, font=('Arial', 11))
        product_combo['values'] = [f"{p[0]} - {p[1]} (${p[2]}) - متوفر: {p[3]}" for p in products]
        product_combo.grid(row=0, column=1, sticky='ew', pady=8, padx=10)
        
        fields = [
            ("اسم الزبون:", "entry"),
            ("رقم الهاتف:", "entry"),
            ("الكمية:", "entry"),
            ("ملاحظات:", "text")
        ]
        
        entries = {}
        for i, (label, field_type) in enumerate(fields, 1):
            tk.Label(form_frame, text=label, font=('Arial', 11), 
                     bg='white').grid(row=i, column=0, sticky='e', pady=8, padx=10)
            
            if field_type == "entry":
                entry = tk.Entry(form_frame, font=('Arial', 11), bg='#f8f9fa')
                entry.grid(row=i, column=1, sticky='ew', pady=8, padx=10)
            else:
                entry = tk.Text(form_frame, height=3, width=30, font=('Arial', 11), bg='#f8f9fa')
                entry.grid(row=i, column=1, sticky='ew', pady=8, padx=10)
            
            entries[label] = entry
        
        tk.Label(form_frame, text="نوع البيع:", font=('Arial', 11), bg='white').grid(row=5, column=0, sticky='e', pady=8)
        sale_type_var = tk.StringVar(value="نقدي")
        sale_type_frame = tk.Frame(form_frame, bg='white')
        sale_type_frame.grid(row=5, column=1, sticky='w', pady=8, padx=10)
        ttk.Radiobutton(sale_type_frame, text="نقدي", variable=sale_type_var, value="نقدي").pack(side=tk.LEFT)
        ttk.Radiobutton(sale_type_frame, text="أقساط", variable=sale_type_var, value="أقساط").pack(side=tk.LEFT)
        
        tk.Label(form_frame, text="الأقساط المتبقية:", font=('Arial', 11), bg='white').grid(row=6, column=0, sticky='e', pady=8)
        installments_entry = tk.Entry(form_frame, font=('Arial', 11), bg='#f8f9fa')
        installments_entry.grid(row=6, column=1, sticky='ew', pady=8, padx=10)
        installments_entry.insert(0, "0")
        
        form_frame.columnconfigure(1, weight=1)
        
        def save():
            try:
                if not product_var.get():
                    raise ValueError("يرجى اختيار منتج")
                
                product_id = int(product_var.get().split(' - ')[0])
                quantity = int(entries["الكمية:"].get() or 0)
                
                if quantity <= 0:
                    raise ValueError("يرجى إدخال كمية صحيحة")
                
                with sqlite3.connect('workshop.db') as conn:
                    c = conn.cursor()
                    
                    c.execute("SELECT quantity, price, product_name FROM products WHERE id=?", (product_id,))
                    product = c.fetchone()
                    
                    if not product:
                        raise ValueError("المنتج غير موجود")
                    
                    if product[0] < quantity:
                        raise ValueError(f"الكمية غير متاحة. المتوفر: {product[0]}")
                    
                    c.execute("UPDATE products SET quantity = quantity - ?, last_updated = ? WHERE id=?", 
                              (quantity, datetime.now().date(), product_id))
                    
                    total_amount = product[1] * quantity
                    installments = int(installments_entry.get()) if sale_type_var.get() == "أقساط" else 0
                    
                    c.execute('''INSERT INTO sales 
                              (product_id, device_name, customer_name, customer_phone, sale_type, 
                              installments_remaining, sale_date, amount, notes) 
                              VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)''',
                             (product_id,
                              product[2],
                              entries["اسم الزبون:"].get().strip(),
                              entries["رقم الهاتف:"].get().strip(),
                              sale_type_var.get(),
                              installments,
                              datetime.now().date(),
                              total_amount,
                              entries["ملاحظات:"].get("1.0", tk.END).strip()))
                    conn.commit()
                
                # تحويل الأسعار إلى دينار عراقي في الإيصال
                unit_price_iqd = format_currency(product[1], "دينار")
                total_amount_iqd = format_currency(total_amount, "دينار")
                
                details = {
                    "المنتج": product[2],
                    "الزبون": entries["اسم الزبون:"].get(),
                    "الهاتف": entries["رقم الهاتف:"].get(),
                    "الكمية": quantity,
                    "سعر الوحدة": unit_price_iqd,
                    "المبلغ الإجمالي": total_amount_iqd,
                    "نوع البيع": sale_type_var.get(),
                    "الأقساط المتبقية": installments
                }
                print_pdf("ايصال بيع", details)
                
                messagebox.showinfo("نجاح", "تم إضافة البيع بنجاح!")
                logging.info(f"تم إضافة بيع جديد للمنتج ID: {product_id}")
                window.destroy()
                self.show_dashboard()
                
            except ValueError as ve:
                messagebox.showerror("خطأ", str(ve))
            except Exception as e:
                messagebox.showerror("خطأ", f"حدث خطأ أثناء الحفظ: {str(e)}")
                logging.error(f"خطأ في إضافة البيع: {str(e)}")
        
        btn_frame = tk.Frame(window, bg='white')
        btn_frame.pack(pady=20)
        
        tk.Button(btn_frame, text="حفظ وطباعة", bg=self.colors['success'], fg='white',
                  font=('Arial', 11, 'bold'), command=save, width=12).pack(side=tk.LEFT, padx=10)
        
        tk.Button(btn_frame, text="إلغاء", bg=self.colors['danger'], fg='white',
                  font=('Arial', 11, 'bold'), command=window.destroy, width=10).pack(side=tk.LEFT, padx=10)

    # باقي الدوال ستبقى كما هي مع تعديلات بسيطة في عرض الأسعار
    
    def show_reports(self):
        window = tk.Toplevel(self.root)
        window.title("التقارير والإحصائيات")
        window.geometry("700x700")
        window.configure(bg='white')
        self.center_window(window)
        
        header_frame = tk.Frame(window, bg=self.colors['purple'], height=80)
        header_frame.pack(fill=tk.X)
        header_frame.pack_propagate(False)
        
        tk.Label(header_frame, text="📊 التقارير والإحصائيات", 
                 font=('Arial', 18, 'bold'), 
                 bg=self.colors['purple'], 
                 fg='white').pack(expand=True)
        
        report_frame = tk.Frame(window, bg='white')
        report_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        with sqlite3.connect('workshop.db') as conn:
            c = conn.cursor()
            
            c.execute("SELECT COUNT(*) FROM repairs")
            total_repairs = c.fetchone()[0]
            
            c.execute("SELECT COUNT(*) FROM repairs WHERE status='مكتملة'")
            completed_repairs = c.fetchone()[0]
            
            c.execute("SELECT COUNT(*) FROM repairs WHERE status='قيد الإصلاح'")
            pending_repairs = c.fetchone()[0]
            
            c.execute("SELECT SUM(final_cost) FROM repairs WHERE status='مكتملة'")
            total_repairs_revenue = c.fetchone()[0] or 0
            
            c.execute("SELECT COUNT(*) FROM sales")
            total_sales = c.fetchone()[0]
            
            c.execute("SELECT SUM(amount) FROM sales")
            total_revenue = c.fetchone()[0] or 0
            
            c.execute("SELECT SUM(amount) FROM sales WHERE strftime('%Y-%m', sale_date)=strftime('%Y-%m', 'now')")
            monthly_revenue = c.fetchone()[0] or 0
            
            c.execute("SELECT SUM(paid_amount) FROM sales")
            total_paid = c.fetchone()[0] or 0
            
            c.execute("SELECT COUNT(*) FROM products")
            total_products = c.fetchone()[0]
            
            c.execute("SELECT SUM(quantity) FROM products")
            total_quantity = c.fetchone()[0] or 0
            
            c.execute("SELECT COUNT(*) FROM products WHERE quantity < 5")
            low_stock = c.fetchone()[0]
        
        # تحويل المبالغ إلى دينار عراقي
        total_repairs_revenue_iqd = format_currency(total_repairs_revenue, "دينار")
        total_revenue_iqd = format_currency(total_revenue, "دينار")
        monthly_revenue_iqd = format_currency(monthly_revenue, "دينار")
        total_paid_iqd = format_currency(total_paid, "دينار")
        remaining_amount_iqd = format_currency(total_revenue - total_paid, "دينار")
        
        categories = [
            ("📋 الصيانات", [
                ("إجمالي الصيانات", total_repairs, 'primary'),
                ("الصيانات المكتملة", completed_repairs, 'success'),
                ("الصيانات قيد الإصلاح", pending_repairs, 'warning'),
                ("إجمالي إيرادات الصيانات", total_repairs_revenue_iqd, 'info')
            ]),
            ("💰 المبيعات", [
                ("إجمالي المبيعات", total_sales, 'primary'),
                ("إجمالي الإيرادات", total_revenue_iqd, 'success'),
                ("إيرادات الشهر الحالي", monthly_revenue_iqd, 'info'),
                ("إجمالي المبالغ المدفوعة", total_paid_iqd, 'secondary'),
                ("المبالغ المتبقية", remaining_amount_iqd, 'danger')
            ]),
            ("📦 المنتجات", [
                ("إجمالي المنتجات", total_products, 'primary'),
                ("الكمية الإجمالية", total_quantity, 'success'),
                ("المنتجات منخفضة المخزون", low_stock, 'warning')
            ])
        ]
        
        for category_name, items in categories:
            cat_frame = tk.LabelFrame(report_frame, text=category_name, 
                                     font=('Arial', 12, 'bold'),
                                     bg='white', fg=self.colors['dark'],
                                     relief='raised', bd=2)
            cat_frame.pack(fill=tk.X, pady=10)
            
            for title, value, color in items:
                item_frame = tk.Frame(cat_frame, bg='white')
                item_frame.pack(fill=tk.X, padx=15, pady=5)
                
                tk.Label(item_frame, text=title, 
                        font=('Arial', 11), 
                        bg='white',
                        anchor='w').pack(side=tk.LEFT)
                
                tk.Label(item_frame, text=str(value), 
                        font=('Arial', 11, 'bold'), 
                        bg='white',
                        fg=self.colors[color],
                        anchor='e').pack(side=tk.RIGHT)
        
        def export_report():
            reports = [
                ("إجمالي الصيانات", total_repairs),
                ("الصيانات المكتملة", completed_repairs),
                ("الصيانات قيد الإصلاح", pending_repairs),
                ("إجمالي إيرادات الصيانات", total_repairs_revenue_iqd),
                ("إجمالي المبيعات", total_sales),
                ("إجمالي الإيرادات", total_revenue_iqd),
                ("إيرادات الشهر", monthly_revenue_iqd),
                ("إجمالي المنتجات", total_products),
                ("الكمية الإجمالية", total_quantity),
                ("المنتجات منخفضة المخزون", low_stock)
            ]
            
            filename = f"report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
            with open(filename, 'w', newline='', encoding='utf-8-sig') as file:
                writer = csv.writer(file)
                writer.writerow(['التقرير', 'القيمة'])
                for title, value in reports:
                    writer.writerow([title, value])
            
            messagebox.showinfo("نجاح", f"تم تصدير التقرير إلى:\n{filename}")
            logging.info(f"تم تصدير التقرير: {filename}")
        
        btn_frame = tk.Frame(window, bg='white')
        btn_frame.pack(pady=15)
        
        tk.Button(btn_frame, text="📥 تصدير التقرير", bg=self.colors['primary'], fg='white',
                  font=('Arial', 11, 'bold'), command=export_report, width=15).pack(side=tk.LEFT, padx=5)
        tk.Button(btn_frame, text="إغلاق", bg=self.colors['danger'], fg='white',
                  font=('Arial', 11, 'bold'), command=window.destroy, width=10).pack(side=tk.LEFT, padx=5)

    # باقي الدوال (change_password, backup_data, export_data, import_data, show_dashboard)
    # ستبقى كما هي

if __name__ == "__main__":
    root = tk.Tk()
    app = ModernWorkshopApp(root)
    root.mainloop()
