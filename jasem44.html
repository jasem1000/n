import sqlite3
import tkinter as tk
from tkinter import messagebox, ttk, filedialog
from datetime import datetime
import hashlib
from reportlab.lib.pagesizes import letter, A4
from reportlab.lib import colors
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle
from reportlab.lib.enums import TA_RIGHT, TA_CENTER, TA_LEFT
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.pdfgen import canvas
from reportlab.lib.utils import simpleSplit
import csv
import shutil
import os
import logging
import arabic_reshaper
from bidi.algorithm import get_display

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(filename='workshop.log', level=logging.INFO, 
                    format='%(asctime)s - %(levelname)s - %(message)s')

# Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
def create_database():
    with sqlite3.connect('workshop.db') as conn:
        c = conn.cursor()
        c.execute('''CREATE TABLE IF NOT EXISTS repairs
                     (id INTEGER PRIMARY KEY, device_name TEXT NOT NULL, owner_name TEXT NOT NULL, 
                     owner_phone TEXT, status TEXT DEFAULT 'Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­', entry_date DATE, 
                     exit_date DATE, description TEXT, estimated_cost REAL DEFAULT 0, 
                     final_cost REAL DEFAULT 0)''')
        c.execute('''CREATE TABLE IF NOT EXISTS sales
                     (id INTEGER PRIMARY KEY, product_id INTEGER, device_name TEXT NOT NULL, 
                     customer_name TEXT NOT NULL, customer_phone TEXT, sale_type TEXT DEFAULT 'Ù†Ù‚Ø¯ÙŠ', 
                     installments_remaining INTEGER DEFAULT 0, sale_date DATE, 
                     amount REAL NOT NULL, paid_amount REAL DEFAULT 0, notes TEXT)''')
        c.execute('''CREATE TABLE IF NOT EXISTS products
                     (id INTEGER PRIMARY KEY, product_name TEXT NOT NULL UNIQUE, category TEXT, 
                     price REAL DEFAULT 0, quantity INTEGER DEFAULT 0, description TEXT, 
                     created_date DATE, last_updated DATE)''')
        conn.commit()

create_database()

# Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµØ­ÙŠØ­
def arabic_text(text):
    """ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµØ­ÙŠØ­ ÙÙŠ PDF"""
    try:
        if isinstance(text, str) and any('\u0600' <= char <= '\u06FF' for char in text):
            reshaped_text = arabic_reshaper.reshape(text)
            return get_display(reshaped_text)
        return str(text)
    except:
        return str(text)

# Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠ
def usd_to_iqd(usd_amount):
    """ØªØ­ÙˆÙŠÙ„ Ù…Ù† Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠ (Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ 1$ = 1450 Ø¯ÙŠÙ†Ø§Ø±)"""
    exchange_rate = 1450
    return usd_amount * exchange_rate

def format_currency(amount, currency_type="Ø¯ÙŠÙ†Ø§Ø±"):
    """ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ©"""
    if currency_type == "Ø¯ÙŠÙ†Ø§Ø±":
        iqd_amount = usd_to_iqd(amount)
        return f"{iqd_amount:,.0f} Ø¯.Ø¹"
    else:
        return f"${amount:.2f}"

def print_pdf(title, details, filename=None):
    if not filename:
        filename = f"{title.lower().replace(' ', '_')}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.pdf"
    
    try:
        doc = SimpleDocTemplate(filename, pagesize=A4, rightMargin=40, leftMargin=40, 
                                topMargin=40, bottomMargin=40)
        
        # ØªØ³Ø¬ÙŠÙ„ Ø®Ø· Ø¹Ø±Ø¨ÙŠ (ÙŠØ¬Ø¨ ØªÙˆÙÙŠØ± Ù…Ù„Ù Ø§Ù„Ø®Ø·)
        try:
            # Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø· Ø¹Ø±Ø¨ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
            # ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ Ø®Ø· Ù…Ø«Ù„ "arial.ttf" Ø£Ùˆ "trado.ttf"
            pdfmetrics.registerFont(TTFont('Arial', 'arial.ttf'))
            arabic_font = 'Arial'
        except:
            try:
                # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø· Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
                pdfmetrics.registerFont(TTFont('DejaVu', 'DejaVuSans.ttf'))
                arabic_font = 'DejaVu'
            except:
                arabic_font = 'Helvetica'
        
        styles = getSampleStyleSheet()
        
        # Ù†Ù…Ø· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        title_style = ParagraphStyle(
            'ArabicTitle',
            parent=styles['Heading1'],
            fontName=arabic_font,
            fontSize=16,
            textColor=colors.HexColor('#2c3e50'),
            alignment=TA_CENTER,
            spaceAfter=20,
            leading=24
        )
        
        # Ù†Ù…Ø· Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
        normal_style = ParagraphStyle(
            'ArabicNormal',
            parent=styles['Normal'],
            fontName=arabic_font,
            fontSize=10,
            textColor=colors.black,
            alignment=TA_RIGHT,
            spaceAfter=8,
            leading=14,
            rightIndent=10
        )
        
        # Ù†Ù…Ø· Ù„Ù„Ù‚ÙŠÙ… (Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„ÙŠØ³Ø§Ø±)
        value_style = ParagraphStyle(
            'ValueStyle',
            parent=styles['Normal'],
            fontName=arabic_font,
            fontSize=10,
            textColor=colors.black,
            alignment=TA_LEFT,
            spaceAfter=8,
            leading=14,
            leftIndent=10
        )
        
        content = []
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        header = Paragraph(arabic_text(f"<b>{title}</b>"), title_style)
        content.append(header)
        content.append(Spacer(1, 15))
        
        # Ø®Ø· ÙØ§ØµÙ„
        separator_line = Table([['']], colWidths=[500])
        separator_line.setStyle(TableStyle([
            ('LINEBELOW', (0, 0), (-1, 0), 1, colors.HexColor('#3498db')),
        ]))
        content.append(separator_line)
        content.append(Spacer(1, 20))
        
        # ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¬Ø¯ÙˆÙ„
        data = []
        
        # Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        data.append([
            Paragraph(arabic_text("Ø§Ù„Ù‚ÙŠÙ…Ø©"), value_style),
            Paragraph(arabic_text("Ø§Ù„Ø¨ÙŠØ§Ù†"), normal_style)
        ])
        
        # Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
        for key, value in details.items():
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ø§Ù„ÙŠØ§Ù‹
            display_value = str(value)
            if any(currency in str(value) for currency in ['$', 'Ø¯ÙŠÙ†Ø§Ø±', 'Ø¯.Ø¹']):
                # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø¹Ù…Ù„Ø©ØŒ Ø§ØªØ±ÙƒÙ‡ ÙƒÙ…Ø§ Ù‡Ùˆ
                pass
            elif key in ['Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', 'Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©', 
                        'Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹', 
                        'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¯ÙØ¹Ù‡', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ']:
                # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ
                try:
                    if '$' in str(value):
                        num_value = float(str(value).replace('$', '').strip())
                        display_value = format_currency(num_value, "Ø¯ÙŠÙ†Ø§Ø±")
                    else:
                        num_value = float(value)
                        display_value = format_currency(num_value, "Ø¯ÙŠÙ†Ø§Ø±")
                except:
                    pass
            
            data.append([
                Paragraph(arabic_text(display_value), value_style),
                Paragraph(arabic_text(key), normal_style)
            ])
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        table = Table(data, colWidths=[250, 250])
        table.setStyle(TableStyle([
            # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø£Ø³
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#2c3e50')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (-1, 0), 'CENTER'),
            ('FONTNAME', (0, 0), (-1, 0), arabic_font),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            
            # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
            ('FONTNAME', (0, 1), (-1, -1), arabic_font),
            ('FONTSIZE', (0, 1), (-1, -1), 10),
            ('GRID', (0, 0), (-1, -1), 1, colors.grey),
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('TOPPADDING', (0, 1), (-1, -1), 6),
            ('BOTTOMPADDING', (0, 1), (-1, -1), 6),
        ]))
        
        content.append(table)
        content.append(Spacer(1, 25))
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
        date_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        footer_text = arabic_text(f"ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: {date_time}")
        footer = Paragraph(footer_text, normal_style)
        content.append(footer)
        
        # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ†Ø¯
        doc.build(content)
        messagebox.showinfo("Ù†Ø¬Ø§Ø­", f"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­:\n{filename}")
        logging.info(f"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ PDF: {filename}")
        
        # ÙØªØ­ Ø§Ù„Ù…Ù„Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        try:
            os.startfile(filename)
        except:
            pass
            
    except Exception as e:
        messagebox.showerror("Ø®Ø·Ø£", f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: {str(e)}")
        logging.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: {str(e)}")

# ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
def hash_password(password):
    return hashlib.sha256(password.encode()).hexdigest()

class ModernWorkshopApp:
    def __init__(self, root):
        self.root = root
        self.root.title("Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ±Ø´Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ")
        self.root.geometry("1200x800")
        self.root.configure(bg='#2c3e50')
        
        self.center_window(self.root)
        
        self.colors = {
            'primary': '#3498db',
            'secondary': '#2ecc71',
            'danger': '#e74c3c',
            'warning': '#f39c12',
            'dark': '#2c3e50',
            'light': '#ecf0f1',
            'success': '#27ae60',
            'info': '#17a2b8',
            'purple': '#6f42c1'
        }
        
        self.setup_styles()
        self.password_hash = hash_password("workshop123")
        
        self.create_login_window()

    def center_window(self, window):
        window.update_idletasks()
        width = window.winfo_width()
        height = window.winfo_height()
        x = (window.winfo_screenwidth() // 2) - (width // 2)
        y = (window.winfo_screenheight() // 2) - (height // 2)
        window.geometry('{}x{}+{}+{}'.format(width, height, x, y))

    def setup_styles(self):
        style = ttk.Style()
        style.theme_use('clam')
        
        style.configure('Primary.TButton', 
                        background=self.colors['primary'],
                        foreground='white',
                        font=('Arial', 10, 'bold'),
                        padding=10)
        
        style.configure('Success.TButton',
                        background=self.colors['success'],
                        foreground='white',
                        font=('Arial', 10, 'bold'),
                        padding=10)
        
        style.configure('Danger.TButton',
                        background=self.colors['danger'],
                        foreground='white',
                        font=('Arial', 10, 'bold'),
                        padding=10)

    def create_login_window(self):
        self.login_window = tk.Toplevel(self.root)
        self.login_window.title("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ")
        self.login_window.geometry("400x300")
        self.login_window.configure(bg=self.colors['dark'])
        self.login_window.resizable(False, False)
        self.center_window(self.login_window)
        
        self.login_window.transient(self.root)
        self.login_window.grab_set()
        
        title_frame = tk.Frame(self.login_window, bg=self.colors['dark'])
        title_frame.pack(pady=30)
        
        tk.Label(title_frame, text="Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ±Ø´Ø©", 
                 font=('Arial', 18, 'bold'), 
                 bg=self.colors['dark'], 
                 fg='white').pack()
        
        tk.Label(title_frame, text="Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ v2.0", 
                 font=('Arial', 12), 
                 bg=self.colors['dark'], 
                 fg=self.colors['primary']).pack()
        
        input_frame = tk.Frame(self.login_window, bg=self.colors['dark'])
        input_frame.pack(pady=40)
        
        tk.Label(input_frame, text="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:", 
                 font=('Arial', 12, 'bold'), 
                 bg=self.colors['dark'], 
                 fg='white').grid(row=0, column=0, padx=10, pady=10, sticky='e')
        
        self.password_entry = tk.Entry(input_frame, show="*", 
                                       font=('Arial', 12), 
                                       width=20,
                                       bg=self.colors['light'])
        self.password_entry.grid(row=0, column=1, padx=10, pady=10)
        self.password_entry.bind('<Return>', lambda e: self.check_password())
        self.password_entry.focus()
        
        btn_frame = tk.Frame(self.login_window, bg=self.colors['dark'])
        btn_frame.pack(pady=20)
        
        ttk.Button(btn_frame, text="Ø¯Ø®ÙˆÙ„", 
                   style='Primary.TButton',
                   command=self.check_password).pack(side=tk.LEFT, padx=10)
        
        ttk.Button(btn_frame, text="Ø®Ø±ÙˆØ¬", 
                   style='Danger.TButton',
                   command=self.root.quit).pack(side=tk.LEFT, padx=10)
        
        self.root.withdraw()

    def check_password(self):
        if hash_password(self.password_entry.get()) == self.password_hash:
            logging.info("ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­")
            self.login_window.destroy()
            self.root.deiconify()
            self.build_main_window()
        else:
            messagebox.showerror("Ø®Ø·Ø£", "ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!")
            self.password_entry.delete(0, tk.END)
            logging.warning("Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙØ§Ø´Ù„Ø©")

    def build_main_window(self):
        self.create_menubar()
        
        title_frame = tk.Frame(self.root, bg=self.colors['dark'], height=100)
        title_frame.pack(fill=tk.X, padx=10, pady=10)
        title_frame.pack_propagate(False)
        
        tk.Label(title_frame, text="Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ±Ø´Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ", 
                 font=('Arial', 20, 'bold'), 
                 bg=self.colors['dark'], 
                 fg='white').pack(expand=True)
        
        tk.Label(title_frame, text=f"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ - {datetime.now().strftime('%Y-%m-%d %H:%M')}", 
                 font=('Arial', 12), 
                 bg=self.colors['dark'], 
                 fg=self.colors['primary']).pack()
        
        self.create_dashboard()
        self.create_quick_actions()

    def create_menubar(self):
        menubar = tk.Menu(self.root, bg=self.colors['light'], fg=self.colors['dark'])
        
        file_menu = tk.Menu(menubar, tearoff=0, bg='white', fg='black')
        file_menu.add_command(label="ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", command=self.export_data)
        file_menu.add_command(label="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", command=self.import_data)
        file_menu.add_separator()
        file_menu.add_command(label="Ø®Ø±ÙˆØ¬", command=self.root.quit)
        menubar.add_cascade(label="Ù…Ù„Ù", menu=file_menu)
        
        view_menu = tk.Menu(menubar, tearoff=0, bg='white', fg='black')
        view_menu.add_command(label="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…", command=self.show_dashboard)
        view_menu.add_command(label="Ø¹Ø±Ø¶ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª", command=self.show_repairs)
        view_menu.add_command(label="Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª", command=self.show_sales)
        view_menu.add_command(label="Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", command=self.show_products)
        view_menu.add_command(label="Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±", command=self.show_reports)
        menubar.add_cascade(label="Ø¹Ø±Ø¶", menu=view_menu)
        
        add_menu = tk.Menu(menubar, tearoff=0, bg='white', fg='black')
        add_menu.add_command(label="Ø¥Ø¶Ø§ÙØ© ØµÙŠØ§Ù†Ø©", command=self.add_repair)
        add_menu.add_command(label="Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ¹", command=self.add_sale)
        add_menu.add_command(label="Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬", command=self.add_product)
        add_menu.add_command(label="Ø¯ÙØ¹ Ù‚Ø³Ø·", command=self.pay_installment)
        menubar.add_cascade(label="Ø¥Ø¶Ø§ÙØ©", menu=add_menu)
        
        settings_menu = tk.Menu(menubar, tearoff=0, bg='white', fg='black')
        settings_menu.add_command(label="ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", command=self.change_password)
        settings_menu.add_command(label="Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ", command=self.backup_data)
        menubar.add_cascade(label="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", menu=settings_menu)
        
        self.root.config(menu=menubar)

    def create_dashboard(self):
        dashboard_frame = tk.Frame(self.root, bg='white', relief='raised', bd=2)
        dashboard_frame.pack(fill=tk.X, padx=20, pady=10)
        
        tk.Label(dashboard_frame, text="Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©", 
                 font=('Arial', 14, 'bold'), 
                 bg='white').pack(pady=10)
        
        stats_frame = tk.Frame(dashboard_frame, bg='white')
        stats_frame.pack(fill=tk.X, padx=20, pady=10)
        
        with sqlite3.connect('workshop.db') as conn:
            c = conn.cursor()
            
            c.execute("SELECT COUNT(*) FROM repairs WHERE status='Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­'")
            pending_repairs = c.fetchone()[0]
            
            c.execute("SELECT COUNT(*) FROM sales WHERE sale_type='Ø£Ù‚Ø³Ø§Ø·' AND installments_remaining > 0")
            pending_installments = c.fetchone()[0]
            
            c.execute("SELECT SUM(amount) FROM sales WHERE strftime('%Y-%m', sale_date)=strftime('%Y-%m', 'now')")
            monthly_sales = c.fetchone()[0] or 0
            
            c.execute("SELECT COUNT(*) FROM products WHERE quantity > 0")
            available_products = c.fetchone()[0]
            
            c.execute("SELECT SUM(final_cost) FROM repairs WHERE exit_date IS NOT NULL AND strftime('%Y-%m', exit_date)=strftime('%Y-%m', 'now')")
            monthly_repairs_revenue = c.fetchone()[0] or 0
        
        # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø¥Ù„Ù‰ Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ
        monthly_sales_iqd = format_currency(monthly_sales, "Ø¯ÙŠÙ†Ø§Ø±")
        monthly_repairs_revenue_iqd = format_currency(monthly_repairs_revenue, "Ø¯ÙŠÙ†Ø§Ø±")
        
        stats_data = [
            ("Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©", pending_repairs, self.colors['warning']),
            ("Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©", pending_installments, self.colors['danger']),
            ("Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©", monthly_sales_iqd, self.colors['success']),
            ("Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø§Øª", monthly_repairs_revenue_iqd, self.colors['info']),
            ("Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©", available_products, self.colors['primary'])
        ]
        
        for i, (title, value, color) in enumerate(stats_data):
            stat_card = tk.Frame(stats_frame, bg=color, relief='raised', bd=2)
            stat_card.grid(row=0, column=i, padx=10, pady=5, sticky='ew')
            
            tk.Label(stat_card, text=title, font=('Arial', 10, 'bold'), 
                     bg=color, fg='white').pack(pady=(10, 0))
            tk.Label(stat_card, text=str(value), font=('Arial', 12, 'bold'), 
                     bg=color, fg='white').pack(pady=(0, 10))
            
            stats_frame.columnconfigure(i, weight=1)

    def create_quick_actions(self):
        actions_frame = tk.Frame(self.root, bg='white', relief='raised', bd=2)
        actions_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=10)
        
        tk.Label(actions_frame, text="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©", 
                 font=('Arial', 14, 'bold'), 
                 bg='white').pack(pady=10)
        
        buttons = [
            ("Ø¥Ø¶Ø§ÙØ© ØµÙŠØ§Ù†Ø©", self.colors['primary'], self.add_repair),
            ("Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ¹", self.colors['success'], self.add_sale),
            ("Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬", self.colors['secondary'], self.add_product),
            ("Ø¹Ø±Ø¶ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª", self.colors['warning'], self.show_repairs),
            ("Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª", self.colors['info'], self.show_sales),
            ("Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", self.colors['dark'], self.show_products),
            ("Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±", self.colors['purple'], self.show_reports),
            ("Ø¯ÙØ¹ Ø£Ù‚Ø³Ø§Ø·", self.colors['danger'], self.pay_installment)
        ]
        
        btn_frame = tk.Frame(actions_frame, bg='white')
        btn_frame.pack(expand=True)
        
        for i, (text, color, command) in enumerate(buttons):
            btn = tk.Button(btn_frame, text=text, font=('Arial', 11, 'bold'),
                            bg=color, fg='white', relief='raised', bd=2,
                            command=command, width=15, height=2)
            btn.grid(row=i//4, column=i%4, padx=8, pady=8, sticky='nsew')
            btn_frame.columnconfigure(i%4, weight=1)
            btn_frame.rowconfigure(i//4, weight=1)

    def add_product(self):
        window = tk.Toplevel(self.root)
        window.title("Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯")
        window.geometry("500x500")
        window.configure(bg='white')
        self.center_window(window)
        
        title_label = tk.Label(window, text="Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯", 
                               font=('Arial', 16, 'bold'), bg='white')
        title_label.pack(pady=20)
        
        form_frame = tk.Frame(window, bg='white')
        form_frame.pack(fill=tk.BOTH, expand=True, padx=30)
        
        fields = [
            ("Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:", "entry"),
            ("Ø§Ù„ÙØ¦Ø©:", "entry"),
            ("Ø§Ù„Ø³Ø¹Ø± ($):", "entry"),
            ("Ø§Ù„ÙƒÙ…ÙŠØ©:", "entry"),
            ("Ø§Ù„ÙˆØµÙ:", "text")
        ]
        
        entries = {}
        for i, (label, field_type) in enumerate(fields):
            tk.Label(form_frame, text=label, font=('Arial', 11), 
                     bg='white').grid(row=i, column=0, sticky='e', pady=8, padx=10)
            
            if field_type == "entry":
                entry = tk.Entry(form_frame, font=('Arial', 11), bg='#f8f9fa')
                entry.grid(row=i, column=1, sticky='ew', pady=8, padx=10)
            else:
                entry = tk.Text(form_frame, height=3, width=30, font=('Arial', 11), bg='#f8f9fa')
                entry.grid(row=i, column=1, sticky='ew', pady=8, padx=10)
            
            entries[label] = entry
        
        form_frame.columnconfigure(1, weight=1)
        
        def save():
            try:
                product_name = entries["Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:"].get().strip()
                if not product_name:
                    raise ValueError("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬")
                
                price = float(entries["Ø§Ù„Ø³Ø¹Ø± ($):"].get() or 0)
                quantity = int(entries["Ø§Ù„ÙƒÙ…ÙŠØ©:"].get() or 0)
                
                with sqlite3.connect('workshop.db') as conn:
                    c = conn.cursor()
                    c.execute('''INSERT INTO products 
                              (product_name, category, price, quantity, description, created_date, last_updated) 
                              VALUES (?, ?, ?, ?, ?, ?, ?)''',
                             (product_name,
                              entries["Ø§Ù„ÙØ¦Ø©:"].get().strip(),
                              price,
                              quantity,
                              entries["Ø§Ù„ÙˆØµÙ:"].get("1.0", tk.END).strip(),
                              datetime.now().date(),
                              datetime.now().date()))
                    conn.commit()
                
                messagebox.showinfo("Ù†Ø¬Ø§Ø­", "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!")
                logging.info(f"ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬: {product_name}")
                window.destroy()
                self.show_dashboard()
            except sqlite3.IntegrityError:
                messagebox.showerror("Ø®Ø·Ø£", "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹!")
            except ValueError as ve:
                messagebox.showerror("Ø®Ø·Ø£", str(ve))
            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: {str(e)}")
                logging.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬: {str(e)}")
        
        btn_frame = tk.Frame(window, bg='white')
        btn_frame.pack(pady=20)
        
        tk.Button(btn_frame, text="Ø­ÙØ¸", bg=self.colors['success'], fg='white',
                  font=('Arial', 11, 'bold'), command=save, width=10).pack(side=tk.LEFT, padx=10)
        
        tk.Button(btn_frame, text="Ø¥Ù„ØºØ§Ø¡", bg=self.colors['danger'], fg='white',
                  font=('Arial', 11, 'bold'), command=window.destroy, width=10).pack(side=tk.LEFT, padx=10)

    # Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ (show_products, add_sale, add_repair, show_repairs, show_sales, pay_installment, show_reports)
    # Ø³ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³ÙŠØ·Ø© ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
    
    def add_sale(self):
        window = tk.Toplevel(self.root)
        window.title("Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯")
        window.geometry("600x500")
        window.configure(bg='white')
        self.center_window(window)
        
        title_label = tk.Label(window, text="Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯", 
                               font=('Arial', 16, 'bold'), bg='white')
        title_label.pack(pady=20)
        
        form_frame = tk.Frame(window, bg='white')
        form_frame.pack(fill=tk.BOTH, expand=True, padx=30)
        
        tk.Label(form_frame, text="Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬:", font=('Arial', 11), bg='white').grid(row=0, column=0, sticky='e', pady=8)
        
        with sqlite3.connect('workshop.db') as conn:
            c = conn.cursor()
            c.execute("SELECT id, product_name, price, quantity FROM products WHERE quantity > 0")
            products = c.fetchall()
        
        product_var = tk.StringVar()
        product_combo = ttk.Combobox(form_frame, textvariable=product_var, font=('Arial', 11))
        product_combo['values'] = [f"{p[0]} - {p[1]} (${p[2]}) - Ù…ØªÙˆÙØ±: {p[3]}" for p in products]
        product_combo.grid(row=0, column=1, sticky='ew', pady=8, padx=10)
        
        fields = [
            ("Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†:", "entry"),
            ("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:", "entry"),
            ("Ø§Ù„ÙƒÙ…ÙŠØ©:", "entry"),
            ("Ù…Ù„Ø§Ø­Ø¸Ø§Øª:", "text")
        ]
        
        entries = {}
        for i, (label, field_type) in enumerate(fields, 1):
            tk.Label(form_frame, text=label, font=('Arial', 11), 
                     bg='white').grid(row=i, column=0, sticky='e', pady=8, padx=10)
            
            if field_type == "entry":
                entry = tk.Entry(form_frame, font=('Arial', 11), bg='#f8f9fa')
                entry.grid(row=i, column=1, sticky='ew', pady=8, padx=10)
            else:
                entry = tk.Text(form_frame, height=3, width=30, font=('Arial', 11), bg='#f8f9fa')
                entry.grid(row=i, column=1, sticky='ew', pady=8, padx=10)
            
            entries[label] = entry
        
        tk.Label(form_frame, text="Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ¹:", font=('Arial', 11), bg='white').grid(row=5, column=0, sticky='e', pady=8)
        sale_type_var = tk.StringVar(value="Ù†Ù‚Ø¯ÙŠ")
        sale_type_frame = tk.Frame(form_frame, bg='white')
        sale_type_frame.grid(row=5, column=1, sticky='w', pady=8, padx=10)
        ttk.Radiobutton(sale_type_frame, text="Ù†Ù‚Ø¯ÙŠ", variable=sale_type_var, value="Ù†Ù‚Ø¯ÙŠ").pack(side=tk.LEFT)
        ttk.Radiobutton(sale_type_frame, text="Ø£Ù‚Ø³Ø§Ø·", variable=sale_type_var, value="Ø£Ù‚Ø³Ø§Ø·").pack(side=tk.LEFT)
        
        tk.Label(form_frame, text="Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:", font=('Arial', 11), bg='white').grid(row=6, column=0, sticky='e', pady=8)
        installments_entry = tk.Entry(form_frame, font=('Arial', 11), bg='#f8f9fa')
        installments_entry.grid(row=6, column=1, sticky='ew', pady=8, padx=10)
        installments_entry.insert(0, "0")
        
        form_frame.columnconfigure(1, weight=1)
        
        def save():
            try:
                if not product_var.get():
                    raise ValueError("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬")
                
                product_id = int(product_var.get().split(' - ')[0])
                quantity = int(entries["Ø§Ù„ÙƒÙ…ÙŠØ©:"].get() or 0)
                
                if quantity <= 0:
                    raise ValueError("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©")
                
                with sqlite3.connect('workshop.db') as conn:
                    c = conn.cursor()
                    
                    c.execute("SELECT quantity, price, product_name FROM products WHERE id=?", (product_id,))
                    product = c.fetchone()
                    
                    if not product:
                        raise ValueError("Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯")
                    
                    if product[0] < quantity:
                        raise ValueError(f"Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©. Ø§Ù„Ù…ØªÙˆÙØ±: {product[0]}")
                    
                    c.execute("UPDATE products SET quantity = quantity - ?, last_updated = ? WHERE id=?", 
                              (quantity, datetime.now().date(), product_id))
                    
                    total_amount = product[1] * quantity
                    installments = int(installments_entry.get()) if sale_type_var.get() == "Ø£Ù‚Ø³Ø§Ø·" else 0
                    
                    c.execute('''INSERT INTO sales 
                              (product_id, device_name, customer_name, customer_phone, sale_type, 
                              installments_remaining, sale_date, amount, notes) 
                              VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)''',
                             (product_id,
                              product[2],
                              entries["Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†:"].get().strip(),
                              entries["Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:"].get().strip(),
                              sale_type_var.get(),
                              installments,
                              datetime.now().date(),
                              total_amount,
                              entries["Ù…Ù„Ø§Ø­Ø¸Ø§Øª:"].get("1.0", tk.END).strip()))
                    conn.commit()
                
                # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¥Ù„Ù‰ Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ ÙÙŠ Ø§Ù„Ø¥ÙŠØµØ§Ù„
                unit_price_iqd = format_currency(product[1], "Ø¯ÙŠÙ†Ø§Ø±")
                total_amount_iqd = format_currency(total_amount, "Ø¯ÙŠÙ†Ø§Ø±")
                
                details = {
                    "Ø§Ù„Ù…Ù†ØªØ¬": product[2],
                    "Ø§Ù„Ø²Ø¨ÙˆÙ†": entries["Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†:"].get(),
                    "Ø§Ù„Ù‡Ø§ØªÙ": entries["Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:"].get(),
                    "Ø§Ù„ÙƒÙ…ÙŠØ©": quantity,
                    "Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©": unit_price_iqd,
                    "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ": total_amount_iqd,
                    "Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ¹": sale_type_var.get(),
                    "Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©": installments
                }
                print_pdf("Ø§ÙŠØµØ§Ù„ Ø¨ÙŠØ¹", details)
                
                messagebox.showinfo("Ù†Ø¬Ø§Ø­", "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!")
                logging.info(f"ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ù†ØªØ¬ ID: {product_id}")
                window.destroy()
                self.show_dashboard()
                
            except ValueError as ve:
                messagebox.showerror("Ø®Ø·Ø£", str(ve))
            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: {str(e)}")
                logging.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ¹: {str(e)}")
        
        btn_frame = tk.Frame(window, bg='white')
        btn_frame.pack(pady=20)
        
        tk.Button(btn_frame, text="Ø­ÙØ¸ ÙˆØ·Ø¨Ø§Ø¹Ø©", bg=self.colors['success'], fg='white',
                  font=('Arial', 11, 'bold'), command=save, width=12).pack(side=tk.LEFT, padx=10)
        
        tk.Button(btn_frame, text="Ø¥Ù„ØºØ§Ø¡", bg=self.colors['danger'], fg='white',
                  font=('Arial', 11, 'bold'), command=window.destroy, width=10).pack(side=tk.LEFT, padx=10)

    # Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø³ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³ÙŠØ·Ø© ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
    
    def show_reports(self):
        window = tk.Toplevel(self.root)
        window.title("Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª")
        window.geometry("700x700")
        window.configure(bg='white')
        self.center_window(window)
        
        header_frame = tk.Frame(window, bg=self.colors['purple'], height=80)
        header_frame.pack(fill=tk.X)
        header_frame.pack_propagate(False)
        
        tk.Label(header_frame, text="ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª", 
                 font=('Arial', 18, 'bold'), 
                 bg=self.colors['purple'], 
                 fg='white').pack(expand=True)
        
        report_frame = tk.Frame(window, bg='white')
        report_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        with sqlite3.connect('workshop.db') as conn:
            c = conn.cursor()
            
            c.execute("SELECT COUNT(*) FROM repairs")
            total_repairs = c.fetchone()[0]
            
            c.execute("SELECT COUNT(*) FROM repairs WHERE status='Ù…ÙƒØªÙ…Ù„Ø©'")
            completed_repairs = c.fetchone()[0]
            
            c.execute("SELECT COUNT(*) FROM repairs WHERE status='Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­'")
            pending_repairs = c.fetchone()[0]
            
            c.execute("SELECT SUM(final_cost) FROM repairs WHERE status='Ù…ÙƒØªÙ…Ù„Ø©'")
            total_repairs_revenue = c.fetchone()[0] or 0
            
            c.execute("SELECT COUNT(*) FROM sales")
            total_sales = c.fetchone()[0]
            
            c.execute("SELECT SUM(amount) FROM sales")
            total_revenue = c.fetchone()[0] or 0
            
            c.execute("SELECT SUM(amount) FROM sales WHERE strftime('%Y-%m', sale_date)=strftime('%Y-%m', 'now')")
            monthly_revenue = c.fetchone()[0] or 0
            
            c.execute("SELECT SUM(paid_amount) FROM sales")
            total_paid = c.fetchone()[0] or 0
            
            c.execute("SELECT COUNT(*) FROM products")
            total_products = c.fetchone()[0]
            
            c.execute("SELECT SUM(quantity) FROM products")
            total_quantity = c.fetchone()[0] or 0
            
            c.execute("SELECT COUNT(*) FROM products WHERE quantity < 5")
            low_stock = c.fetchone()[0]
        
        # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø¥Ù„Ù‰ Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ
        total_repairs_revenue_iqd = format_currency(total_repairs_revenue, "Ø¯ÙŠÙ†Ø§Ø±")
        total_revenue_iqd = format_currency(total_revenue, "Ø¯ÙŠÙ†Ø§Ø±")
        monthly_revenue_iqd = format_currency(monthly_revenue, "Ø¯ÙŠÙ†Ø§Ø±")
        total_paid_iqd = format_currency(total_paid, "Ø¯ÙŠÙ†Ø§Ø±")
        remaining_amount_iqd = format_currency(total_revenue - total_paid, "Ø¯ÙŠÙ†Ø§Ø±")
        
        categories = [
            ("ğŸ“‹ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª", [
                ("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª", total_repairs, 'primary'),
                ("Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©", completed_repairs, 'success'),
                ("Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­", pending_repairs, 'warning'),
                ("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø§Øª", total_repairs_revenue_iqd, 'info')
            ]),
            ("ğŸ’° Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª", [
                ("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª", total_sales, 'primary'),
                ("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª", total_revenue_iqd, 'success'),
                ("Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ", monthly_revenue_iqd, 'info'),
                ("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©", total_paid_iqd, 'secondary'),
                ("Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©", remaining_amount_iqd, 'danger')
            ]),
            ("ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", [
                ("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", total_products, 'primary'),
                ("Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©", total_quantity, 'success'),
                ("Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†", low_stock, 'warning')
            ])
        ]
        
        for category_name, items in categories:
            cat_frame = tk.LabelFrame(report_frame, text=category_name, 
                                     font=('Arial', 12, 'bold'),
                                     bg='white', fg=self.colors['dark'],
                                     relief='raised', bd=2)
            cat_frame.pack(fill=tk.X, pady=10)
            
            for title, value, color in items:
                item_frame = tk.Frame(cat_frame, bg='white')
                item_frame.pack(fill=tk.X, padx=15, pady=5)
                
                tk.Label(item_frame, text=title, 
                        font=('Arial', 11), 
                        bg='white',
                        anchor='w').pack(side=tk.LEFT)
                
                tk.Label(item_frame, text=str(value), 
                        font=('Arial', 11, 'bold'), 
                        bg='white',
                        fg=self.colors[color],
                        anchor='e').pack(side=tk.RIGHT)
        
        def export_report():
            reports = [
                ("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø§Øª", total_repairs),
                ("Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©", completed_repairs),
                ("Ø§Ù„ØµÙŠØ§Ù†Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­", pending_repairs),
                ("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø§Øª", total_repairs_revenue_iqd),
                ("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª", total_sales),
                ("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª", total_revenue_iqd),
                ("Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±", monthly_revenue_iqd),
                ("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", total_products),
                ("Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©", total_quantity),
                ("Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†", low_stock)
            ]
            
            filename = f"report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
            with open(filename, 'w', newline='', encoding='utf-8-sig') as file:
                writer = csv.writer(file)
                writer.writerow(['Ø§Ù„ØªÙ‚Ø±ÙŠØ±', 'Ø§Ù„Ù‚ÙŠÙ…Ø©'])
                for title, value in reports:
                    writer.writerow([title, value])
            
            messagebox.showinfo("Ù†Ø¬Ø§Ø­", f"ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰:\n{filename}")
            logging.info(f"ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±: {filename}")
        
        btn_frame = tk.Frame(window, bg='white')
        btn_frame.pack(pady=15)
        
        tk.Button(btn_frame, text="ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±", bg=self.colors['primary'], fg='white',
                  font=('Arial', 11, 'bold'), command=export_report, width=15).pack(side=tk.LEFT, padx=5)
        tk.Button(btn_frame, text="Ø¥ØºÙ„Ø§Ù‚", bg=self.colors['danger'], fg='white',
                  font=('Arial', 11, 'bold'), command=window.destroy, width=10).pack(side=tk.LEFT, padx=5)

    # Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ (change_password, backup_data, export_data, import_data, show_dashboard)
    # Ø³ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ

if __name__ == "__main__":
    root = tk.Tk()
    app = ModernWorkshopApp(root)
    root.mainloop()
