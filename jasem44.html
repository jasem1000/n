<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ÙƒØ§Ø´ÙŠØ± Ø§Ù„Ù„Ø­ÙˆÙ… Ø§Ù„Ù…Ø¬Ù…Ø¯Ø© (Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ)</title>
    
    <style>
        /* --- CSS Styling (Professional Look) --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5; /* Light background */
            color: #333;
            margin: 0;
            padding: 20px;
            direction: rtl; /* Right-to-left for Arabic */
            text-align: right;
        }

        header {
            background-color: #7b0000; /* Dark Red/Maroon for Meat Theme */
            color: white;
            padding: 15px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        section {
            background-color: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-top: 5px solid #7b0000;
        }

        input[type="text"], input[type="password"] {
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 250px;
            box-sizing: border-box;
            text-align: right;
            font-size: 16px;
        }

        button {
            background-color: #1abc9c; /* Greenish button for action/sale */
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #14a383;
        }

        #complete-sale-btn {
            background-color: #2980b9; /* Blue for 'Complete Sale' */
        }
        #complete-sale-btn:hover {
            background-color: #2471a3;
        }

        #reports-access button {
            background-color: #e67e22; /* Orange for 'Reports' */
        }
        #reports-access button:hover {
            background-color: #d35400;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            border: 1px solid #e0e0e0;
            padding: 10px;
            text-align: right;
        }

        th {
            background-color: #f9f9f9;
            font-weight: 600;
        }

        .hidden {
            display: none;
        }

        #total-amount {
            font-size: 1.8em;
            font-weight: bold;
            color: #7b0000;
            margin-top: 10px;
            display: block;
        }

        #profit-summary p {
            font-size: 1.1em;
            font-weight: bold;
            padding: 5px 0;
        }
    </style>
</head>
<body>
    <header>
        <h1>Ù†Ø¸Ø§Ù… ÙƒØ§Ø´ÙŠØ± Ù…ØªØ¬Ø± Ø§Ù„Ù„Ø­ÙˆÙ… Ø§Ù„Ù…Ø¬Ù…Ø¯Ø© ğŸ‡®ğŸ‡¶</h1>
    </header>

    <section id="cashier-interface">
        <h2>Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ§Ø´ÙŠØ±</h2>
        <input type="text" id="barcode-input" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù‡Ù†Ø§" autofocus>
        <button onclick="addItemByBarcode()">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>

        <div id="cart">
            <h3>Ø³Ù„Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    </tr>
                </thead>
                <tbody id="cart-items">
                </tbody>
            </table>
            <p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</p> 
            <span id="total-amount">0.00 Ø¯.Ø¹</span>
        </div>

        <button id="complete-sale-btn" onclick="completeSale()">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹</button>
    </section>

    <section id="reports-access">
        <h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
        <input type="password" id="report-code" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ (22)">
        <button onclick="accessReports()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    </section>

    <section id="reports-section" class="hidden">
        <h2>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø£Ø±Ø¨Ø§Ø­</h2>
        <div id="profit-summary">
            <p>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…ÙŠ: <span id="daily-profit">0.00 Ø¯.Ø¹</span></p>
            <p>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø´Ù‡Ø±ÙŠ: <span id="monthly-profit">0.00 Ø¯.Ø¹</span></p>
            <p>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø³Ù†ÙˆÙŠ: <span id="yearly-profit">0.00 Ø¯.Ø¹</span></p>
        </div>

        <h3>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª)</h3>
        <table id="product-reports-table">
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                    <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                    <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</th>
                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th>
                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>

        <button onclick="resetStatistics()" style="background-color: #e74c3c; margin-top: 20px;">Ø­Ø°Ù Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
    </section>

    <section id="inventory-management">
        <h2>Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
        <p>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø®Ø²Ù†Ø© ÙÙŠ ÙƒÙˆØ¯ JavaScript. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ ÙÙŠ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³Ù…Ù‰ <code>inventory</code>.</p>
    </section>

    <script>
        // --- JavaScript Logic (With IQD Support) ---

        const CURRENCY = ' Ø¯.Ø¹'; // Iraqi Dinar (IQD)
        const REPORT_CODE = '22';

        // Helper function to safely get data from localStorage or return a default
        const getLocalStorageData = (key, defaultValue) => {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : defaultValue;
        };

        // --- DATA STRUCTURES (Stored in localStorage) ---
        // Simulating the inventory (Barcode, Name, Stock, Purchase Price, Sale Price)
        let inventory = getLocalStorageData('inventory', {
            "123456789012": { name: "Ù„Ø­Ù… Ø¨Ù‚Ø±ÙŠ Ù…ÙØ±ÙˆÙ… (1ÙƒØº)", stock: 50, purchasePrice: 9000.00, salePrice: 12000.00 },
            "234567890123": { name: "Ø¯Ø¬Ø§Ø¬ Ù…Ø¬Ù…Ø¯ (500Øº)", stock: 100, purchasePrice: 4500.00, salePrice: 6000.00 },
            "345678901234": { name: "Ø£Ø³Ù…Ø§Ùƒ ÙÙŠÙ„ÙŠÙ‡ Ù…Ø¬Ù…Ø¯Ø©", stock: 30, purchasePrice: 15000.00, salePrice: 18500.00 }
        });

        // Sales History (Stored as a list of completed transactions)
        let salesHistory = getLocalStorageData('salesHistory', []);

        // Current Cart
        let currentCart = []; // { barcode, quantity, name, salePrice, purchasePrice }

        // --- CORE FUNCTIONS ---

        // Update localStorage for persistence
        const updateLocalStorage = () => {
            localStorage.setItem('inventory', JSON.stringify(inventory));
            localStorage.setItem('salesHistory', JSON.stringify(salesHistory));
        };

        // Render the current cart to the HTML table
        const renderCart = () => {
            const cartItemsElement = document.getElementById('cart-items');
            cartItemsElement.innerHTML = '';
            let total = 0;

            currentCart.forEach(item => {
                const itemTotal = item.quantity * item.salePrice;
                total += itemTotal;

                const row = cartItemsElement.insertRow();
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.salePrice.toFixed(2) + CURRENCY}</td>
                    <td>${itemTotal.toFixed(2) + CURRENCY}</td>
                `;
            });

            document.getElementById('total-amount').textContent = total.toFixed(2) + CURRENCY;
        };

        // Function to add item to cart by barcode
        const addItemByBarcode = () => {
            const barcodeInput = document.getElementById('barcode-input');
            const barcode = barcodeInput.value.trim();
            barcodeInput.value = ''; // Clear input
            barcodeInput.focus(); // Keep focus for scanner

            const product = inventory[barcode];
            if (!product) {
                alert('Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†!');
                return;
            }

            if (product.stock <= 0) {
                alert(`Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù†ÙØ¯ Ù…Ù† ${product.name}!`);
                return;
            }

            const cartItemIndex = currentCart.findIndex(item => item.barcode === barcode);

            if (cartItemIndex > -1) {
                // Check if adding one more exceeds stock (only if quantity in cart < stock)
                if (currentCart[cartItemIndex].quantity < product.stock) {
                    currentCart[cartItemIndex].quantity += 1;
                } else {
                    alert(`Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…ØªÙˆÙØ± Ù‡Ùˆ ${product.stock} ÙˆØ­Ø¯Ø§Øª.`);
                    return;
                }
            } else {
                currentCart.push({
                    barcode: barcode,
                    quantity: 1,
                    name: product.name,
                    salePrice: product.salePrice,
                    purchasePrice: product.purchasePrice
                });
            }
            
            // NOTE: Stock deduction will be finalized on completeSale.
            // No temporary deduction needed here, as we check against initial stock above.

            renderCart();
        };

        // Complete the Sale
        const completeSale = () => {
            if (currentCart.length === 0) {
                alert('Ø³Ù„Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙØ§Ø±ØºØ©!');
                return;
            }

            const totalSaleAmount = parseFloat(document.getElementById('total-amount').textContent.replace(CURRENCY, '').trim());
            const saleDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

            // 1. Deduct from inventory (Finalization)
            currentCart.forEach(item => {
                if (inventory[item.barcode]) {
                    inventory[item.barcode].stock -= item.quantity;
                    // Ensure stock doesn't go negative, although checked in addItemByBarcode
                    if (inventory[item.barcode].stock < 0) {
                        inventory[item.barcode].stock = 0;
                    }
                }
            });

            // 2. Record the sale in history
            salesHistory.push({
                id: Date.now(),
                date: saleDate,
                total: totalSaleAmount,
                items: [...currentCart] // Copy of cart items
            });

            // 3. Clear the cart and update storage
            currentCart = [];
            updateLocalStorage();
            renderCart();
            
            alert('ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­! Ø´ÙƒØ±Ø§Ù‹.');
        };
        
        // --- REPORTING FUNCTIONS ---

        // Access Reports (Security Check)
        const accessReports = () => {
            const code = document.getElementById('report-code').value;
            const reportsSection = document.getElementById('reports-section');

            if (code === REPORT_CODE) {
                reportsSection.classList.remove('hidden');
                generateReports(); 
                alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­.');
            } else {
                reportsSection.classList.add('hidden');
                alert('Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­!');
            }
            document.getElementById('report-code').value = '';
        };

        // Generate and Display Reports
        const generateReports = () => {
            let dailyProfit = 0;
            let monthlyProfit = 0;
            let yearlyProfit = 0;

            const productStats = {}; // { barcode: { salesCount, totalRevenue, totalProfit, ... } }

            const today = new Date();
            const currentDay = today.toISOString().split('T')[0];
            const currentMonth = today.toISOString().substring(0, 7); 
            const currentYear = today.getFullYear().toString();

            salesHistory.forEach(sale => {
                let saleProfit = 0;
                
                sale.items.forEach(item => {
                    const itemProfit = (item.salePrice - item.purchasePrice) * item.quantity;
                    saleProfit += itemProfit;
                    
                    // Update Product Stats
                    if (!productStats[item.barcode]) {
                        productStats[item.barcode] = {
                            name: item.name,
                            salesCount: 0,
                            totalRevenue: 0,
                            totalProfit: 0,
                            purchasePrice: item.purchasePrice,
                            salePrice: item.salePrice
                        };
                    }
                    productStats[item.barcode].salesCount += item.quantity;
                    productStats[item.barcode].totalRevenue += item.salePrice * item.quantity;
                    productStats[item.barcode].totalProfit += itemProfit;
                });

                // Update Time-based Profits
                if (sale.date === currentDay) {
                    dailyProfit += saleProfit;
                }
                if (sale.date.startsWith(currentMonth)) {
                    monthlyProfit += saleProfit;
                }
                if (sale.date.startsWith(currentYear)) {
                    yearlyProfit += saleProfit;
                }
            });

            // Display Profit Summary (IQD)
            document.getElementById('daily-profit').textContent = dailyProfit.toFixed(2) + CURRENCY;
            document.getElementById('monthly-profit').textContent = monthlyProfit.toFixed(2) + CURRENCY;
            document.getElementById('yearly-profit').textContent = yearlyProfit.toFixed(2) + CURRENCY;

            // Display Product Reports Table (IQD)
            const tableBody = document.getElementById('product-reports-table').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            
            for (const barcode in productStats) {
                const stats = productStats[barcode];
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${stats.name}</td>
                    <td>${stats.purchasePrice.toFixed(2) + CURRENCY}</td>
                    <td>${stats.salePrice.toFixed(2) + CURRENCY}</td>
                    <td>${stats.salesCount}</td>
                    <td>${stats.totalRevenue.toFixed(2) + CURRENCY}</td>
                    <td style="font-weight: bold; color: ${stats.totalProfit > 0 ? '#1abc9c' : '#e74c3c'};">${stats.totalProfit.toFixed(2) + CURRENCY}</td>
                `;
            }
        };

        // Delete Statistics
        const resetStatistics = () => {
            if (confirm('âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§ØªØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡ ÙˆØ³ÙŠÙÙ‚Ø¯ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©.')) {
                salesHistory = []; // Clear sales history
                updateLocalStorage(); 
                generateReports(); // Refresh the reports section (will show 0.00)
                alert('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­.');
            }
        };

        // Initial load: render cart, ensure inventory is stored
        document.addEventListener('DOMContentLoaded', () => {
            updateLocalStorage(); // Save initial dummy data if not present
            renderCart();
            // Optional: Attach event listener for Enter key on barcode input
            document.getElementById('barcode-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Prevent form submission
                    addItemByBarcode();
                }
            });
        });
    </script>
</body>
</html>
